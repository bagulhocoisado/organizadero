<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Contas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Outline de foco mais sutil */
*:focus {
    outline: none;
}

*:focus-visible {
    outline: 1px solid rgba(16, 163, 127, 0.4);
    outline-offset: 1px;
}

button:focus-visible,
input:focus-visible,
textarea:focus-visible,
select:focus-visible {
    outline: 1px solid rgba(16, 163, 127, 0.5);
    outline-offset: 2px;
}

/* Remover outline da barra de título */
.titlebar-button:focus,
.titlebar-button:focus-visible {
    outline: none;
}

/* Remover outline dos utilities-item */
.utilities-item:focus,
.utilities-item:focus-visible {
    outline: none !important;
}

/* Regra específica para Kameleo */
.utilities-item-danger[data-cache-btn="kameleo"],
.utilities-item-danger[data-cache-btn="kameleo"]:focus,
.utilities-item-danger[data-cache-btn="kameleo"]:focus-visible,
.utilities-item-danger[data-cache-btn="kameleo"]:hover,
.utilities-item-danger[data-cache-btn="kameleo"]:active {
    outline: none !important;
    box-shadow: none !important;
}

        /* Barra de título customizada */
.custom-titlebar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 52px;
    background: #0a0a0b;
    border-bottom: 1px solid #1f1f1f;
    z-index: 100000;
    -webkit-app-region: drag;
}

.titlebar-drag-region {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 100%;
    -webkit-app-region: drag;
    pointer-events: none;
}

.titlebar-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 100%;
    padding: 0 12px;
    gap: 20px;
}

.titlebar-left {
    display: flex;
    align-items: center;
    gap: 8px;
    -webkit-app-region: no-drag;
    flex: 1;
    pointer-events: auto;
}

.titlebar-period-container {
    display: flex;
    align-items: center;
    gap: 6px;
    -webkit-app-region: no-drag;
    position: relative;
    pointer-events: auto;
}

.titlebar-stats {
    display: flex;
    align-items: center;
    gap: 0;
    flex: 1;
    justify-content: center;
    -webkit-app-region: drag;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.titlebar-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 0 16px;
    position: relative;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -webkit-app-region: drag;
}

.titlebar-stat:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 24px;
    background: #1f1f1f;
}

.titlebar-stat-label {
    font-size: 9px;
    color: #6b7280;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.titlebar-stat-value {
    font-size: 16px;
    color: #e4e4e7;
    font-weight: 600;
}

.titlebar-stat-value.highlight {
    color: #10a37f;
}

.titlebar-right {
    display: flex;
    align-items: center;
    gap: 6px;
    -webkit-app-region: no-drag;
    pointer-events: auto;
    flex-shrink: 0;
}

.titlebar-btn {
    padding: 6px 12px;
    background: #171717;
    border: 1px solid #262626;
    border-radius: 4px;
    color: #9ca3af;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
    min-height: 28px;
}

/* Botões sutis (sem borda) */
.titlebar-btn-subtle {
    background: transparent;
    border: none;
    padding: 6px;
}

.titlebar-btn-subtle:hover {
    background: rgba(255, 255, 255, 0.05);
    border: none;
}

.titlebar-btn-subtle:disabled {
    opacity: 0.2;
}

/* Botão Ignorar Arquivados na titlebar */
.hideArchived-btn {
    transition: all 0.2s;
}

.hideArchived-btn.visible {
    opacity: 1;
}

.hideArchived-btn.active {
    opacity: 1;
    color: #10a37f !important;
}

.hideArchived-btn.active svg {
    stroke: #10a37f;
}

/* Botão do relógio na titlebar */
.titlebar-clock-btn {
    position: relative;
    padding: 8px 10px !important;
    background: rgba(16, 163, 127, 0.08) !important;
    border: 1px solid rgba(16, 163, 127, 0.2) !important;
    flex-shrink: 0;
}

.titlebar-clock-btn:hover {
    background: rgba(16, 163, 127, 0.15) !important;
    border-color: rgba(16, 163, 127, 0.4) !important;
}

.titlebar-clock-btn svg {
    width: 22px !important;
    height: 22px !important;
    stroke: #10a37f !important;
}

.titlebar-clock-badge {
    position: absolute;
    top: -2px;
    right: -2px;
    background: #ef4444;
    color: white;
    font-size: 11px;
    font-weight: 700;
    min-width: 20px;
    height: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px;
    border: 2px solid #0a0a0b;
    pointer-events: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}


.titlebar-btn span {
    pointer-events: none;
}

.titlebar-btn:hover {
    background: #1f1f1f;
    border-color: #10a37f;
    color: #ffffff;
}

.titlebar-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
}

.titlebar-btn svg {
    width: 13px;
    height: 13px;
    opacity: 0.8;
    flex-shrink: 0;
    pointer-events: none;
}

.titlebar-btn-utilities {
    padding: 7px 15px;
    font-size: 12px;
    flex-shrink: 0;
}

.titlebar-btn-utilities svg {
    width: 20px;
    height: 20px;
    pointer-events: none;
}

.titlebar-period-btn {
    position: relative;
    padding: 3px 10px;
    flex-direction: column;
    gap: 2px;
    align-items: center;
    background: transparent;
    border: none;
}

.titlebar-period-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border: none;
}

.titlebar-period-label {
    font-size: 8px;
    color: #6b7280;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    pointer-events: none;
}

.titlebar-period-value {
    font-size: 11px;
    color: #e4e4e7;
    font-weight: 500;
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 4px;
}

.titlebar-period-value svg {
    width: 8px;
    height: 8px;
    opacity: 0.7;
}

.titlebar-save-btn {
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 1;
    min-width: 60px;
}

.titlebar-separator {
    width: 1px;
    height: 24px;
    background: #262626;
    margin: 0 2px;
}

.titlebar-buttons {
    display: flex;
    gap: 0;
    -webkit-app-region: no-drag;
    pointer-events: auto;
    flex-shrink: 0;
}

.titlebar-button {
    width: 46px;
    height: 52px;
    border: none;
    background: transparent;
    color: #9ca3af;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
}

.titlebar-button svg {
    width: 12px;
    height: 12px;
}

.titlebar-button:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #e4e4e7;
}

.titlebar-button.titlebar-close:hover {
    background: #ef4444;
    color: white;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: #0f0f10;
    padding: 15px;
    padding-top: 67px;
    padding-right: 20px;
    line-height: 1.4;
    color: #e4e4e7;
}

/* Scrollbar customizada para todo o app */
::-webkit-scrollbar {
    width: 8px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: #171717;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: #262626;
    border-radius: 4px;
    transition: background 0.2s;
}

::-webkit-scrollbar-thumb:hover {
    background: #374151;
}


.container {
            max-width: 1800px;
            margin: 0 auto;
            background: #171717;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
        }

.tabs-mode .container {
    overflow: visible;
}
body.tabs-mode {
    overflow-x: hidden;
}
.header-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            padding: 20px 0 15px 0;
        }


        h1 {
            color: #e4e4e7;
            font-size: 22px;
        }

        .header-left {
            position: absolute;
            left: 0;
            display: flex;
            gap: 8px;
        }


.header-right {
    position: absolute !important;
    right: 0 !important;
    display: flex;
    gap: 8px;
    align-items: center;
    z-index: 10001;
}

.save-selector-button {
    background: #1a1a1a;
    border: 1px solid #262626;
    padding: 6px 12px;
    border-radius: 4px;
    color: #10a37f;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    font-weight: 500;
    white-space: nowrap;
    max-width: 300px;
}

.save-selector-button span {
    overflow: hidden;
    text-overflow: ellipsis;
}

.save-selector-button:hover {
    background: #1f1f1f;
    border-color: #10a37f;
}

.save-selector-button svg {
    opacity: 0.7;
    flex-shrink: 0;
}


.save-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    background: #1f1f1f;
    border: 1px solid #262626;
    border-radius: 6px;
    padding: 8px;
    min-width: 280px;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 10000;
    display: none;
    animation: slideDown 0.2s ease;
}
#savesListContainer {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 4px;
}

#savesListContainer::-webkit-scrollbar {
    width: 6px;
}

#savesListContainer::-webkit-scrollbar-track {
    background: #171717;
    border-radius: 3px;
}

#savesListContainer::-webkit-scrollbar-thumb {
    background: #262626;
    border-radius: 3px;
}

#savesListContainer::-webkit-scrollbar-thumb:hover {
    background: #374151;
}
.save-dropdown.active {
    display: block;
}

.save-dropdown-section {
    margin-bottom: 12px;
}

.save-dropdown-section:last-child {
    margin-bottom: 0;
}

.save-dropdown-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px;
    margin-bottom: 4px;
}

.save-dropdown-title {
    font-size: 10px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.btn-restore-backup {
    background: transparent;
    border: none;
    color: #10a37f;
    font-size: 10px;
    padding: 2px 6px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.2s;
}

.btn-restore-backup:hover {
    background: rgba(16, 163, 127, 0.1);
}

.save-dropdown-item {
    background: #171717;
    border: 1px solid #262626;
    padding: 10px 12px;
    border-radius: 4px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 12px;
    color: #e4e4e7;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.save-dropdown-item:last-child {
    margin-bottom: 0;
}

.save-dropdown-item:hover {
    background: #1a1a1a;
    border-color: #374151;
    transform: translateX(2px);
}

.save-dropdown-item.active {
    background: rgba(16, 163, 127, 0.1);
    border-color: #10a37f;
    box-shadow: 0 0 0 1px rgba(16, 163, 127, 0.2);
}

.save-dropdown-item.active:hover {
    background: rgba(16, 163, 127, 0.15);
    transform: translateX(0);
}

.save-dropdown-badge {
    background: #10a37f;
    color: #0f0f10;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 600;
}
/* Estilos para o menu de Utilidades */
.utilities-dropdown {
    position: fixed;
    top: 52px;
    right: 200px;
    background: #1f1f1f;
    border: 1px solid #262626;
    border-radius: 6px;
    padding: 8px;
    min-width: 340px;
    max-height: calc(100vh - 60px);
    overflow-y: auto;
    overflow-x: visible;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 10002;
    display: none;
}

.utilities-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    background: #171717;
    border: 1px solid #262626;
    padding: 12px;
    border-radius: 4px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.utilities-item:last-child {
    margin-bottom: 0;
}

.utilities-item:hover {
    background: #1a1a1a;
    transform: translateX(2px);
}

.utilities-item-warning {
    border-color: rgba(251, 191, 36, 0.3);
    background: rgba(251, 191, 36, 0.05);
}

.utilities-item-warning:hover {
    border-color: rgba(251, 191, 36, 0.5);
    background: rgba(251, 191, 36, 0.1);
}

.utilities-item-warning .utilities-item-icon svg {
    stroke: #fbbf24 !important;
}

.utilities-item-warning:hover .utilities-item-icon svg {
    stroke: #fbbf24 !important;
}

.utilities-item-warning.shake .utilities-item-icon svg {
    stroke: #fbbf24 !important;
}

.utilities-item-warning.highlighted .utilities-item-icon svg {
    stroke: #fbbf24 !important;
}

/* Força amarelo mesmo durante hover com shake */
.utilities-item-warning.shake:hover .utilities-item-icon svg {
    stroke: #fbbf24 !important;
}

.utilities-item-warning.highlighted:hover .utilities-item-icon svg {
    stroke: #fbbf24 !important;
}

.utilities-item-warning .utilities-item-title {
    color: #fbbf24;
}

.utilities-item-danger {
    border-color: rgba(239, 68, 68, 0.25);
    background: rgba(239, 68, 68, 0.05);
}

.utilities-item-danger:hover {
    border-color: rgba(239, 68, 68, 0.4);
    background: rgba(239, 68, 68, 0.08);
}

.utilities-item-danger .utilities-item-icon svg {
    stroke: #ef4444 !important;
}

.utilities-item-danger:hover .utilities-item-icon svg {
    stroke: #f87171 !important;
}

.utilities-item-danger .utilities-item-title {
    color: #ef4444;
}

.utilities-item-danger .utilities-item-desc {
    color: #9ca3af;
}

.utilities-item[data-system-btn] {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.utilities-item[data-system-btn].shake {
    animation: shake 0.5s ease-in-out infinite;
}


@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-1.5px); }
    75% { transform: translateX(1.5px); }
}

@keyframes copySuccess {
    0% {
        transform: scale(1);
        opacity: 0.6;
    }
    15% {
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 1;
    }
    85% {
        opacity: 1;
    }
    100% {
        transform: scale(1);
        opacity: 0.6;
    }
}

.copy-success {
    animation: copySuccess 0.6s ease-out;
}

.copy-success-no-scale {
    animation: copySuccessNoScale 0.6s ease-out;
}

@keyframes copySuccessNoScale {
    0% {
        opacity: 0.6;
    }
    15% {
        opacity: 1;
    }
    85% {
        opacity: 1;
    }
    100% {
        opacity: 0.6;
    }
}


.utilities-item[data-cache-btn]:hover {
    border-color: #10a37f;
}

/* Kameleo mantém cor vermelha no hover */
.utilities-item-danger[data-cache-btn="kameleo"]:hover {
    border-color: rgba(239, 68, 68, 0.4) !important;
}

.utilities-item-icon {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

/* Badge para indicar status de cache */
.cache-status-badge {
    position: absolute;
    top: -4px;
    right: -6px;
    width: 21px;
    height: 21px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    pointer-events: none;
}

.cache-status-badge.warning svg {
    width: 21px;
    height: 21px;
    stroke: #f59e0b;
    fill: none;
    stroke-width: 2;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
}

.cache-status-badge.success svg {
    width: 15px;
    height: 15px;
    right: -8px;
    stroke: #10b981;
    fill: none;
    stroke-width: 2.5;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
}

.cache-status-badge.loading {
    width: 22px;
    height: 22px;
}

.cache-status-badge.loading svg {
    width: 22px;
    height: 22px;
    stroke: #60a5fa;
    fill: none;
    animation: spin 1s linear infinite;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Garantir que os badges de status de cache não mudem de cor no hover */
.utilities-item[data-cache-btn]:hover .cache-status-badge.warning svg {
    stroke: #f59e0b !important;
}

.utilities-item[data-cache-btn]:hover .cache-status-badge.success svg {
    stroke: #10b981 !important;
}

.utilities-item[data-cache-btn]:hover .cache-status-badge.loading svg {
    stroke: #60a5fa !important;
}

/* Atualizar descrição ao hover quando há warning */
.utilities-item-desc {
    position: relative;
}

.utilities-item[data-cache-status="needs-cleaning"]:hover .utilities-item-desc {
    color: transparent;
}

.utilities-item[data-cache-status="needs-cleaning"]:hover .utilities-item-desc::before {
    content: "Uma limpeza é necessária!";
    position: absolute;
    left: 0;
    top: 0;
    font-size: 10px;
    color: #f59e0b;
    opacity: 0.85;
    font-weight: 500;
    line-height: 1.3;
}

.utilities-item[data-cache-status="clean"]:hover .utilities-item-desc {
    color: transparent;
}

.utilities-item[data-cache-status="clean"]:hover .utilities-item-desc::before {
    content: "Nenhum arquivo encontrado.";
    position: absolute;
    left: 0;
    top: 0;
    font-size: 10px;
    color: #10b981;
    opacity: 0.75;
    font-weight: 500;
    line-height: 1.3;
}


.utilities-item-icon svg {
    width: 28px;
    height: 28px;
    stroke: #6b7280;
}

.utilities-item:hover .utilities-item-icon svg {
    stroke: #9ca3af;
}

.utilities-item[data-cache-btn]:hover .utilities-item-icon svg {
    stroke: #10a37f;
}

/* Botões de sistema NÃO ficam verdes */
.utilities-item[data-system-btn]:hover .utilities-item-icon svg {
    stroke: #fbbf24;
}

.utilities-item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.utilities-item-title {
    font-size: 13px;
    font-weight: 500;
    color: #e4e4e7;
}

.utilities-item-desc {
    font-size: 11px;
    color: #6b7280;
    line-height: 1.3;
}

.utilities-mac-container {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
}

.utilities-mac-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.utilities-mac-adapter {
    font-size: 10px;
    color: #e4e4e7;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.3px;
}

.utilities-mac-address {
    font-size: 10px;
    color: #e4e4e7;
    font-family: 'Courier New', monospace;
    letter-spacing: 0.3px;
}

.utilities-mac-gear {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
    position: relative;
}

.utilities-mac-gear:hover {
    background: rgba(255, 255, 255, 0.05);
}

.utilities-mac-gear svg {
    width: 20px;
    height: 20px;
    stroke: #6b7280;
    transition: stroke 0.2s;
}

.utilities-item-guid {
    font-size: 10px;
    color: #10a37f;
    margin-top: 4px;
    font-family: 'Courier New', monospace;
}

.utilities-reset-both {
    width: 100%;
    margin-top: 8px;
    padding: 8px 12px;
    background: #1a1a1a;
    border: 1px solid #262626;
    border-radius: 4px;
    color: #9ca3af;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2px;
    transition: all 0.2s;
}

.utilities-reset-both:hover {
    background: #1f1f1f;
    border-color: #374151;
    color: #e4e4e7;
}

.utilities-reset-both svg {
    stroke: currentColor;
}

.utilities-config-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s;
    z-index: 3;
    opacity: 0.6;
}

.utilities-config-btn:hover {
    opacity: 1;
}

.utilities-config-btn svg {
    width: 18px;
    height: 18px;
    stroke: #6b7280;
    transition: stroke 0.2s;
}

.utilities-config-btn:hover svg {
    stroke: #9ca3af;
}

.config-alert-badge {
    position: absolute;
    bottom: -4px;
    right: -4px;
    width: 8px;
    height: 8px;
    background: #ef4444;
    border: 2px solid #171717;
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.utilities-toggle-btn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 52px;
    height: 28px;
    background: transparent;
    border: 1px solid #262626;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 4px 6px;
    transition: all 0.2s;
    z-index: 3;
}

.utilities-toggle-btn:hover {
    background: rgba(38, 38, 38, 0.5);
    border-color: #374151;
}

.utilities-toggle-btn.active {
    background: rgba(16, 163, 127, 0.15);
    border-color: rgba(16, 163, 127, 0.6);
}

.toggle-icons {
    display: flex;
    align-items: center;
    gap: 2px;
}

.toggle-plus {
    font-size: 10px;
    font-weight: 700;
    color: #6b7280;
    transition: all 0.2s;
    line-height: 1;
}

.utilities-toggle-btn.active .toggle-plus {
    color: #10a37f;
}

.utilities-toggle-btn:hover .toggle-plus {
    color: #9ca3af;
}

.utilities-toggle-btn.active:hover .toggle-plus {
    color: #10a37f;
}

.utilities-toggle-btn svg {
    width: 16px;
    height: 16px;
    stroke: #6b7280;
    transition: all 0.2s;
}

.utilities-toggle-btn.active svg {
    stroke: #10a37f;
}

.utilities-toggle-btn:hover svg {
    stroke: #9ca3af;
}

.utilities-toggle-btn.active:hover svg {
    stroke: #10a37f;
}

.connection-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 999;
}

.connection-lines line {
    transition: all 0.3s ease;
}

.backup-dropdown {
    position: absolute;
    top: 0;
    right: calc(100% + 4px);
    background: #1f1f1f;
    border: 1px solid #262626;
    border-radius: 6px;
    padding: 8px;
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    box-shadow: -4px 4px 20px rgba(0,0,0,0.5);
    display: none;
    z-index: 10001;
}

.backup-dropdown.active {
    display: block;
}

        .btn-configure {
            background: #1f1f1f;
            color: #9ca3af;
            border: 1px solid #262626;
        }

        .btn-configure:hover {
            background: #171717;
            color: #e4e4e7;
        }

.summary {
    background: transparent;
    padding: 16px 20px;
    border-radius: 0;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    position: relative;
    border-top: none;
    border-bottom: none;
}

.summary-period-selector {
    position: absolute;
    left: 20px;
    display: flex;
    align-items: center;
}

.summary-period-btn {
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 6px 12px;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 10px;
    color: #6b7280;
    font-weight: 400;
    background: transparent;
    border: 1px solid transparent;
}

.summary-period-btn:hover {
    border-color: rgba(38, 38, 38, 0.6);
    background: rgba(31, 31, 31, 0.3);
}

.summary-period-value {
    color: #e4e4e7;
    font-weight: 500;
    font-size: 11px;
}

.period-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background: #1a1a1a;
    border: 1px solid #262626;
    border-radius: 6px;
    padding: 4px;
    min-width: 160px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 10000;
    display: none;
}

.period-dropdown.active {
    display: block;
}

.period-item {
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
    color: #e4e4e7;
}

.period-item:hover {
    background: #262626;
}

.period-item.active {
    background: rgba(16, 163, 127, 0.15);
    color: #10a37f;
}

.summary-stats {
    display: flex;
    align-items: center;
    gap: 0;
}

.summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 24px;
    position: relative;
}

.summary-stat:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 36px;
    background: #262626;
}

.summary-label {
    font-size: 10px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    font-weight: 500;
}

.summary-value {
    font-size: 20px;
    font-weight: 600;
    color: #10a37f;
}

.hide-archived-btn {
    position: absolute;
    right: 20px;
    background: #1a1a1a;
    border: 1px solid #262626;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    display: none;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: #9ca3af;
}

.hide-archived-btn.visible {
    display: flex;
}

.hide-archived-btn:hover {
    background: #262626;
    border-color: #10a37f;
    color: #e4e4e7;
}

.hide-archived-btn.active {
    background: rgba(16, 163, 127, 0.15);
    border-color: #10a37f;
    color: #10a37f;
}

.hide-archived-btn svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
}

        .section {
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            background: #1f1f1f;
            border-left: 3px solid var(--section-color, #10a37f);
            transition: all 0.2s;
            position: relative;
        }

        .section::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 25%;
            background: linear-gradient(to right, var(--section-color, #10a37f) 0%, transparent 100%);
            opacity: 0.056;
            pointer-events: none;
            border-radius: 6px 0 0 6px;
        }

        .section-collapsed {
            padding: 8px 12px;
            background: #1a1a1a;
            border-color: #222;
        }

        .section-collapsed:hover {
            background: #1d1d1d;
        }

        .section-header {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #262626;
            align-items: end;
        }
        
        .section-collapsed .section-header {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .section-content {
            display: block;
        }

        .section-collapsed .section-content {
            display: none;
        }

.section-summary {
    display: none;
    padding: 8px 0;
    color: #9ca3af;
    font-size: 13px;
    gap: 20px;
    align-items: center;
    grid-column: 1 / -1;
    margin-top: 8px;
}

        .section-collapsed .section-summary {
            display: flex;
        }

        .section-summary-item {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .section-summary-label {
            color: #6b7280;
            font-size: 11px;
        }

        .section-summary-value {
            color: #e4e4e7;
            font-weight: 500;
        }

.section-stats {
    display: flex;
    gap: 0;
    padding: 8px 0;
    background: transparent;
    border-radius: 0;
    margin-bottom: 10px;
    font-size: 11px;
    justify-content: center;
}

.section-stat-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
    align-items: center;
    padding: 0 20px;
    position: relative;
}

.section-stat-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 30px;
    background: #262626;
}

        .section-stat-label {
            color: #6b7280;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-stat-value {
            color: #10a37f;
            font-weight: 600;
            font-size: 14px;
        }

        .date-group {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .date-group-collapsed {
            padding: 2px 8px;
            margin-bottom: 3px;
            background: transparent;
            border-color: #1f1f1f;
            transition: all 0.2s;
        }

        .date-group-collapsed:hover {
            background: #1a1a1a;
            border-color: #262626;
        }

        .date-group-collapsed:hover .date-group-header {
            opacity: 1;
        }

        .date-group-header {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #262626;
            align-items: end;
        }

        .date-group-collapsed .date-group-header {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
            align-items: center;
            gap: 4px;
            opacity: 0.6;
        }

        .date-group-content {
            display: block;
        }

        .date-group-collapsed .date-group-content {
            display: none;
        }

.date-group-summary {
    display: none;
    color: #71717a;
    font-size: 11px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
}

        .date-group-collapsed .date-group-summary {
            display: block;
        }

        .date-group-collapsed .btn-collapse {
            padding: 0px 2px;
            font-size: 9px;
            min-width: 16px;
        }

        .date-group-dates {
            display: flex;
            gap: 8px;
            flex: 1;
        }

        .date-group-dates .field-group {
            position: relative;
        }

        .date-group-dates .field-group label {
            text-align: center;
        }

        .date-group-dates .field-group input[type="date"] {
            background: transparent;
            border: none;
            text-align: center;
            cursor: pointer;
            color: #d4d4d8;
            box-shadow: none;
        }

        .date-group-dates .field-group input[type="date"]:hover {
            background: rgba(255, 255, 255, 0.02);
            border: none;
        }

        .date-group-dates .field-group input[type="date"]:focus {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(var(--section-color-rgb, 16, 163, 127), 0.25);
            box-shadow: 
                0 0 0 2px rgba(var(--section-color-rgb, 16, 163, 127), 0.08),
                0 0 12px rgba(var(--section-color-rgb, 16, 163, 127), 0.06);
        }

        /* Esconder ícone do calendário mas manter funcionalidade */
        .date-group-dates .field-group input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .date-group-actions {
            display: flex;
            gap: 6px;
        }

.date-group-collapsed .date-group-actions {
    gap: 8px;
}

.date-group-collapsed .date-group-actions .btn-action {
    padding: 4px 8px;
    font-size: 10px;
}

.date-group-collapsed .date-group-actions .btn-action svg {
    width: 11px;
    height: 11px;
}

        .date-group-collapsed .date-group-actions .btn-icon {
            padding: 1px;
        }

        .date-group-collapsed .date-group-actions .btn-icon svg {
            width: 11px;
            height: 11px;
        }
        
        .accounts-header {
            display: grid;
            grid-template-columns: 30px 1.8fr 1.35fr 130px 90px 90px 55px 75px 35px 35px;
            gap: 6px;
            margin-bottom: 4px;
            padding: 4px 0;
            font-size: 9px;
            color: #9ca3af;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            align-items: center;
        }

        .accounts-header > *:nth-child(1) { text-align: center; }
        .accounts-header > *:nth-child(2) { text-align: left; padding-left: 12px; }
        .accounts-header > *:nth-child(3) { text-align: left; padding-left: 12px; }
        .accounts-header > *:nth-child(4) { text-align: center; }
        .accounts-header > *:nth-child(5) { text-align: center; }
        .accounts-header > *:nth-child(6) { text-align: center; }
        .accounts-header > *:nth-child(7) { text-align: center; display: flex; justify-content: center; align-items: center; height: 100%; }
        .accounts-header > *:nth-child(8) { text-align: center; }
        .accounts-header > *:nth-child(9) { text-align: center; }
        .accounts-header > *:nth-child(10) { text-align: center; }

        .account-row {
            display: grid;
            grid-template-columns: 30px 1.8fr 1.35fr 130px 75px 95px 55px 75px 35px 35px;
            gap: 6px;
            margin-bottom: 6px;
            align-items: center;
            font-size: 13px;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s;
            position: relative;
            border: 1px solid transparent;
            border-left: 3px solid transparent;
        }

        .account-row.highlight-1 {
            background: transparent;
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-left: 3px solid #9333ea;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.15);
            position: relative;
        }

        .account-row.highlight-1::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #9333ea 0%, #a855f7 50%, #9333ea 100%);
            opacity: 0.8;
            pointer-events: none;
            border-radius: 3px 0 0 3px;
            box-shadow: 0 0 12px rgba(147, 51, 234, 0.4);
        }

        /* Overlay com gradiente que sempre aparece */
        .account-row.highlight-1::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            pointer-events: none;
            border-radius: 3px;
            background: linear-gradient(90deg, 
                rgba(147, 51, 234, 0.12) 0%, 
                rgba(147, 51, 234, 0.12) 50%, 
                rgba(147, 51, 234, 0.04) 75%,
                transparent 100%);
        }

        .account-row.highlight-1:hover {
            border-color: rgba(147, 51, 234, 0.45);
            box-shadow: 0 3px 12px rgba(147, 51, 234, 0.25);
        }
        
        .account-row.highlight-1:hover::after {
            background: linear-gradient(90deg, 
                rgba(147, 51, 234, 0.18) 0%, 
                rgba(147, 51, 234, 0.18) 50%,
                rgba(147, 51, 234, 0.08) 75%, 
                rgba(147, 51, 234, 0.02) 100%);
        }

        .account-row.last-interacted {
            box-shadow: 0 0 0 1px rgba(16, 163, 127, 0.5);
            background: rgba(16, 163, 127, 0.05);
        }

        /* Estilo sutil para conta com anotação aberta */
        .account-row.note-editing {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.03) 0%, transparent 100%);
            border-left-color: rgba(59, 130, 246, 0.4);
        }

        .account-row.note-editing::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(59, 130, 246, 0.5);
            opacity: 0.7;
        }

        /* Quando a conta já tem highlight E está com anotação aberta */
        .account-row.highlight-1.note-editing {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.12) 0%, rgba(147, 51, 234, 0.04) 50%, transparent 100%);
        }

        .account-row.highlight-1.note-editing::before {
            background: linear-gradient(to bottom, 
                #9333ea 0%, 
                rgba(59, 130, 246, 0.6) 30%,
                rgba(59, 130, 246, 0.6) 70%,
                #9333ea 100%);
        }


        .account-number {
            color: #6b7280;
            font-size: 11px;
            text-align: center;
            user-select: none;
            pointer-events: none;
        }

        label {
            font-size: 10px;
            color: #9ca3af;
            font-weight: 500;
            margin-bottom: 3px;
            display: block;
        }

        .input-with-copy {
            position: relative;
            width: 100%;
        }

        .input-with-copy input {
            padding-right: 32px;
        }

        .copy-btn-inline {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(23, 23, 23, 0.95);
            border: none;
            padding: 4px;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            border-radius: 3px;
        }
        
        .copy-btn-inline.copy-success,
        .copy-btn-inline.copy-success-no-scale {
            transform: translateY(-50%) !important;
        }

        .copy-btn-inline:hover {
            opacity: 1;
        }

        .copy-btn-inline svg {
            width: 14px;
            height: 14px;
            stroke: #9ca3af;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="url"],
        input[type="email"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 12.5px;
            background: rgba(0, 0, 0, 0.1);
            color: rgba(212, 212, 212, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: none;
            letter-spacing: 0.01em;
        }

input[type="text"]:hover,
input[type="number"]:hover,
input[type="date"]:hover,
input[type="url"]:hover,
input[type="email"]:hover {
    border-color: rgba(255, 255, 255, 0.06);
    background: rgba(0, 0, 0, 0.25);
}

input[type="text"]:focus,
input[type="number"]:focus,
input[type="date"]:focus,
input[type="url"]:focus,
input[type="email"]:focus {
    outline: none;
    background: rgba(0, 0, 0, 0.35);
    color: #d4d4d8;
}




        .status-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background: #222222;
            border: 1.5px solid rgba(255, 255, 255, 0.08);
            border-radius: 5px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .status-checkbox:hover {
            border-color: rgba(255, 255, 255, 0.14);
            background: #252525;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .status-checkbox.checked {
            background: rgba(16, 163, 127, 0.15);
            border-color: rgba(16, 163, 127, 0.4);
            box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.2),
                inset 0 0 0 1px rgba(16, 163, 127, 0.2);
        }

        .status-checkbox.checked::after {
            content: '✓';
            color: #10a37f;
            font-size: 13px;
            font-weight: bold;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-checkbox.failed {
            background: rgba(239, 68, 68, 0.12);
            border-color: rgba(239, 68, 68, 0.35);
            box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.2),
                inset 0 0 0 1px rgba(239, 68, 68, 0.15);
        }

        .status-checkbox.failed::after {
            content: 'X';
            color: #ef4444;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button {
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            padding: 6px 10px;
        }

        .btn-primary {
            background: #262626;
            color: #e4e4e7;
            display: flex;
            align-items: center;
            gap: 6px;
            border: none;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #4b5563;
        }

        .btn-primary svg {
            width: 14px;
            height: 14px;
        }

        .btn-secondary {
            background: #262626;
            color: #9ca3af;
            border: none;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #4b5563;
            color: #e4e4e7;
        }

        .btn-icon {
            background: transparent;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            opacity: 1;
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

        .btn-delete svg {
            stroke: #ef4444;
        }

        .btn-delete:hover svg {
            stroke: #dc2626;
        }

        .btn-note {
            position: relative;
        }

        .btn-note svg {
            stroke: #9ca3af;
            transition: all 0.2s ease;
        }

        .btn-note:hover svg {
            stroke: #d4d4d8;
        }

        .btn-note.has-note svg {
            stroke: #10a37f;
            fill: rgba(16, 163, 127, 0.15);
        }

        .btn-note.has-note:hover svg {
            stroke: #0d9270;
        }

        .note-editor-popup {
            position: absolute;
            border-radius: 6px;
            padding: 0;
            min-width: 320px;
            max-width: 450px;
            z-index: 100001;
            display: none;
            opacity: 0;
            transform: scale(0.95) translateY(-8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
            background: linear-gradient(135deg, #1a1a1d 0%, #16161a 100%);
            border: 1px solid #2a2a2f;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .note-editor-popup.active {
            display: block;
            animation: notePopupIn 0.2s ease forwards;
            pointer-events: auto;
        }

        @keyframes notePopupIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-8px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .note-editor-textarea {
            width: 100%;
            min-height: 100px;
            max-height: 320px;
            background: transparent;
            border: none;
            color: #e5e5e7;
            padding: 14px 16px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            line-height: 1.7;
            resize: none;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .note-editor-textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.02);
        }

        .note-editor-textarea::placeholder {
            color: #6b7280;
            font-style: italic;
            opacity: 0.6;
        }

        .note-editor-textarea::-webkit-scrollbar {
            width: 6px;
        }

        .note-editor-textarea::-webkit-scrollbar-track {
            background: transparent;
            margin: 4px 0;
        }

        .note-editor-textarea::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .note-editor-textarea::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.15);
        }


        .btn-collapse {
            background: transparent;
            padding: 4px 6px;
            color: #a1a1aa;
            align-self: center;
            transition: all 0.2s ease;
        }

        .btn-collapse:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #d4d4d8;
        }

        .btn-add {
            background: rgba(255, 255, 255, 0.08);
            color: #d4d4d8;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.25s ease;
        }

        .btn-add:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .btn-add svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
        }

        .btn-action {
            background: rgba(26, 26, 26, 0.9);
            color: #a8a29e;
            padding: 5px 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .btn-action:hover {
            background: #2a2a2a;
            color: #e5e5e5;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .btn-action svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
        }

        .section-settings-btn {
            background: transparent;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .section-settings-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .section-settings-btn svg {
            width: 22px;
            height: 22px;
            stroke: #9ca3af;
            transition: all 0.3s;
        }

        .section-settings-btn:hover svg {
            stroke: #ffffff;
            transform: rotate(90deg);
        }

        /* Botão bolinha de cor */
        .section-color-btn {
            width: 48px;
            height: 24px;
            border-radius: 20%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin-top: 8px;
            top: -6px;
        }
        
        .section-color-btn:hover {
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        /* Painel de seleção de cor */
        .section-color-panel {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            min-width: 260px;
            max-width: 280px;
            display: none;
            flex-direction: column;
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.15s ease, transform 0.15s ease;
            left: 0;
            margin-top: 5px;
        }

        .section-color-panel.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

.section-color-panel-header {
    padding: 10px 14px;
    border-bottom: 1px solid #2a2a2a;
    font-size: 11px;
    font-weight: 600;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: #171717;
    border-radius: 6px 6px 0 0;
    display: flex;
    justify-content: center;
    align-items: center;
}

        .section-color-panel-content {
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Configurações inline no header */
        .section-inline-configs {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            flex-wrap: nowrap;
        }
        
        .section-config-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 0 0 auto;
            align-items: center;
        }
        
        .section-config-item label {
            font-size: 9px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            white-space: nowrap;
            width: 100%;
        }
        
        .section-config-item input,
        .section-config-item > div {
            height: 35px;
            padding: 4px 6px;
            font-size: 11px;
            text-align: center;
        }
        
        .section-config-item input[type="number"] {
            text-align: center;
        }
.field-group input[type="number"] {
    text-align: center;
}
        
        /* Campos clicáveis especiais (DESATIVADO, GLOBAL, etc) */
        .section-config-item > div {
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
        }
        
        .section-config-item > div:hover {
            background: rgba(255, 255, 255, 0.05);
            border: none;
        }
        
        /* Botão DESATIVADO sem borda/hover e com bordas arredondadas */
        .config-disabled-btn {
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none !important;
            color: #ef4444;
            height: 35px;
            padding: 4px 6px;
            font-size: 11px;
            text-align: center;
        }
        
        .config-disabled-btn:hover {
            background: transparent !important;
            border: none !important;
        }
        
        /* Botão GLOBAL sem background preto */
        .config-global-btn {
            cursor: pointer;
            border-radius: 6px;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none !important;
            color: rgba(16, 163, 127, 0.7);
            height: 35px;
            padding: 4px 6px;
            font-size: 11px;
            text-align: center;
            width: 110px;
        }
        
        .config-global-btn:hover {
            background: transparent !important;
            border: none !important;
        }
        
        /* Divisórias sutis */
        .section-divider {
            color: #262626;
            font-size: 18px;
            font-weight: 300;
            display: flex;
            align-items: center;
            margin: 0 8px;
            user-select: none;
        }

        /* Remove estilos antigos não usados */
        .section-settings-item {
            display: none;
        }


        .copy-buttons-container {
            display: flex;
            align-items: center;
            gap: 0;
            background: rgba(26, 26, 26, 0.4);
            border-radius: 6px;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }
        
        .btn-action-noborder {
            border: none !important;
            padding: 8px 12px;
            background: transparent !important;
            transition: all 0.2s ease;
            position: relative;
            color: #a8a29e;
        }
        
        .btn-action-noborder:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 60%;
            background: rgba(255, 255, 255, 0.08);
        }

        .btn-action-noborder::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.06);
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 0;
        }
        
        .btn-action-noborder:first-child::before {
            border-radius: 6px 0 0 6px;
        }
        
        .btn-action-noborder:last-child::before {
            border-radius: 0 6px 6px 0;
        }

        .btn-action-noborder:hover::before {
            opacity: 1;
        }

        .btn-action-noborder:hover {
            background: transparent !important;
            color: #e5e5e5;
        }
        
        .copy-btn-separator {
            display: none;
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .field-group {
            display: flex;
            flex-direction: column;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .counter-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-counter {
            background: #1a1a1a;
            color: #9ca3af;
            padding: 2px 8px;
            font-size: 14px;
            font-weight: bold;
            min-width: 24px;
        }

        .btn-counter:hover {
            background: #262626;
            color: #cbd5e1;
        }

        .counter-value {
            background: #171717;
            color: #e4e4e7;
            padding: 2px 6px;
            border: 1px solid #262626;
            border-radius: 3px;
            min-width: 28px;
            text-align: center;
            font-size: 12px;
        }

        .counter-disabled {
            color: #7f1d1d;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
        }

        input[type="date"] {
            min-width: 150px;
            color-scheme: dark;
            cursor: text;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }

        input[type="date"]::-webkit-datetime-edit-fields-wrapper {
            padding: 0;
        }

        input[type="date"]::-webkit-datetime-edit-text,
        input[type="date"]::-webkit-datetime-edit-month-field,
        input[type="date"]::-webkit-datetime-edit-day-field,
        input[type="date"]::-webkit-datetime-edit-year-field {
            color: #e4e4e7;
        }

        .date-readonly {
            border-color: transparent !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0;
            height: auto;
            line-height: 1.4;
            margin-top: 0px;
            opacity: 0.75;
            cursor: default;
        }

        .date-readonly:focus {
            outline: none;
            box-shadow: none;
        }

        .date-readonly::-webkit-calendar-picker-indicator {
            display: none;
        }

        .field-center {
            align-items: flex-end;
        }

        .field-center label {
            text-align: center;
            margin-bottom: 3px;
        }

        .date-center {
            text-align: center;
        }

        .color-picker-container {
            position: relative;
        }

        .color-preview {
            width: 24px;
            height: 34px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .color-preview:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .color-picker {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: #242424;
            border: 1.5px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            display: none;
            z-index: 1000;
            box-shadow: 
                0 4px 20px rgba(0,0,0,0.5),
                0 1px 3px rgba(0,0,0,0.3);
            min-width: 250px;
        }

        .color-picker.active {
            display: block;
        }

        .color-slider-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

.color-slider {
    width: 100%;
    height: 30px;
    border-radius: 6px;
    background: linear-gradient(to right, 
        #52525b 0%, #71717a 5%, #a1a1aa 10%, #3f3f46 15%,
        #ef4444 20%, #f97316 25%, #f59e0b 30%, #fbbf24 35%, 
        #84cc16 40%, #10b981 45%, #14b8a6 50%, #06b6d4 55%, 
        #3b82f6 60%, #6366f1 65%, #8b5cf6 70%, #a855f7 75%, 
        #d946ef 80%, #ec4899 85%, #f43f5e 90%);
    cursor: pointer;
    position: relative;
    border: 1px solid #262626;
}

.color-slider-rainbow {
    width: 100%;
    height: 30px;
    border-radius: 6px;
    background: linear-gradient(to right, 
        #52525b 0%, #71717a 5%, #a1a1aa 10%, #3f3f46 15%,
        #ef4444 20%, #f97316 25%, #f59e0b 30%, #fbbf24 35%, 
        #84cc16 40%, #10b981 45%, #14b8a6 50%, #06b6d4 55%, 
        #3b82f6 60%, #6366f1 65%, #8b5cf6 70%, #a855f7 75%, 
        #d946ef 80%, #ec4899 85%, #f43f5e 90%);
    cursor: pointer;
    position: relative;
    border: 1px solid #262626;
}

        .color-slider-indicator {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        .color-preview-large {
            width: 100%;
            height: 40px;
            border-radius: 4px;
            border: 1px solid #262626;
        }

        .section-footer {
            margin-top: 6px;
            padding-top: 0;
            display: flex;
            justify-content: flex-end;
        }

        .btn-add-date-group {
            background: #262626;
            color: #e4e4e7;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 5px 10px;
        }

        .btn-add-date-group:hover {
            background: #4b5563;
        }

        .btn-add-date-group svg {
            width: 11px;
            height: 11px;
            stroke: currentColor;
        }

        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .custom-modal-overlay.active {
            display: flex;
        }

        .custom-modal {
            background: #1f1f1f;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 24px;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .custom-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #e4e4e7;
            margin-bottom: 12px;
        }

        .custom-modal-message {
            font-size: 14px;
            color: #a1a1aa;
            margin-bottom: 20px;
            line-height: 1.5;
            white-space: pre-line;
        }

        .custom-modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .custom-modal-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .custom-modal-btn-cancel {
            background: #262626;
            color: #a1a1aa;
        }

        .custom-modal-btn-cancel:hover {
            background: #2a2a2a;
            color: #e4e4e7;
        }

        .custom-modal-btn-confirm {
            background: #ef4444;
            color: #fff;
        }

        .custom-modal-btn-confirm:hover {
            background: #dc2626;
        }

        .custom-modal-btn-ok {
            background: #10a37f;
            color: #fff;
        }

        .custom-modal-btn-ok:hover {
            background: #0d8a6a;
        }
        
        /* Update Debug Panel */
        .update-debug-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100001;
            backdrop-filter: blur(2px);
        }

        .update-debug-overlay.active {
            display: flex;
        }

        .update-debug-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 24px;
            width: 600px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.7);
        }

        .update-debug-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2a2a2a;
        }

        .update-debug-title {
            font-size: 18px;
            font-weight: 600;
            color: #e4e4e7;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-debug-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #262626;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            cursor: pointer;
            color: #71717a;
            font-size: 18px;
            transition: all 0.2s;
        }

        .update-debug-close:hover {
            background: #2a2a2a;
            color: #e4e4e7;
        }

        .update-debug-section {
            margin-bottom: 20px;
        }

        .update-debug-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .update-debug-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .update-debug-info-item {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 12px;
        }

        .update-debug-info-label {
            font-size: 11px;
            font-weight: 500;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .update-debug-info-value {
            font-size: 14px;
            font-weight: 500;
            color: #e4e4e7;
            font-family: 'Courier New', monospace;
        }

        .update-debug-info-value.loading {
            color: #71717a;
            font-style: italic;
        }

        .update-debug-info-value.error {
            color: #ef4444;
        }

        .update-debug-info-value.success {
            color: #10a37f;
        }

        .update-debug-status {
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .update-debug-status-text {
            font-size: 13px;
            color: #a1a1aa;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .update-debug-progress {
            background: #262626;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .update-debug-progress-bar {
            background: linear-gradient(90deg, #10a37f 0%, #0d8a6a 100%);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .update-debug-progress-text {
            font-size: 11px;
            color: #71717a;
            text-align: center;
            font-family: 'Courier New', monospace;
        }

        .update-debug-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .update-debug-btn {
            flex: 1;
            min-width: 180px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #262626;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .update-debug-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .update-debug-btn-primary {
            background: #10a37f;
            color: #fff;
            border-color: #10a37f;
        }

        .update-debug-btn-primary:hover:not(:disabled) {
            background: #0d8a6a;
        }

        .update-debug-btn-secondary {
            background: #262626;
            color: #e4e4e7;
        }

        .update-debug-btn-secondary:hover:not(:disabled) {
            background: #2a2a2a;
        }

        .update-debug-btn-danger {
            background: #ef4444;
            color: #fff;
            border-color: #ef4444;
        }

        .update-debug-btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .update-debug-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #171717;
            border: 1px solid #262626;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .update-debug-toggle-label {
            font-size: 13px;
            color: #e4e4e7;
            font-weight: 500;
        }

        .update-debug-toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #262626;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .update-debug-toggle-switch.active {
            background: #10a37f;
        }

        .update-debug-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .update-debug-toggle-switch.active .update-debug-toggle-slider {
            transform: translateX(24px);
        }

        .update-debug-log {
            background: #0a0a0b;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .update-debug-log-entry {
            color: #71717a;
            padding: 4px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .update-debug-log-entry:last-child {
            border-bottom: none;
        }

        .update-debug-log-entry.info {
            color: #60a5fa;
        }

        .update-debug-log-entry.success {
            color: #10a37f;
        }

        .update-debug-log-entry.error {
            color: #ef4444;
        }

        .update-debug-log-entry.warning {
            color: #f59e0b;
        }
        
        /* Input no modal */
        .custom-modal-input {
            width: 100%;
            padding: 8px 12px;
            background: #171717;
            border: 1px solid #262626;
            border-radius: 4px;
            color: #e4e4e7;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .custom-modal-input:focus {
            outline: none;
            border-color: #10a37f;
        }
        
        .returns-panel {
            position: fixed;
            top: 52px;
            right: 0;
            width: 500px;
            height: calc(100vh - 52px);
            background: linear-gradient(to bottom, #1a1a1a 0%, #171717 100%);
            border-left: 1px solid #262626;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            z-index: 20000;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .returns-panel.active {
            display: flex;
        }

        .returns-panel-header {
            background: linear-gradient(to bottom, #1f1f1f 0%, #1a1a1a 100%);
            padding: 18px 22px;
            border-bottom: 1px solid #262626;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .returns-settings-btn {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .returns-settings-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .returns-settings-btn svg {
            width: 20px;
            height: 20px;
            stroke: #9ca3af;
            transition: all 0.3s;
        }

        .returns-settings-btn:hover svg {
            stroke: #10a37f;
            transform: rotate(90deg);
        }

        .returns-filters {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                        opacity 0.3s ease,
                        margin-top 0.4s ease;
            margin-top: 0;
        }

        .returns-filters.active {
            max-height: 500px;
            opacity: 1;
            margin-top: 16px;
        }

        .returns-header-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 16px;
            gap: 4px;
            position: relative;
        }

        .returns-panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #e4e4e7;
            text-align: center;
        }

        .returns-panel-date {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
        }

        .returns-filters {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .returns-filter-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #9ca3af;
        }

        .returns-filter-table {
            display: grid;
            grid-template-columns: auto auto;
            gap: 10px 20px;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 14px 18px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
        }

        .returns-filter-header {
            font-size: 9.5px;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .returns-filter-label {
            font-size: 11px;
            color: #a1a1aa;
            text-align: left;
            white-space: nowrap;
            font-weight: 500;
            letter-spacing: 0.01em;
        }


        .returns-filter-input-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: flex-start;
        }

        .returns-filter-input {
            width: 95px;
            padding: 6px 12px;
            font-size: 11.5px;
            text-align: center;
            background: #242424;
            border: 1.5px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            color: #e4e4e7;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 1px 2px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
            letter-spacing: 0.02em;
            font-weight: 500;
        }

        .returns-filter-input:hover {
            border-color: rgba(255, 255, 255, 0.14);
            background: #272727;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.04);
        }

        .returns-filter-input:focus {
            outline: none;
            border-color: rgba(16, 163, 127, 0.5);
            background: #2a2a2a;
            cursor: text;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 0 0 3px rgba(16, 163, 127, 0.1),
                0 0 16px rgba(16, 163, 127, 0.08);
        }

        .override-section {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02);
        }

        .override-header {
            padding: 0;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .override-toggle-btn {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #a1a1aa;
            font-size: 11px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s ease;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .override-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.03);
            color: #d4d4d8;
        }

        .override-enable-btn {
            padding: 6px 14px;
            margin: 8px 12px 8px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            color: #71717a;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .override-enable-btn:hover {
            background: rgba(0, 0, 0, 0.35);
            border-color: rgba(255, 255, 255, 0.12);
            color: #a1a1aa;
        }

        .override-enable-btn.active {
            background: rgba(16, 163, 127, 0.12);
            border-color: rgba(16, 163, 127, 0.3);
            color: #10a37f;
            box-shadow: 
                inset 0 1px 2px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(16, 163, 127, 0.1),
                0 0 8px rgba(16, 163, 127, 0.08);
        }

        .override-enable-btn.active:hover {
            background: rgba(16, 163, 127, 0.18);
            border-color: rgba(16, 163, 127, 0.4);
        }

        .override-toggle-btn svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            transition: transform 0.2s;
        }

        .override-toggle-btn.active svg {
            transform: rotate(180deg);
        }

        .override-config {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .override-config.active {
            max-height: 300px;
        }

        .override-explanation {
            padding: 14px 18px;
            font-size: 10px;
            color: #71717a;
            background: rgba(0, 0, 0, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.03);
            line-height: 1.6;
            letter-spacing: 0.01em;
        }

        .override-settings {
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.01);
        }

        .override-setting-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #a1a1aa;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .override-setting-row label {
            white-space: nowrap;
            font-weight: 400;
        }

        .override-setting-row .returns-filter-input {
            width: 85px;
        }

        .returns-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .returns-section {
            margin-bottom: 20px;
        }

        .returns-simple-url {
            font-size: 12px;
            color: var(--section-color, #10a37f);
            margin-bottom: 2px;
            padding: 12px 14px;
            background: color-mix(in srgb, var(--section-color, #10a37f) 1%, transparent);
            border-radius: 6px 6px 0 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid #262626;
            border-bottom: 2px solid var(--section-color, #10a37f);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .returns-url-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 0;
            overflow: hidden;
        }
        
        .returns-days-remaining {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            width: 100%;
            padding: 4px 8px;
        }

        .returns-accounts-remaining {
            text-align: left;
        }
        
        .returns-days-remaining.critical {
            color: #ff4444;
        }
        
        .returns-days-remaining.urgent {
            color: #ffa64d;
        }
        
        .returns-days-remaining.warning {
            color: #ffeb3b;
        }
        
        .returns-url-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            width: 100%;
            min-width: 0;
            overflow: hidden;
        }
        
        .returns-url-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 6px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .returns-simple-url:hover {
            background: color-mix(in srgb, var(--section-color, #10a37f) 3%, transparent);
        }

        .returns-simple-url-text {
            font-size: 12px;
            color: var(--section-color);
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            opacity: 1;
            flex-shrink: 1;
            min-width: 0;
            filter: brightness(1.3) saturate(1.2);
            font-weight: 500;
        }

        .returns-simple-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            padding: 10px 14px;
            border-left: 1px solid #262626;
            border-right: 1px solid #262626;
            border-bottom: 1px solid rgba(38, 38, 38, 0.3);
            transition: all 0.2s;
            background: #171717;
            position: relative;
        }

        .returns-simple-item:last-child {
            border-bottom: 1px solid #262626;
            border-radius: 0 0 6px 6px;
        }

        .returns-simple-section {
            margin-bottom: 20px;
        }

        .returns-url-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .returns-days-remaining {
            font-size: 11px;
            color: #6b7280;
            padding: 3px 8px;
            border-radius: 3px;
            white-space: nowrap;
        }

        .returns-days-remaining.warning {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .returns-days-remaining.urgent {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .returns-simple-item:hover {
            background: rgba(31, 31, 31, 0.5);
        }

        .returns-simple-item.highlighted {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.10) 0%, rgba(147, 51, 234, 0.03) 100%);
            border-left: 3px solid #9333ea;
            box-shadow: inset 0 1px 0 rgba(147, 51, 234, 0.08);
            position: relative;
        }

        .returns-simple-item.highlighted::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #9333ea 0%, #a855f7 50%, #9333ea 100%);
            opacity: 0.8;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(147, 51, 234, 0.3);
        }

        .returns-simple-item.highlighted::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30%;
            background: linear-gradient(to left, rgba(147, 51, 234, 0.06) 0%, transparent 100%);
            opacity: 0.6;
            pointer-events: none;
        }

        .returns-simple-item.highlighted:hover {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.15) 0%, rgba(147, 51, 234, 0.06) 100%);
            box-shadow: inset 0 1px 0 rgba(147, 51, 234, 0.12);
        }

.returns-simple-item.returned-today {
            border-left-width: 3px;
            border-left-color: var(--section-color, #10a37f);
            background: rgba(var(--section-color-rgb, 16, 163, 127), 0.03);
        }

        .returned-today-section {
            margin-bottom: 20px;
            background: #1a1a1a;
            border: 1px solid #262626;
            border-radius: 6px;
            overflow: hidden;
        }

        .returned-today-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #1f1f1f;
            border-bottom: 1px solid #262626;
            cursor: pointer;
            transition: all 0.2s;
        }

        .returned-today-header:hover {
            background: #242424;
        }

        .returned-today-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #e4e4e7;
        }

        .returned-today-badge {
            background: rgba(16, 163, 127, 0.15);
            color: #10a37f;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(16, 163, 127, 0.3);
        }

        .returned-today-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #9ca3af;
            font-size: 11px;
        }

        .returned-today-toggle svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
            transition: transform 0.2s;
        }

        .returned-today-header.collapsed .returned-today-toggle svg {
            transform: rotate(-90deg);
        }

        .returned-today-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .returned-today-content.collapsed {
            max-height: 0;
        }

        .returned-today-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(38, 38, 38, 0.3);
            background: #171717;
            transition: background 0.2s;
        }

        .returned-today-item:last-child {
            border-bottom: none;
        }

        .returned-today-item:hover {
            background: #1d1d1d;
        }

        .returned-today-item.highlighted {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.10) 0%, rgba(147, 51, 234, 0.03) 100%);
            border-left: 3px solid #9333ea;
            padding-left: 13px;
            box-shadow: inset 0 1px 0 rgba(147, 51, 234, 0.08);
            position: relative;
        }

        .returned-today-item.highlighted::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #9333ea 0%, #a855f7 50%, #9333ea 100%);
            opacity: 0.8;
            pointer-events: none;
            box-shadow: 0 0 8px rgba(147, 51, 234, 0.3);
        }

        .returned-today-item.highlighted::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30%;
            background: linear-gradient(to left, rgba(147, 51, 234, 0.06) 0%, transparent 100%);
            opacity: 0.6;
            pointer-events: none;
        }

        .returned-today-item.highlighted:hover {
            background: linear-gradient(90deg, rgba(147, 51, 234, 0.15) 0%, rgba(147, 51, 234, 0.06) 100%);
            box-shadow: inset 0 1px 0 rgba(147, 51, 234, 0.12);
        }

        .returned-today-field {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #e4e4e7;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            position: relative;
        }

        .returned-today-field::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(38, 38, 38, 0.8) 0%, rgba(38, 38, 38, 0.4) 60%, transparent 100%);
            opacity: 0;
            transition: opacity 0.25s ease;
            border-radius: 4px;
            pointer-events: none;
        }

        .returned-today-field:hover::before {
            opacity: 1;
        }

        .returned-today-field-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            z-index: 1;
        }

        .returns-copy-icon {
            position: relative;
            z-index: 1;
        }

        .returned-today-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .returns-simple-field {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #e4e4e7;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .returns-simple-field::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(38, 38, 38, 0.8) 0%, rgba(38, 38, 38, 0.4) 60%, transparent 100%);
            opacity: 0;
            transition: opacity 0.25s ease;
            border-radius: 4px;
            pointer-events: none;
        }

        .returns-simple-field:hover::before {
            opacity: 1;
        }

        .returns-simple-field-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            z-index: 1;
        }

        .returns-simple-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .returns-copy-icon {
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .returns-copy-icon:hover {
            opacity: 1;
        }

        .returns-copy-icon svg {
            width: 14px;
            height: 14px;
            stroke: #9ca3af;
        }

        .returns-empty {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .returns-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .returns-empty-text {
            font-size: 14px;
        }

        .btn-close-panel {
            background: transparent;
            border: none;
            padding: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            position: absolute;
            top: 0;
            right: 0;
        }

        .btn-close-panel:hover {
            opacity: 1;
        }

        .btn-close-panel svg {
            width: 18px;
            height: 18px;
            stroke: #9ca3af;
        }

.tabs-header {
    display: flex;
    align-items: center;
    background: linear-gradient(to bottom, #1f1f1f 0%, #1f1f1f 85%, rgba(31, 31, 31, 0.95) 100%);
    border-bottom: none;
    padding: 4px 8px;
    gap: 4px;
    overflow-x: auto;
    overflow-y: hidden;
    margin-bottom: 15px;
    z-index: 9999;
    position: sticky;
    top: 52px;
    backdrop-filter: blur(8px);
    scroll-behavior: smooth;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    margin-left: -20px;
    margin-right: -20px;
    padding-left: 20px;
    padding-right: 20px;
}

.tabs-header.fixed {
    position: fixed !important;
    top: 52px !important;
    left: 0 !important;
    right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: calc(50vw - 900px + 20px) !important;
    padding-right: calc(50vw - 900px + 20px) !important;
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}



        .tabs-header::-webkit-scrollbar {
            height: 6px;
        }

        .tabs-header::-webkit-scrollbar-track {
            background: #171717;
        }

        .tabs-header::-webkit-scrollbar-thumb {
            background: #262626;
            border-radius: 3px;
        }

.tab {
    background: #171717;
    border: 1px solid #262626;
    padding: 8px 14px;
    cursor: grab;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 100px;
    max-width: 234px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 12px;
    color: #9ca3af;
    flex-shrink: 0;
    position: relative;
    transition: all 0.2s, opacity 0.3s;
}

.tab::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--section-color);
    border-radius: 3px 3px 0 0;
    opacity: 0.15;
    transition: opacity 0.2s;
}

        .tab:hover {
            background: #1a1a1a;
            color: #e4e4e7;
        }

        .tab:hover::after {
            opacity: 0.3;
        }

        .tab.active {
            background: #262626;
            color: #e4e4e7;
            border-bottom-color: #171717;
        }

.tab.active-section {
            background: #252525 !important;
            border-color: #262626 !important;
            position: relative;
        }

.tab.active-section::after {
            opacity: 1;
            box-shadow: 0 0 12px rgba(var(--section-color-rgb), 0.6);
        }
        
        /* Não mostrar linha para abas que vêm da pasta */
        .tab-from-folder.active-section::after {
            display: none;
        }

        .tab.dragging {
            opacity: 0.8;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.4);
            border: 1px solid #10a37f;
            transform: scale(1.02);
        }

        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            color: #e4e4e7;
        }


        .tab:hover .tab-move {
            opacity: 0.6;
        }

        .tab-move:hover {
            opacity: 1 !important;
        }

        .tab-move svg {
            width: 14px;
            height: 14px;
            stroke: currentColor;
        }

        .tab-close svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
        }
        
        /* 5. Bolinha de cor na tab que muda para ícone de pasta no hover */
        .tab-color {
            width: 7px;
            height: 7px;
            border-radius: 66%;
            background: var(--section-color);
            flex-shrink: 0;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-color svg {
            width: 14px;
            height: 14px;
            opacity: 0;
            transition: opacity 0.2s;
            position: absolute;
            stroke: #f97316;
        }
        
        .tab:hover .tab-color {
            background: rgba(249, 115, 22, 0.15);
        }
        
        .tab:hover .tab-color svg {
            opacity: 0.7;
        }
        
        .tab-archive-btn.show-on-hover {
            opacity: 0;
        }
        
        .tab:hover .tab-archive-btn.show-on-hover {
            opacity: 1;
        }
        
        /* 8. X de fechar visível apenas no hover */
        .tab-close {
            opacity: 0;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab:hover .tab-close {
            opacity: 0.5;
        }

        .tab-close:hover {
            opacity: 1 !important;
            background: rgba(239, 68, 68, 0.15);
        }

/* Aba que está arquivada mas é a ativa atual */
.tab-from-folder {
    background: linear-gradient(135deg, 
        rgba(var(--section-color-rgb), 0.08) 0%, 
        rgba(var(--section-color-rgb), 0.03) 100%),
        linear-gradient(135deg, #1a1a1a 0%, #171717 100%) !important;
    border: 1px solid rgba(var(--section-color-rgb), 0.25) !important;
    position: relative;
    animation: none;
    transform: scale(0.82);
    margin-left: -12px;
    margin-top: 0;
    z-index: 3;
}

.tab-from-folder.animating {
    animation: slideFromFolder 0.35s ease-out;
}

.tab-from-folder::before {
    content: '';
    position: absolute;
    top: -1px;
    left: -1px;
    right: -1px;
    bottom: -1px;
    background: linear-gradient(135deg, 
        rgba(var(--section-color-rgb), 0.12), 
        rgba(var(--section-color-rgb), 0.05));
    border-radius: 4px 4px 0 0;
    z-index: -1;
}

.tab-from-folder .tab-folder-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    background: rgba(var(--section-color-rgb), 0.2);
    border-radius: 3px;
    flex-shrink: 0;
    margin-right: 4px;
    box-shadow: 0 0 8px rgba(var(--section-color-rgb), 0.3);
}

.tab-from-folder .tab-folder-badge svg {
    width: 9px;
    height: 9px;
    stroke: var(--section-color);
    opacity: 0.9;
    filter: drop-shadow(0 0 2px rgba(var(--section-color-rgb), 0.5));
}

@keyframes slideFromFolder {
    0% {
        opacity: 0;
        transform: scale(0.4) translateX(-50px);
    }
    100% {
        opacity: 1;
        transform: scale(0.82) translateX(0);
    }
}

.tab-from-folder:hover {
    border-color: rgba(var(--section-color-rgb), 0.4) !important;
    background: linear-gradient(135deg, 
        rgba(var(--section-color-rgb), 0.12) 0%, 
        rgba(var(--section-color-rgb), 0.06) 100%),
        linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%) !important;
    transform: scale(0.85);
}

.tab-from-folder .tab-close {
    opacity: 0.4;
}

.tab-from-folder:hover .tab-close {
    opacity: 0.7;
}

.tab-from-folder .tab-color {
        display: none;
}

/* Ajustar o botão da pasta quando há aba saindo */
.tab-folder-btn.has-active-inside {
    box-shadow: 
        0 2px 12px rgba(0, 0, 0, 0.15),
        0 0 16px rgba(0, 0, 0, 0.15),
        8px 0 12px rgba(0, 0, 0, 0.3),
        4px 0 8px rgba(0, 0, 0, 0.2);
    position: relative;
    z-index: 10;
}

.tab-from-folder-spacer {
    width: 1px;
    height: 28px;
    background: linear-gradient(to bottom, transparent, #262626 20%, #262626 80%, transparent);
    flex-shrink: 0;
    margin: 0 12px;
    align-self: center;
}

.tab-folder-btn {
    background: #1a1a1a;
    border: 1px solid #262626;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    border-radius: 4px;
    position: relative;
}

.tab-folder-btn:hover {
    background: #262626;
    border-color: #f97316;
}

.tab-folder-btn svg {
    width: 16px;
    height: 16px;
    stroke: #f97316;
}

.tab-folder-btn:hover svg {
    stroke: #ea580c;
}

.tab-folder-btn.has-active-inside svg {
    stroke: var(--active-folder-color);
    filter: drop-shadow(0 0 4px var(--active-folder-glow));
}

.folder-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    background: #1f1f1f;
    border: 1px solid #262626;
    border-radius: 6px;
    padding: 8px;
    min-width: 320px;
    max-height: 400px;
    overflow-y: auto;
    overscroll-behavior: contain;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    z-index: 10002;
    display: none;
    transition: none;
    animation: slideDown 0.2s ease;
}
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.folder-dropdown.active {
    display: block;
}

.folder-dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #171717;
    border: 1px solid #262626;
    margin-bottom: 6px;
}

.folder-dropdown-item:hover {
    background: #1a1a1a;
    border-color: #374151;
    transform: translateX(3px);
}

.folder-dropdown-item.active-section {
    background: rgba(var(--section-color, 136, 136, 136), 0.3) !important;
    border-left: 3px solid var(--section-color, #888888);
    padding-left: 7px;
}

.folder-item-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    flex-shrink: 0;
}

.folder-item-url {
    flex: 1;
    font-size: 11px;
    color: #e4e4e7;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.folder-dropdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: #171717;
    border: 1px solid #262626;
    border-radius: 4px;
    margin-bottom: 4px;
    transition: all 0.2s;
    position: relative;
}

.folder-dropdown-item .folder-item-remove {
    margin-left: auto;
}

.folder-item-remove {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    transition: all 0.2s;
    flex-shrink: 0;
}

.folder-item-remove:hover {
    color: #10a37f;
}

.folder-item-remove svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
}

.folder-empty {
    padding: 20px;
    text-align: center;
    color: #6b7280;
    font-size: 11px;
}

.tab-add {
    background: #1a1a1a;
    border: 1px solid #262626;
    padding: 8px;
    cursor: pointer;
    opacity: 1; /* força visibilidade total */
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    position: sticky;
    right: 8px;
    z-index: 101;
    border-radius: 4px;
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.3);
}


.tab-add:hover {
    opacity: 1;
    transform: scale(1.15);
}

.tab-add svg {
    width: 16px;
    height: 16px;
    stroke: #ffffff;
}

.tab-add:hover svg {
    stroke: #ffffff;
}

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tabs-mode .actions {
            display: none;
        }

        .returns-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 19999;     
            display: none;
        }

        .returns-overlay.active {
            display: block;
        }

        .btn-folder-action {
            cursor: pointer;
            color: #9ca3af;
            font-size: 10px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .btn-folder-action:hover {
            background: #262626;
            color: #e4e4e7;
        }


.folder-toggle-btn.tabs-mode {
    display: block;
}

.folder-toggle-btn:hover {
    background: #262626;
}

.folder-toggle-btn svg {
    width: 20px;
    height: 20px;
    stroke: #9ca3af;
}

.folder-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid #262626;
    margin-bottom: 8px;
}

.folder-title {
    font-size: 12px;
    font-weight: 600;
    color: #e4e4e7;
}

.folder-close {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    transition: all 0.2s;
}

.folder-close:hover {
    color: #e4e4e7;
}

.folder-close svg {
    width: 16px;
    height: 16px;
}

.folder-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: #171717;
    border: 1px solid #262626;
    border-radius: 4px;
    margin-bottom: 4px;
    transition: all 0.2s;
}

.folder-item:hover {
    background: #1a1a1a;
    border-color: #10a37f;
}

.folder-item-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    flex-shrink: 0;
}

.folder-item-url {
    flex: 1;
    font-size: 11px;
    color: #e4e4e7;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 200px;
}

.folder-item-remove {
    background: transparent;
    border: none;
    padding: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    transition: all 0.2s;
    flex-shrink: 0;
}

.folder-item-remove:hover {
    color: #10a37f;
}

.folder-item-remove svg {
    width: 14px;
    height: 14px;
}

.folder-empty {
    padding: 20px;
    text-align: center;
    color: #6b7280;
    font-size: 11px;
}

.tab-archive-btn {
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s;
    flex-shrink: 0;
    background: transparent;
    border: none;
    cursor: pointer;
    color: #f97316;
}

.tab:hover .tab-archive-btn {
    opacity: 0.6;
}

.tab-archive-btn:hover {
    opacity: 1 !important;
    color: #ea580c;
}

.tab-archive-btn svg {
    width: 13px;
    height: 13px;
    stroke: currentColor;
}
.utilities-item-guid {
    font-size: 10px;
    color: #9ca3af;
    font-family: 'Courier New', monospace;
    margin-top: 4px;
    letter-spacing: 0.5px;
}

.utilities-item-warning .utilities-item-guid {
    color: #e4e4e7;
    font-weight: 500;
}

/* Corrigir sticky da barra de abas */
.tabs-header.fixed {
    position: fixed !important;
    top: 52px !important;
    left: 15px !important;
    right: 15px !important;
    width: auto !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 15px !important;
    padding-right: 15px !important;
    z-index: 9999 !important;
    animation: slideDown 0.3s ease-out;
    background: linear-gradient(to bottom, #1f1f1f 0%, #1f1f1f 85%, rgba(31, 31, 31, 0.95) 100%) !important;
    backdrop-filter: blur(8px) !important;
}


/* Overlay de loading */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #0f0f10;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000000;
    color: #10a37f;
    font-size: 14px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}


    </style>
</head>
<body>

<body>
    <!-- Overlay de loading simplificado -->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f0f10; z-index: 1000000; color: #10a37f; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; align-items: center; justify-content: center;">
        <div style="text-align: center;">
            <div style="font-size: 16px; margin-bottom: 10px;">Carregando dados...</div>
            <div id="loadingMessage" style="font-size: 12px; color: #6b7280;">Inicializando aplicativo</div>
        </div>

<!-- Adicione isso dentro do loadingOverlay -->
<div style="position: absolute; bottom: 20px; width: 100%; text-align: center;">
    <button id="skipLoadingBtn" style="background: #262626; border: 1px solid #10a37f; color: #10a37f; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px;">
        Pular loading (pra emergências)
    </button>
</div>

    </div>

    <!-- Barra de título customizada -->
<div class="custom-titlebar">
        <div class="titlebar-drag-region"></div>
        <div class="titlebar-content">
            <div class="titlebar-left">
                <button class="titlebar-btn titlebar-btn-subtle" id="titlebarUndoBtn" onclick="undo()" disabled title="Reverter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 7v6h6"></path>
                        <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
                    </svg>
                </button>
                <button class="titlebar-btn titlebar-btn-subtle" id="titlebarRedoBtn" onclick="redo()" disabled title="Refazer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 7v6h-6"></path>
                        <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path>
                    </svg>
                </button>
                
                <div class="titlebar-separator"></div>
                
                <div class="titlebar-period-container">
                    <button class="titlebar-btn titlebar-period-btn" id="titlebarPeriodBtn" onclick="togglePeriodDropdown(event)">
                        <span class="titlebar-period-label">Exibindo dados de</span>
                        <span class="titlebar-period-value">
                            <span id="titlebarPeriodText">últimos 30 dias</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </span>
                    </button>
                </div>
                
                <div class="titlebar-stat">
                    <span class="titlebar-stat-label">Contas</span>
                    <span class="titlebar-stat-value" id="titlebarTotalAccounts">0</span>
                </div>
                <div class="titlebar-stat">
                    <span class="titlebar-stat-label">Funcionando</span>
                    <span class="titlebar-stat-value highlight" id="titlebarTotalOn">0</span>
                </div>
                <div class="titlebar-stat">
                    <span class="titlebar-stat-label">Pacote</span>
                    <span class="titlebar-stat-value" id="titlebarTotalHighlighted">0</span>
                </div>
                <div class="titlebar-stat">
                    <span class="titlebar-stat-label">Retornadas</span>
                    <span class="titlebar-stat-value" id="titlebarTotalReturned">0</span>
                </div>
                <div class="titlebar-stat">
                    <span class="titlebar-stat-label">Soma</span>
                    <span class="titlebar-stat-value highlight" id="titlebarTotalValue">$0</span>
                </div>
                
                <button class="titlebar-btn titlebar-btn-subtle hideArchived-btn" id="hideArchivedBtn" onclick="toggleHideArchived()" title="Ignorar seções arquivadas">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Ignorar arquivados
                </button>
            </div>
            
            <div class="titlebar-stats">
            </div>
            
            <div class="titlebar-right">
                
                <button class="titlebar-btn titlebar-btn-subtle titlebar-btn-utilities" id="utilitiesBtn" onclick="toggleUtilitiesDropdown(event)" title="Utilidades">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </svg>
                    Utilidades
                </button>
                
                <button class="titlebar-btn titlebar-btn-subtle titlebar-save-btn" onclick="toggleSaveDropdown(event)" title="Gerenciar saves">
                    <span id="titlebarCurrentSaveBtn">contas.json</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 9px; height: 9px;">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                
                <button class="titlebar-btn titlebar-btn-subtle titlebar-clock-btn" onclick="toggleReturnsPanel()" title="Painel de Retornos">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <div class="titlebar-clock-badge" id="titlebarClockBadge">0</div>
                </button>
            </div>
            
            <div class="titlebar-buttons">
                <button class="titlebar-button" id="minimizeBtn" onclick="minimizeWindow()" tabindex="-1">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="0" y1="6" x2="12" y2="6"></line>
                    </svg>
                </button>
                <button class="titlebar-button" id="maximizeBtn" onclick="toggleMaximize()" tabindex="-1">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1">
                        <rect x="1" y="1" width="10" height="10"></rect>
                    </svg>
                </button>
                <button class="titlebar-button titlebar-close" id="closeBtn" onclick="closeWindow()" tabindex="-1">
                    <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1">
                        <line x1="1" y1="1" x2="11" y2="11"></line>
                        <line x1="11" y1="1" x2="1" y2="11"></line>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Dropdown de período -->
        <div class="period-dropdown" id="periodDropdown" style="position: fixed; top: 52px; left: 12px; margin-top: 4px;">
            <div class="period-item" data-days="-1" onclick="changePeriod(-1)">Total</div>
            <div class="period-item" data-days="1" onclick="changePeriod(1)">último dia</div>
            <div class="period-item" data-days="7" onclick="changePeriod(7)">últimos 7 dias</div>
            <div class="period-item" data-days="10" onclick="changePeriod(10)">últimos 10 dias</div>
            <div class="period-item active" data-days="30" onclick="changePeriod(30)">últimos 30 dias</div>
            <div class="period-item" data-days="60" onclick="changePeriod(60)">últimos 60 dias</div>
            <div class="period-item" data-days="90" onclick="changePeriod(90)">últimos 90 dias</div>
        </div>
    </div>

    <div class="container">

        <!-- Dropdown Utilidades (posicionado em relação à titlebar) -->
                <div class="save-dropdown utilities-dropdown" id="utilitiesDropdown" style="display: none;">
                    <div class="save-dropdown-section">
                        <div class="save-dropdown-header">
                            <div class="save-dropdown-title">Sistema</div>
                        </div>
                        
                        <div class="utilities-item utilities-item-danger" onclick="clearKameleoCache()" data-cache-btn="kameleo">
                            <div class="utilities-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                                    <path d="M2 17l10 5 10-5"></path>
                                    <path d="M2 12l10 5 10-5"></path>
                                </svg>
                            </div>
                            <div class="utilities-item-content">
                                <div class="utilities-item-title">Resetar Kameleo</div>
                                <div class="utilities-item-desc">Troca identificadores relacionados</div>
                            </div>
                        </div>
                        <div class="utilities-item utilities-item-warning" onclick="resetMachineGUID()" data-system-btn="guid">
                            <div class="utilities-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>
                            </div>
                            <div class="utilities-item-content">
                                <div class="utilities-item-title">Resetar Machine GUID</div>
                                <div class="utilities-item-desc">Gera novo identificador único do sistema</div>
                                <div class="utilities-item-guid" id="currentMachineGuid">Carregando...</div>
                            </div>
                        </div>
                        
<div class="utilities-item utilities-item-warning" onclick="resetMacAddress()" data-system-btn="mac">
    <div class="utilities-item-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="2"></circle>
        </svg>
    </div>
    <div class="utilities-item-content">
        <div class="utilities-item-title">Resetar MAC Address</div>
        <div class="utilities-item-desc">Gera e aplica um MAC Address aleatório</div>
        <div class="utilities-mac-container">
            <div class="utilities-mac-info">
                <div class="utilities-mac-adapter" id="currentAdapter">Carregando...</div>
                <div class="utilities-mac-address" id="currentMac">Carregando...</div>
            </div>
            <div class="utilities-mac-gear" onclick="selectNetworkAdapter(event); event.stopPropagation();" title="Configurar adaptador">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
    <circle cx="12" cy="12" r="3"></circle>
</svg>
                <span class="config-alert-badge" id="adapterAlertBadge" style="display: none;"></span>
            </div>
        </div>
    </div>
</div>
                        
                        <button class="utilities-reset-both" onclick="resetBoth()">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>
                                <span style="font-size: 12px; font-weight: 700;">+</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <circle cx="12" cy="12" r="6"></circle>
                                    <circle cx="12" cy="12" r="2"></circle>
                                </svg>
                            </div>
                            <span style="font-size: 11px; margin-top: 2px;">Resetar ambos</span>
                        </button>
                        
                        <button class="utilities-reset-both" onclick="resetSecondaryIds()" style="opacity: 0.7; margin-top: 6px;">
                            <span style="font-size: 10px; margin-top: 2px;">Resetar IDs secundários (não recomendado)</span>
                        </button>
                    </div>
                    
                    <div class="save-dropdown-section">
                        <div class="save-dropdown-header">
                            <div class="save-dropdown-title">Limpeza de cache</div>
                        </div>
                        
                        <div class="utilities-item" onclick="clearWarThunderCache()" data-cache-btn="warthunder">
                            <div class="utilities-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                                <div class="cache-status-badge loading">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="utilities-item-content">
                                <div class="utilities-item-title">WarThunder</div>
                                <div class="utilities-item-desc">Busca e executa limpeza do cache</div>
                            </div>
                            <button class="utilities-toggle-btn" onclick="toggleResetOnCache(event, 'warthunder')" title="Resetar GUID e MAC junto" data-toggle="warthunder">
                                <div class="toggle-icons">
                                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    <span class="toggle-plus">+</span>
                                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <circle cx="12" cy="12" r="6"></circle>
                                        <circle cx="12" cy="12" r="2"></circle>
                                    </svg>
                                </div>
                            </button>
                        </div>
                        
                        <div class="utilities-item" onclick="clearMiHoYoCache()" data-cache-btn="mihoyo">
                            <div class="utilities-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                                <div class="cache-status-badge loading">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="utilities-item-content">
                                <div class="utilities-item-title">miHoYo</div>
                                <div class="utilities-item-desc">Executa limpeza do cache</div>
                            </div>
                            <button class="utilities-toggle-btn" onclick="toggleResetOnCache(event, 'mihoyo')" title="Resetar GUID e MAC junto" data-toggle="mihoyo">
                                <div class="toggle-icons">
                                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    <span class="toggle-plus">+</span>
                                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <circle cx="12" cy="12" r="6"></circle>
                                        <circle cx="12" cy="12" r="2"></circle>
                                    </svg>
                                </div>
                            </button>
                        </div>
                        
                        <div class="utilities-item" onclick="clearEndfieldCache()" data-cache-btn="endfield">
                            <div class="utilities-item-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                                </svg>
                                <div class="cache-status-badge loading">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="utilities-item-content">
                                <div class="utilities-item-title">Arknights: Endfield</div>
                                <div class="utilities-item-desc">Executa limpeza completa do cache</div>
                            </div>
                            <button class="utilities-toggle-btn" onclick="toggleResetOnCache(event, 'endfield')" title="Resetar GUID e MAC junto" data-toggle="endfield">
                                <div class="toggle-icons">
                                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    <span class="toggle-plus">+</span>
                                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <circle cx="12" cy="12" r="6"></circle>
                                        <circle cx="12" cy="12" r="2"></circle>
                                    </svg>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- SVG para as linhas de conexão -->
                    <svg class="connection-lines" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000;">
<defs>
    <linearGradient id="lineGradient1" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#10a37f;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="lineGradient2" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#10a37f;stop-opacity:1" />
    </linearGradient>
</defs>
                        <line id="guidLine" x1="0" y1="0" x2="0" y2="0" stroke="url(#lineGradient1)" stroke-width="2" opacity="0" />
                        <line id="macLine" x1="0" y1="0" x2="0" y2="0" stroke="url(#lineGradient2)" stroke-width="2" opacity="0" />
                    </svg>
                </div>
        
<!-- Dropdowns agora estão posicionados em relação à titlebar -->

<div class="tabs-fade-wrapper">
    <div id="tabsHeader" class="tabs-header" style="display: none;"></div>
    <div class="tabs-fade-overlay"></div>
</div>


        <div id="sectionsContainer"></div>

        <div class="actions">
            <button class="btn-primary" onclick="addSection()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Adicionar nova seção
            </button>
        </div>
    </div>

    <div class="returns-overlay" id="returnsOverlay" onclick="closeReturnsPanel()"></div>

    <div class="returns-panel" id="returnsPanel">
        <div class="returns-panel-header">
            <div class="returns-header-top">
                <button class="returns-settings-btn" onclick="toggleReturnsSettings()" title="Configurações">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div class="returns-panel-title">Painel de Retornos</div>
                <div class="returns-panel-date" id="returnsPanelDate">Hoje</div>
                <button class="btn-close-panel" onclick="closeReturnsPanel()">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="returns-filters" id="returnsFilters">
                <div class="returns-filter-table">
                    <div class="returns-filter-header">Tipo de filtro</div>
                    <div class="returns-filter-header">Ocultar acima de</div>
                    
                    <div class="returns-filter-label">Conta normal:</div>
                    <div class="returns-filter-input-wrapper">
                        <input type="text" class="returns-filter-input" id="hideReturnsAbove" value="1 retorno" readonly onclick="editFilterValue(this, 'hideReturnsAbove')">
                    </div>
                    
                    <div class="returns-filter-label">Conta destacada (duplo clique):</div>
                    <div class="returns-filter-input-wrapper">
                        <input type="text" class="returns-filter-input" id="hideHighlightedAbove" value="6 retornos" readonly onclick="editFilterValue(this, 'hideHighlightedAbove')">
                    </div>
                </div>
                
                <div class="override-section">
                    <div class="override-header">
                        <button class="override-toggle-btn" id="overrideToggleBtn" onclick="toggleOverrideUI()">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                            <span>Configuração Override</span>
                        </button>
                        <button class="override-enable-btn" id="overrideEnableBtn" onclick="toggleOverrideEnabled()">
                            <span id="overrideEnableText">Desativado</span>
                        </button>
                    </div>
                    <div class="override-config" id="overrideConfig">
                        <div class="override-explanation">
                            Aplica um filtro diferente em X contas a cada Y contas que funcionaram (por link). Contas destacadas não são afetadas e não contam para o cálculo.
                        </div>
                        <div class="override-settings">
                            <div class="override-setting-row">
                                <input type="text" class="returns-filter-input" id="overrideHowMany" value="5 contas" readonly onclick="editOverrideValue(this, 'overrideHowMany')">
                                <label>a cada</label>
                                <input type="text" class="returns-filter-input" id="overrideEveryX" value="10 contas" readonly onclick="editOverrideValue(this, 'overrideEveryX')">
                                <label>override de</label>
                                <input type="text" class="returns-filter-input" id="overrideReturnsCount" value="2 retornos" readonly onclick="editOverrideValue(this, 'overrideReturnsCount')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="returns-panel-content" id="returnsContent">
        </div>
    </div>

    <script>
        let sections = [];
        let folders = [];
        let currentSavePath = '';
        let undoStack = [];
        let redoStack = [];
        let isUndoRedoAction = false;
        let tabLayout = true;
        let activeTabIndex = 0;
        let hideReturnsAbove = 1;
        let hideHighlightedAbove = 6;
        let overrideEnabled = false;
        let overrideHowMany = 5;
        let overrideEveryX = 10;
        let overrideReturnsCount = 2;
        let draggedTabIndex = null;
        let dragOverTabIndex = null;
        let lastInteractedAccount = null;
        let lastCopiedReturnAccount = null;
        let currentPeriodDays = 30;
        let hideArchived = false;

        const COLORS = [
            '#52525b', '#71717a', '#a1a1aa', '#3f3f46'  // Cinzas neutros
        ];
        for (let i = 0; i < 360; i += 10) {
            COLORS.push(`hsl(${i}, 70%, 55%)`);
        }


// ================= INICIALIZAÇÃO SIMPLIFICADA =================

// Aguarda que o DOM e a API do Electron estejam prontos
window.addEventListener('DOMContentLoaded', () => {
    console.log('DOM carregado, aguardando API do Electron...');
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    
    // Função para tentar inicializar
    const tryInitialize = async (attempt = 1) => {
        try {
            if (loadingMessage) loadingMessage.textContent = `Conectando com o sistema (tentativa ${attempt})...`;
            
            // Verifica se a API do Electron está disponível
            if (window.electronAPI) {
                console.log('Electron API encontrada');
                if (loadingMessage) loadingMessage.textContent = 'Carregando dados do save...';
                
                // Pequeno delay para garantir que tudo está pronto
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Inicializa o aplicativo
                await initializeApp();
                
                // Remove o loading
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                console.log('App inicializado com sucesso');
            } else {
                console.log('Electron API não encontrada, tentando novamente...');
                throw new Error('API não disponível');
            }
        } catch (error) {
            console.warn(`Tentativa ${attempt} falhou:`, error);
            
            // Se falhou 5 vezes, tenta carregar com dados padrão
            if (attempt >= 5) {
                console.log('Carregando com dados padrão...');
                if (loadingMessage) loadingMessage.textContent = 'Carregando dados padrão...';
                
                // Cria dados padrão
                sections = [createNewSection()];
                await saveData();
                renderSections();
                updateReturnsPanel();
                updateSummary();
                
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                console.log('App inicializado com dados padrão');
                return;
            }
            
            // Espera e tenta novamente
            await new Promise(resolve => setTimeout(resolve, 500));
            await tryInitialize(attempt + 1);
        }
    };
    
    // Inicia a tentativa de inicialização
    tryInitialize();
});

// Adicione este código após o DOMContentLoaded
document.getElementById('skipLoadingBtn')?.addEventListener('click', () => {
    console.log('Loading pulado manualmente');
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
    
    // Inicializa com dados padrão
    sections = [createNewSection()];
    saveData();
    renderSections();
    updateReturnsPanel();
    updateSummary();
});

// Função initializeApp simplificada
// Captura de erros globais
window.addEventListener('error', (event) => {
    console.error('Erro global:', event.error);
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
});

// Captura de promessas não tratadas
window.addEventListener('unhandledrejection', (event) => {
    console.error('Erro não tratado:', event.reason);
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
});

async function initializeApp() {
    console.log('Iniciando app...');
    
    try {
        await createBackup();
        
        const result = await window.electronAPI.loadData();
        console.log('Resultado do loadData:', result);
        
        if (result.success) {
            currentSavePath = result.path;
            
            if (result.data) {
                const migrated = migrateData(result.data);
                sections = migrated.sections || [];
                folders = migrated.folders || [];
                tabLayout = migrated.tabLayout !== undefined ? migrated.tabLayout : true;
                hideReturnsAbove = migrated.hideReturnsAbove !== undefined ? migrated.hideReturnsAbove : 1;
                hideHighlightedAbove = migrated.hideHighlightedAbove !== undefined ? migrated.hideHighlightedAbove : 6;
                currentPeriodDays = migrated.currentPeriodDays !== undefined ? migrated.currentPeriodDays : 30;
                overrideEnabled = migrated.overrideEnabled || false;
                overrideHowMany = migrated.overrideHowMany !== undefined ? migrated.overrideHowMany : 5;
                overrideEveryX = migrated.overrideEveryX !== undefined ? migrated.overrideEveryX : 10;
                overrideReturnsCount = migrated.overrideReturnsCount !== undefined ? migrated.overrideReturnsCount : 2;
                
                // Restaurar estados
                if (migrated.cacheToggleStates) {
                    cacheToggleStates = migrated.cacheToggleStates;
                }
                if (migrated.selectedNetworkAdapter) {
                    selectedNetworkAdapter = migrated.selectedNetworkAdapter;
                }
                
                // Garantir que activeTabIndex seja válido
                const visibleTabs = sections.map((s, i) => i).filter(i => !folders.includes(i));
                activeTabIndex = visibleTabs.length > 0 ? visibleTabs[0] : 0;
                
                console.log('Dados carregados:', sections.length, 'seções');
            } else {
                console.log('Nenhum dado, criando novas seções');
                sections = [
                    {
                        url: '',
                        value: 0,
                        number: '',
                        returnDays: 5,
                        color: COLORS[0],
                        collapsed: false,
                        dateGroups: []
                    },
                    {
                        url: '',
                        value: 0,
                        number: '',
                        returnDays: 5,
                        color: COLORS[1],
                        collapsed: false,
                        dateGroups: []
                    }
                ];
                tabLayout = true;
                await saveData();
            }
        } else {
            console.error('Erro ao carregar:', result.error);
            sections = [createNewSection()];
            await saveData();
        }
    } catch (error) {
        console.error('Erro crítico em initializeApp:', error);
        sections = [createNewSection()];
        await saveData();
    }
    
    // Garantir que a UI seja atualizada
    updateAllUI();
    
    // Esconder loading
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.style.display = 'none';
    
    console.log('App inicializado');
}

function updateAllUI() {
    console.log('Atualizando UI...');
    
    try {
        // Atualizar filtros
        const hideReturnsEl = document.getElementById('hideReturnsAbove');
        const hideHighlightedEl = document.getElementById('hideHighlightedAbove');
        const overrideHowManyEl = document.getElementById('overrideHowMany');
        const overrideEveryXEl = document.getElementById('overrideEveryX');
        const overrideReturnsCountEl = document.getElementById('overrideReturnsCount');
        
        if (hideReturnsEl) hideReturnsEl.value = hideReturnsAbove === 1 ? '1 retorno' : hideReturnsAbove + ' retornos';
        if (hideHighlightedEl) hideHighlightedEl.value = hideHighlightedAbove === 1 ? '1 retorno' : hideHighlightedAbove + ' retornos';
        if (overrideHowManyEl) overrideHowManyEl.value = overrideHowMany === 1 ? '1 conta' : overrideHowMany + ' contas';
        if (overrideEveryXEl) overrideEveryXEl.value = overrideEveryX === 1 ? '1 conta' : overrideEveryX + ' contas';
        if (overrideReturnsCountEl) overrideReturnsCountEl.value = overrideReturnsCount === 1 ? '1 retorno' : overrideReturnsCount + ' retornos';
        
        // Atualizar período
        const periodLabel = currentPeriodDays === -1 ? 'Total' : (currentPeriodDays === 1 ? 'último dia' : `últimos ${currentPeriodDays} dias`);
        const titlebarPeriodText = document.getElementById('titlebarPeriodText');
        if (titlebarPeriodText) titlebarPeriodText.textContent = periodLabel;
        
        // Atualizar save UI
        updateSaveUI();
        
        // Atualizar interface de tabs
        const tabsHeader = document.getElementById('tabsHeader');
        const container = document.querySelector('.container');
        const actionsDiv = document.querySelector('.actions');
        
        if (tabLayout) {
            if (container) container.classList.add('tabs-mode');
            document.body.classList.add('tabs-mode');
            if (tabsHeader) tabsHeader.style.display = 'flex';
            if (actionsDiv) actionsDiv.style.display = 'none';
        } else {
            if (container) container.classList.remove('tabs-mode');
            document.body.classList.remove('tabs-mode');
            if (tabsHeader) tabsHeader.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'flex';
        }
        
        // Renderizar tudo
        renderSections();
        updateReturnsPanel();
        updateSummary();
        updateCurrentDate();
        
        // Inicializar scroll
        setTimeout(() => {
            if (typeof handleTabsScroll === 'function') {
                handleTabsScroll();
            }
        }, 100);
        
        console.log('UI atualizada');
    } catch (error) {
        console.error('Erro ao atualizar UI:', error);
    }
}

// Adicionar comportamento de sticky manual para a barra de abas
let isCheckingScroll = false;
let tabsPlaceholder = null;

const handleTabsScroll = () => {
    if (!isCheckingScroll) {
        isCheckingScroll = true;
        requestAnimationFrame(() => {
            if (!tabLayout) {
                isCheckingScroll = false;
                return;
            }
            
            const tabsHeader = document.getElementById('tabsHeader');
            if (!tabsHeader || tabsHeader.style.display === 'none') {
                isCheckingScroll = false;
                return;
            }
            
            const container = document.querySelector('.container');
            if (!container) {
                isCheckingScroll = false;
                return;
            }
            
            const containerRect = container.getBoundingClientRect();
            const titlebarHeight = 52;
            
            // Se o container já passou da titlebar (52px), fixar a barra de abas
            if (containerRect.top <= titlebarHeight) {
                if (!tabsHeader.classList.contains('fixed')) {
                    // Criar placeholder para manter o espaço
                    if (!tabsPlaceholder) {
                        tabsPlaceholder = document.createElement('div');
                        tabsPlaceholder.style.height = tabsHeader.offsetHeight + 'px';
                        tabsPlaceholder.style.width = '100%';
                        tabsPlaceholder.style.flexShrink = '0';
                        tabsHeader.parentNode.insertBefore(tabsPlaceholder, tabsHeader);
                    }
                    tabsHeader.classList.add('fixed');
                    
                    // Fechar dropdowns quando sticky ativar
                    const folderDropdown = document.getElementById('folderDropdown');
                    if (folderDropdown) {
                        folderDropdown.classList.remove('active');
                    }
                    
                    // Atualizar posição do dropdown
                    if (window.updateFolderDropdownPosition) {
                        window.updateFolderDropdownPosition();
                    }
                }
            } else {
                if (tabsHeader.classList.contains('fixed')) {
                    tabsHeader.classList.remove('fixed');
                    // Remover placeholder
                    if (tabsPlaceholder && tabsPlaceholder.parentNode) {
                        tabsPlaceholder.parentNode.removeChild(tabsPlaceholder);
                        tabsPlaceholder = null;
                    }
                    // Atualizar posição do dropdown
                    if (window.updateFolderDropdownPosition) {
                        window.updateFolderDropdownPosition();
                    }
                    const folderDropdown = document.getElementById('folderDropdown');
                    if (folderDropdown) {
                        folderDropdown.classList.remove('active');
                    }
                }
            }
            isCheckingScroll = false;
        });
    }
};

// Adicionar event listeners corretamente
document.addEventListener('DOMContentLoaded', () => {
    window.addEventListener('scroll', handleTabsScroll, { passive: true });
    window.addEventListener('resize', handleTabsScroll, { passive: true });
    
    // Verificar estado inicial
    setTimeout(() => {
        handleTabsScroll();
    }, 500);
    
    // Adicionar scroll horizontal nas abas
    const tabsHeader = document.getElementById('tabsHeader');
    if (tabsHeader) {
        tabsHeader.addEventListener('wheel', (e) => {
            if (e.deltaY !== 0) {
                e.preventDefault();
                tabsHeader.scrollLeft += e.deltaY;
            }
        });
    }
    
    // Fechar dropdowns ao clicar fora
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('saveDropdown');
        if (dropdown && !e.target.closest('.header-right')) {
            dropdown.classList.remove('active');
            saveDropdownActive = false;
        }
        
        // Fechar color pickers
        document.querySelectorAll('.color-picker.active').forEach(picker => {
            if (!e.target.closest('.color-picker-container')) {
                picker.classList.remove('active');
            }
        });
        
        // Fechar folder dropdown ao clicar fora
        const folderDropdown = document.getElementById('folderDropdown');
        if (folderDropdown && !e.target.closest('.tab-folder-btn') && !e.target.closest('.folder-dropdown')) {
            folderDropdown.classList.remove('active');
        }
    });
});

async function createBackup() {
    try {
        const result = await window.electronAPI.loadData();
        if (result.success && result.data) {
            // Extrair o nome do save atual (sem extensão)
            const currentFileName = currentSavePath.split(/[\\/]/).pop();
            const saveName = currentFileName.replace('.json', '');
            
            const today = new Date();
            const dateStr = `${today.getFullYear()}_${String(today.getMonth() + 1).padStart(2, '0')}_${String(today.getDate()).padStart(2, '0')}_${String(today.getHours()).padStart(2, '0')}${String(today.getMinutes()).padStart(2, '0')}`;
            const backupName = `backup_${saveName}_${dateStr}.json`;
            await window.electronAPI.createBackup(backupName, result.data);
        }
    } catch (err) {
        console.error('Erro ao criar backup:', err);
    }
}

function updateCurrentDate() {
    const today = new Date();
    const formatted = today.toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    document.getElementById('returnsPanelDate').textContent = formatted;
}

function toggleFolderDropdown() {
    const dropdown = document.getElementById('folderDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

function updateSaveUI() {
    const pathParts = currentSavePath.split(/[\\/]/);
    const fileName = pathParts[pathParts.length - 1];
    const btn = document.getElementById('currentSaveBtn');
    const titlebarBtn = document.getElementById('titlebarCurrentSaveBtn');
    
    if (btn) {
        btn.textContent = fileName;
    }
    if (titlebarBtn) {
        titlebarBtn.textContent = fileName;
    }
}

let saveDropdownActive = false;
let backupDropdownActive = false;

function toggleSaveDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('saveDropdown');
    
    if (!dropdown) {
        createSaveDropdown();
    } else {
        dropdown.classList.toggle('active');
        saveDropdownActive = dropdown.classList.contains('active');
    }
    
    if (saveDropdownActive) {
        loadSavesList();
    }
}

// Função para checar status de todos os caches
async function checkAllCacheStatus() {
    const cacheGames = [
        { name: 'warthunder', checkFn: window.electronAPI.checkWarThunderCache },
        { name: 'mihoyo', checkFn: window.electronAPI.checkMiHoYoCache },
        { name: 'endfield', checkFn: window.electronAPI.checkEndfieldCache }
    ];
    
    console.log('[Cache Check] Iniciando checagem de todos os caches...');
    
    // PRIMEIRO: colocar TODOS os botões como loading ANTES de começar as checagens
    for (const game of cacheGames) {
        const cacheBtn = document.querySelector(`[data-cache-btn="${game.name}"]`);
        if (!cacheBtn) {
            console.warn(`[Cache Check] Botão não encontrado para: ${game.name}`);
            continue;
        }
        
        // Forçar badge de loading e remover status anterior
        showCacheLoadingBadge(cacheBtn);
        cacheBtn.removeAttribute('data-cache-status');
    }
    
    // DEPOIS: fazer as checagens uma por uma
    for (const game of cacheGames) {
        const cacheBtn = document.querySelector(`[data-cache-btn="${game.name}"]`);
        if (!cacheBtn) {
            continue;
        }
        
        try {
            console.log(`[Cache Check] Checando ${game.name}...`);
            const result = await game.checkFn();
            console.log(`[Cache Check] Resultado ${game.name}:`, result);
            
            if (result.success) {
                if (result.needsCleaning) {
                    console.log(`[Cache Check] ${game.name} precisa de limpeza ⚠️`);
                    showCacheWarningBadge(cacheBtn);
                    cacheBtn.setAttribute('data-cache-status', 'needs-cleaning');
                } else {
                    console.log(`[Cache Check] ${game.name} está limpo ✅`);
                    showCacheSuccessBadge(cacheBtn);
                    cacheBtn.setAttribute('data-cache-status', 'clean');
                }
            } else {
                console.error(`[Cache Check] Erro na checagem de ${game.name}:`, result.error);
                // Em caso de erro, não mostrar badge
                removeCacheBadge(cacheBtn);
                cacheBtn.removeAttribute('data-cache-status');
            }
        } catch (error) {
            console.error(`Erro ao checar cache de ${game.name}:`, error);
            removeCacheBadge(cacheBtn);
            cacheBtn.removeAttribute('data-cache-status');
        }
    }
}

// Função para mostrar badge de loading
function showCacheLoadingBadge(cacheBtn) {
    const iconDiv = cacheBtn.querySelector('.utilities-item-icon');
    if (!iconDiv) return;
    
    // Remover badge existente (seja ele qual for)
    const existingBadge = iconDiv.querySelector('.cache-status-badge');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    // Criar badge de loading com spinner sutil
    const badge = document.createElement('div');
    badge.className = 'cache-status-badge loading';
    badge.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
    `;
    iconDiv.appendChild(badge);
}

// Função para mostrar badge de warning (ícone de alerta laranja)
function showCacheWarningBadge(cacheBtn) {
    const iconDiv = cacheBtn.querySelector('.utilities-item-icon');
    if (!iconDiv) return;
    
    // Remover badge existente
    const existingBadge = iconDiv.querySelector('.cache-status-badge');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    // Criar badge de warning com ícone SVG
    const badge = document.createElement('div');
    badge.className = 'cache-status-badge warning';
    badge.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
    `;
    iconDiv.appendChild(badge);
}

// Função para mostrar badge de sucesso (ícone de check verde)
function showCacheSuccessBadge(cacheBtn) {
    const iconDiv = cacheBtn.querySelector('.utilities-item-icon');
    if (!iconDiv) return;
    
    // Remover badge existente
    const existingBadge = iconDiv.querySelector('.cache-status-badge');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    // Criar badge de sucesso com ícone SVG
    const badge = document.createElement('div');
    badge.className = 'cache-status-badge success';
    badge.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
    `;
    iconDiv.appendChild(badge);
}

// Função para remover badge
function removeCacheBadge(cacheBtn) {
    const iconDiv = cacheBtn.querySelector('.utilities-item-icon');
    if (!iconDiv) return;
    
    const badge = iconDiv.querySelector('.cache-status-badge');
    if (badge) {
        badge.remove();
    }
}

async function toggleUtilitiesDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('utilitiesDropdown');
    const saveDropdown = document.getElementById('saveDropdown');
    
    // Fechar dropdown de saves se estiver aberto
    if (saveDropdown && saveDropdown.classList.contains('active')) {
        saveDropdown.classList.remove('active');
    }
    
    // Toggle do dropdown de utilidades
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        dropdown.style.display = 'block';
        document.addEventListener('click', closeUtilitiesDropdownOnClick);
        
        // Carregar Machine GUID atual
        const guidResult = await window.electronAPI.getMachineGUID();
        const guidElement = document.getElementById('currentMachineGuid');
        if (guidElement) {
            if (guidResult.success) {
                guidElement.textContent = `${guidResult.guid}`;
            } else {
                guidElement.textContent = 'ID Atual: não disponível';
            }
        }
        
        // Checar status de cache automaticamente
        checkAllCacheStatus();
        
// Carregar informações do adaptador de rede
const adapterElement = document.getElementById('currentAdapter');
const macElement = document.getElementById('currentMac');

if (selectedNetworkAdapter) {
    adapterElement.className = 'utilities-mac-adapter';
    adapterElement.textContent = `Adaptador: ${selectedNetworkAdapter}`;
    
    // Buscar MAC address do adaptador selecionado
    const adaptersResult = await window.electronAPI.listNetworkAdapters();
    if (adaptersResult.success) {
        const adapter = adaptersResult.adapters.find(a => a.Name === selectedNetworkAdapter);
        if (adapter) {
            macElement.className = 'utilities-mac-address';
            macElement.textContent = `MAC Address: ${adapter.MacAddress}`;
        } else {
            macElement.className = 'utilities-mac-address';
            macElement.textContent = 'MAC Address: não selecionado';
        }
    }
} else {
    adapterElement.className = 'utilities-mac-adapter';
    adapterElement.textContent = 'Adaptador: não selecionado';
    macElement.className = 'utilities-mac-address';
    macElement.textContent = 'MAC Address: não selecionado';
}
        
        // Restaurar estado dos toggles
        Object.keys(cacheToggleStates).forEach(game => {
            const toggle = dropdown.querySelector(`[data-toggle="${game}"]`);
            if (toggle && cacheToggleStates[game]) {
                toggle.classList.add('active');
            }
        });
        
        // Inicializar event listeners para hover
        initializeUtilitiesHoverEffects();
    } else {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closeUtilitiesDropdownOnClick);
    }
}

function initializeUtilitiesHoverEffects() {
    const utilitiesDropdown = document.getElementById('utilitiesDropdown');
    if (!utilitiesDropdown) return;
    
    const cacheButtons = utilitiesDropdown.querySelectorAll('[data-cache-btn]');
    const guidBtn = utilitiesDropdown.querySelector('[data-system-btn="guid"]');
    const macBtn = utilitiesDropdown.querySelector('[data-system-btn="mac"]');
    const guidLine = document.getElementById('guidLine');
    const macLine = document.getElementById('macLine');
    
    let animationFrameId = null;
    
const updateLinePositions = (cacheBtn, toggle) => {
    const cacheBtnRect = cacheBtn.getBoundingClientRect();
    const dropdownRect = utilitiesDropdown.getBoundingClientRect();
    const toggleRect = toggle.getBoundingClientRect();
    
    // MUDANÇA: Usar scrollTop para compensar o scroll
    const scrollOffset = utilitiesDropdown.scrollTop;
    
    if (guidBtn && guidLine) {
        const guidIconRect = guidBtn.querySelector('.utilities-item-icon').getBoundingClientRect();
        
        const x1 = guidIconRect.left - dropdownRect.left + guidIconRect.width;
        const y1 = guidIconRect.top - dropdownRect.top + guidIconRect.height / 2 + scrollOffset;
        const x2 = toggleRect.left - dropdownRect.left + toggleRect.width / 2;
        const y2 = toggleRect.top - dropdownRect.top + toggleRect.height / 2 + scrollOffset;
        
        guidLine.setAttribute('x1', x1);
        guidLine.setAttribute('y1', y1);
        guidLine.setAttribute('x2', x2);
        guidLine.setAttribute('y2', y2);
    }
    
    if (macBtn && macLine) {
        const macIconRect = macBtn.querySelector('.utilities-item-icon').getBoundingClientRect();
        
        const x1 = macIconRect.left - dropdownRect.left + macIconRect.width;
        const y1 = macIconRect.top - dropdownRect.top + macIconRect.height / 2 + scrollOffset;
        const x2 = toggleRect.left - dropdownRect.left + toggleRect.width / 2;
        const y2 = toggleRect.top - dropdownRect.top + toggleRect.height / 2 + scrollOffset;
        
        macLine.setAttribute('x1', x1);
        macLine.setAttribute('y1', y1);
        macLine.setAttribute('x2', x2);
        macLine.setAttribute('y2', y2);
    }
};
    

// Listener para atualizar posição das linhas durante scroll
const dropdown = document.getElementById('utilitiesDropdown');
let scrollListener = null;

dropdown.addEventListener('scroll', () => {
    const guidLine = document.getElementById('guidLine');
    const macLine = document.getElementById('macLine');
    
    // Se as linhas estão visíveis, atualizar posição
    if (guidLine && parseFloat(guidLine.getAttribute('opacity')) > 0) {
        cacheButtons.forEach(cacheBtn => {
            const toggle = cacheBtn.querySelector('.utilities-toggle-btn');
            if (toggle && toggle.classList.contains('active')) {
                updateLinePositions(cacheBtn, toggle);
            }
        });
    }
});
    
    cacheButtons.forEach(cacheBtn => {
        // Remover listeners antigos se existirem
        const oldEnter = cacheBtn._hoverEnter;
        const oldLeave = cacheBtn._hoverLeave;
        if (oldEnter) cacheBtn.removeEventListener('mouseenter', oldEnter);
        if (oldLeave) cacheBtn.removeEventListener('mouseleave', oldLeave);
        
const handleEnter = () => {
    const game = cacheBtn.getAttribute('data-cache-btn');
    const toggle = cacheBtn.querySelector('.utilities-toggle-btn');
    
    if (toggle && toggle.classList.contains('active')) {
        // Adicionar shake e highlight nos botões de sistema
        if (guidBtn) {
            guidBtn.classList.add('shake', 'highlighted');
        }
        if (macBtn) {
            macBtn.classList.add('shake', 'highlighted');
        }
        
        // Mostrar linhas
        if (guidLine) guidLine.setAttribute('opacity', '0.6');
        if (macLine) macLine.setAttribute('opacity', '0.6');
        
        // Atualizar posição das linhas continuamente
        const animate = () => {
            updateLinePositions(cacheBtn, toggle);
            animationFrameId = requestAnimationFrame(animate);
        };
        animate();
        
        // ADICIONAR: Listener de scroll para atualizar posição
        const scrollListener = () => {
            if (guidLine && parseFloat(guidLine.getAttribute('opacity')) > 0) {
                updateLinePositions(cacheBtn, toggle);
            }
        };
        utilitiesDropdown.addEventListener('scroll', scrollListener);
        
        // Guardar referência para remover depois
        cacheBtn._scrollListener = scrollListener;
    }
};
        
const handleLeave = () => {
    // Cancelar animação
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    
    // Remover shake e highlight
    if (guidBtn) {
        guidBtn.classList.remove('shake', 'highlighted');
    }
    if (macBtn) {
        macBtn.classList.remove('shake', 'highlighted');
    }
    
    // Esconder linhas
    if (guidLine) guidLine.setAttribute('opacity', '0');
    if (macLine) macLine.setAttribute('opacity', '0');
    
    // ADICIONAR: Remover listener de scroll
    if (cacheBtn._scrollListener) {
        utilitiesDropdown.removeEventListener('scroll', cacheBtn._scrollListener);
        cacheBtn._scrollListener = null;
    }
};
        
        cacheBtn._hoverEnter = handleEnter;
        cacheBtn._hoverLeave = handleLeave;
        
        cacheBtn.addEventListener('mouseenter', handleEnter);
        cacheBtn.addEventListener('mouseleave', handleLeave);
    });
}

function closeUtilitiesDropdownOnClick(e) {
    const dropdown = document.getElementById('utilitiesDropdown');
    const btn = document.getElementById('utilitiesBtn');
    
    if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.style.display = 'none';
        document.removeEventListener('click', closeUtilitiesDropdownOnClick);
    }
}

// Funções para loading nas estatísticas da titlebar
let savedStats = {};

function showTitlebarLoading(message) {
    // Salvar valores atuais
    savedStats = {
        accounts: document.getElementById('titlebarTotalAccounts').textContent,
        on: document.getElementById('titlebarTotalOn').textContent,
        highlighted: document.getElementById('titlebarTotalHighlighted').textContent,
        returned: document.getElementById('titlebarTotalReturned').textContent,
        value: document.getElementById('titlebarTotalValue').textContent
    };
    
    // Ocultar stats e mostrar loading
    document.querySelectorAll('.titlebar-stat').forEach(stat => {
        stat.style.display = 'none';
    });
    
    // Ocultar botão de ignorar arquivados e período durante loading
    const hideArchivedBtn = document.getElementById('hideArchivedBtn');
    if (hideArchivedBtn) hideArchivedBtn.style.display = 'none';
    
    const periodContainer = document.querySelector('.titlebar-period-container');
    if (periodContainer) periodContainer.style.display = 'none';
    
    // Criar ou atualizar elemento de loading
    let loadingElement = document.getElementById('titlebar-loading');
    if (!loadingElement) {
        loadingElement = document.createElement('div');
        loadingElement.id = 'titlebar-loading';
        loadingElement.style.cssText = `
            display: flex;
            align-items: center;
            gap: 8px;
            color: #10a37f;
            font-size: 12px;
            font-weight: 500;
            padding: 0 16px;
        `;
        
        const titlebarStats = document.querySelector('.titlebar-stats');
        if (titlebarStats) {
            titlebarStats.appendChild(loadingElement);
        }
    }
    
    loadingElement.innerHTML = `
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <circle cx="12" cy="12" r="10" opacity="0.25"></circle>
            <path d="M12 2a10 10 0 0 1 10 10" opacity="0.75"></path>
        </svg>
        <span>${message}</span>
    `;
    loadingElement.style.display = 'flex';
}

function restoreTitlebarStats() {
    // Ocultar loading
    const loadingElement = document.getElementById('titlebar-loading');
    if (loadingElement) {
        loadingElement.style.display = 'none';
    }
    
    // Restaurar stats
    document.querySelectorAll('.titlebar-stat').forEach(stat => {
        stat.style.display = 'flex';
    });
    
    // Restaurar botão de ignorar arquivados e período
    const hideArchivedBtn = document.getElementById('hideArchivedBtn');
    if (hideArchivedBtn) hideArchivedBtn.style.display = '';
    
    const periodContainer = document.querySelector('.titlebar-period-container');
    if (periodContainer) periodContainer.style.display = '';
    
    // Restaurar valores salvos se existirem
    if (savedStats.accounts !== undefined) {
        document.getElementById('titlebarTotalAccounts').textContent = savedStats.accounts;
        document.getElementById('titlebarTotalOn').textContent = savedStats.on;
        document.getElementById('titlebarTotalHighlighted').textContent = savedStats.highlighted;
        document.getElementById('titlebarTotalReturned').textContent = savedStats.returned;
        document.getElementById('titlebarTotalValue').textContent = savedStats.value;
    }
    
    // Atualizar para valores mais recentes
    updateSummary();
}

async function resetMachineGUID() {
    // Verificar se há uma operação de limpeza em andamento
    if (isCacheOperationInProgress) {
        showCustomAlert('Aguarde a operação de limpeza de cache ser concluída.');
        return;
    }
    
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    // Mostrar loading
    showTitlebarLoading('trocando MachineGUID...');
    
    // Capturar GUID atual ANTES de resetar
    const oldGuidResult = await window.electronAPI.getMachineGUID();
    const oldGuid = oldGuidResult.success ? oldGuidResult.guid : 'não disponível';
    
    // Resetar sem confirmação (apenas prompt de admin)
    const result = await window.electronAPI.resetMachineGUID();
    
    if (result.success) {
        // Aguardar um momento para o sistema processar
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Ler o novo GUID
        const newGuidResult = await window.electronAPI.getMachineGUID();
        const newGuid = newGuidResult.success ? newGuidResult.guid : 'não disponível';
        
        // Atualizar no dropdown
        const guidElement = document.getElementById('currentMachineGuid');
        if (guidElement && newGuidResult.success) {
            guidElement.textContent = `ID Atual: ${newGuid}`;
        }
        
        showCustomAlert(`ID trocado com sucesso!\n\nID antigo: ${oldGuid}\nID novo: ${newGuid}`);
    } else {
        showCustomAlert('Erro: ' + (result.error || 'Operação cancelada ou sem permissão'));
    }
    
    // Restaurar stats
    restoreTitlebarStats();
}

async function clearWarThunderCache() {
    // Verificar se já existe uma operação em andamento
    if (isCacheOperationInProgress) {
        showCustomAlert('Aguarde a operação anterior ser concluída.');
        return;
    }
    
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    const isToggled = cacheToggleStates.warthunder || false;
    
    // Verificar se o toggle está ativo e se nenhum adaptador foi selecionado
    if (isToggled && !selectedNetworkAdapter) {
        showCustomAlert('Por favor, selecione um adaptador de rede primeiro antes de limpar o cache com reset de MAC.');
        // Aguardar o usuário fechar o alert e então abrir o selecionador
        setTimeout(async () => {
            await selectNetworkAdapter({ stopPropagation: () => {} });
        }, 300);
        return;
    }
    
    showCustomConfirm(
        'Isso irá apagar automaticamente os registros do WarThunder. Continuar?',
        async () => {
            try {
                // Bloquear novas operações
                isCacheOperationInProgress = true;
                
                showTitlebarLoading('limpando cache do War Thunder...');
                
                const result = await window.electronAPI.clearWarThunderCache();
                
                if (result.success) {
                    let message = result.message || 'Cache do WarThunder apagado com sucesso!';
                    
                    if (isToggled) {
                        // Aguardar para garantir que a limpeza foi concluída
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const guidResult = await window.electronAPI.resetMachineGUID();
                        
                        // Aguardar entre operações críticas
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        const macResult = await resetMacAddressInternal();
                        
                        // Atualizar displays
                        if (macResult.success) {
                            const macElement = document.getElementById('currentMac');
                            if (macElement) {
                                macElement.textContent = `MAC Address: ${macResult.newMac}`;
                            }
                        }
                        if (guidResult.success) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            const newGuidResult = await window.electronAPI.getMachineGUID();
                            const guidElement = document.getElementById('currentMachineGuid');
                            if (guidElement && newGuidResult.success) {
                                guidElement.textContent = `${newGuidResult.guid}`;
                            }
                        }
                    }
                    
                    // Atualizar badge para indicar que cache está limpo
                    const cacheBtn = document.querySelector('[data-cache-btn="warthunder"]');
                    if (cacheBtn) {
                        showCacheSuccessBadge(cacheBtn);
                        cacheBtn.setAttribute('data-cache-status', 'clean');
                    }
                    
                    showCustomAlert(message);
                } else {
                    showCustomAlert(result.error || 'Falha ao apagar cache do WarThunder.');
                }
            } catch (error) {
                console.error('Erro durante limpeza:', error);
                showCustomAlert('Erro durante a operação: ' + error.message);
            } finally {
                // Sempre desbloquear, mesmo em caso de erro
                isCacheOperationInProgress = false;
                restoreTitlebarStats();
            }
        }
    );
}

async function clearMiHoYoCache() {
    // Verificar se já existe uma operação em andamento
    if (isCacheOperationInProgress) {
        showCustomAlert('Aguarde a operação anterior ser concluída.');
        return;
    }
    
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    const isToggled = cacheToggleStates.mihoyo || false;
    
    // Verificar se o toggle está ativo e se nenhum adaptador foi selecionado
    if (isToggled && !selectedNetworkAdapter) {
        showCustomAlert('Por favor, selecione um adaptador de rede primeiro antes de limpar o cache com reset de MAC.');
        // Aguardar o usuário fechar o alert e então abrir o selecionador
        setTimeout(async () => {
            await selectNetworkAdapter({ stopPropagation: () => {} });
        }, 300);
        return;
    }
    
    showCustomConfirm(
        'Isso irá executar o arquivo de limpeza do cache da MiHoYo. Continuar?',
        async () => {
            try {
                // Bloquear novas operações
                isCacheOperationInProgress = true;
                
                showTitlebarLoading('limpando cache da MiHoYo...');
                
                const result = await window.electronAPI.clearMiHoYoCache();
                
                if (result.success) {
                    let message = 'Cache da MiHoYo limpo com sucesso!';
                    
                    if (isToggled) {
                        // Aguardar para garantir que a limpeza foi concluída
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const guidResult = await window.electronAPI.resetMachineGUID();
                        
                        // Aguardar entre operações críticas
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        const macResult = await resetMacAddressInternal();
                        
                        // Atualizar displays
                        if (macResult.success) {
                            const macElement = document.getElementById('currentMac');
                            if (macElement) {
                                macElement.textContent = `MAC Address: ${macResult.newMac}`;
                            }
                        }
                        if (guidResult.success) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            const newGuidResult = await window.electronAPI.getMachineGUID();
                            const guidElement = document.getElementById('currentMachineGuid');
                            if (guidElement && newGuidResult.success) {
                                guidElement.textContent = `${newGuidResult.guid}`;
                            }
                        }
                    }
                    
                    // Atualizar badge para indicar que cache está limpo
                    const cacheBtn = document.querySelector('[data-cache-btn="mihoyo"]');
                    if (cacheBtn) {
                        showCacheSuccessBadge(cacheBtn);
                        cacheBtn.setAttribute('data-cache-status', 'clean');
                    }
                    
                    showCustomAlert(message);
                } else {
                    showCustomAlert('Erro: ' + (result.error || 'Arquivo não encontrado'));
                }
            } catch (error) {
                console.error('Erro durante limpeza:', error);
                showCustomAlert('Erro durante a operação: ' + error.message);
            } finally {
                // Sempre desbloquear, mesmo em caso de erro
                isCacheOperationInProgress = false;
                restoreTitlebarStats();
            }
        }
    );
}

async function clearEndfieldCache() {
    // Verificar se já existe uma operação em andamento
    if (isCacheOperationInProgress) {
        showCustomAlert('Aguarde a operação anterior ser concluída.');
        return;
    }
    
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    const isToggled = cacheToggleStates.endfield || false;
    
    // Verificar se o toggle está ativo e se nenhum adaptador foi selecionado
    if (isToggled && !selectedNetworkAdapter) {
        showCustomAlert('Por favor, selecione um adaptador de rede primeiro antes de limpar o cache com reset de MAC.');
        // Aguardar o usuário fechar o alert e então abrir o selecionador
        setTimeout(async () => {
            await selectNetworkAdapter({ stopPropagation: () => {} });
        }, 300);
        return;
    }
    
    showCustomConfirm(
        'Isso irá limpar completamente o cache do Arknights: Endfield. Continuar?',
        async () => {
            try {
                // Bloquear novas operações
                isCacheOperationInProgress = true;
                
                showTitlebarLoading('limpando cache do Endfield...');
                
                const result = await window.electronAPI.clearEndfieldCache();
                
                if (result.success) {
                    let message = 'Cache do Endfield limpo com sucesso!';
                    
                    if (isToggled) {
                        // Aguardar para garantir que a limpeza foi concluída
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        const guidResult = await window.electronAPI.resetMachineGUID();
                        
                        // Aguardar entre operações críticas
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        const macResult = await resetMacAddressInternal();
                        
                        // Atualizar displays
                        if (macResult.success) {
                            const macElement = document.getElementById('currentMac');
                            if (macElement) {
                                macElement.textContent = `MAC Address: ${macResult.newMac}`;
                            }
                        }
                        if (guidResult.success) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            const newGuidResult = await window.electronAPI.getMachineGUID();
                            const guidElement = document.getElementById('currentMachineGuid');
                            if (guidElement && newGuidResult.success) {
                                guidElement.textContent = `${newGuidResult.guid}`;
                            }
                        }
                    }
                    
                    // Atualizar badge para indicar que cache está limpo
                    const cacheBtn = document.querySelector('[data-cache-btn="endfield"]');
                    if (cacheBtn) {
                        showCacheSuccessBadge(cacheBtn);
                        cacheBtn.setAttribute('data-cache-status', 'clean');
                    }
                    
                    showCustomAlert(message);
                } else {
                    showCustomAlert('Erro: ' + (result.error || 'Falha na limpeza'));
                }
            } catch (error) {
                console.error('Erro durante limpeza:', error);
                showCustomAlert('Erro durante a operação: ' + error.message);
            } finally {
                // Sempre desbloquear, mesmo em caso de erro
                isCacheOperationInProgress = false;
                restoreTitlebarStats();
            }
        }
    );
}

// Estados dos toggles
let cacheToggleStates = {
    warthunder: false,
    mihoyo: false,
    endfield: false
};

// Adaptador de rede selecionado
let selectedNetworkAdapter = null;

// Flag para prevenir execuções simultâneas de limpeza
let isCacheOperationInProgress = false;

function toggleResetOnCache(event, game) {
    event.stopPropagation();
    const btn = event.currentTarget;
    btn.classList.toggle('active');
    cacheToggleStates[game] = btn.classList.contains('active');
    saveData();
    
    // Forçar atualização do efeito de hover
    const cacheBtn = btn.closest('[data-cache-btn]');
    if (cacheBtn) {
        const utilitiesDropdown = document.getElementById('utilitiesDropdown');
        const guidBtn = utilitiesDropdown.querySelector('[data-system-btn="guid"]');
        const macBtn = utilitiesDropdown.querySelector('[data-system-btn="mac"]');
        
        if (!btn.classList.contains('active')) {
            // Se desativou, remover efeitos imediatamente
            if (guidBtn) {
                guidBtn.classList.remove('shake', 'highlighted');
            }
            if (macBtn) {
                macBtn.classList.remove('shake', 'highlighted');
            }
            
            const guidLine = document.getElementById('guidLine');
            const macLine = document.getElementById('macLine');
            if (guidLine) guidLine.setAttribute('opacity', '0');
            if (macLine) macLine.setAttribute('opacity', '0');
        } else {
            // Se ativou, aplicar efeitos
            const mouseOverEvent = new MouseEvent('mouseenter', { bubbles: true });
            cacheBtn.dispatchEvent(mouseOverEvent);
        }
    }
}

async function resetMacAddress() {
    // Verificar se há uma operação de limpeza em andamento
    if (isCacheOperationInProgress) {
        showCustomAlert('Aguarde a operação de limpeza de cache ser concluída.');
        return;
    }
    
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    // VERIFICAÇÃO CRÍTICA: Adaptador DEVE estar manualmente selecionado
    if (!selectedNetworkAdapter) {
        showCustomAlert('Por favor, selecione um adaptador de rede primeiro.');
        setTimeout(async () => {
            await selectNetworkAdapter({ stopPropagation: () => {} });
        }, 300);
        return;
    }
    
    // Verificar se o adaptador ainda existe e é válido
    const adaptersResult = await window.electronAPI.listNetworkAdapters();
    if (adaptersResult.success && adaptersResult.adapters) {
        const currentAdapter = adaptersResult.adapters.find(a => a.Name === selectedNetworkAdapter);
        
        if (!currentAdapter) {
            showCustomAlert('O adaptador selecionado não está mais disponível. Por favor, selecione outro.');
            setTimeout(async () => {
                selectedNetworkAdapter = null; // Resetar seleção inválida
                await selectNetworkAdapter({ stopPropagation: () => {} });
            }, 300);
            return;
        }
        
        // Avisar se não é Ethernet/WiFi
        const isEthernetOrWifi = 
            currentAdapter.Name.toLowerCase().includes('ethernet') ||
            currentAdapter.Name.toLowerCase().includes('wi-fi') ||
            currentAdapter.Name.toLowerCase().includes('wifi') ||
            currentAdapter.InterfaceDescription.toLowerCase().includes('ethernet') ||
            currentAdapter.InterfaceDescription.toLowerCase().includes('wi-fi') ||
            currentAdapter.InterfaceDescription.toLowerCase().includes('wifi') ||
            currentAdapter.InterfaceDescription.toLowerCase().includes('wireless');
        
        if (!isEthernetOrWifi) {
            showCustomAlert('⚠️ Atenção: O adaptador selecionado não é Ethernet ou Wi-Fi.\n\nRecomendamos selecionar outro adaptador.');
            document.getElementById('adapterAlertBadge').style.display = 'block';
            setTimeout(async () => {
                await selectNetworkAdapter({ stopPropagation: () => {} });
            }, 300);
            return;
        }
    }
    
    showTitlebarLoading('trocando MAC Address...');
    
    const result = await resetMacAddressInternal();
    
    if (result.success) {
        // Atualizar o display do MAC no botão
        const macElement = document.getElementById('currentMac');
        if (macElement) {
            macElement.textContent = `MAC Address: ${result.newMac}`;
        }
        
        showCustomAlert(`MAC Address alterado com sucesso!\n\nNovo MAC: ${result.newMac}\nAdaptador: ${selectedNetworkAdapter}`);
    } else {
        showCustomAlert('Erro: ' + (result.error || 'Falha ao alterar MAC'));
    }
    
    restoreTitlebarStats();
}

async function resetMacAddressInternal() {
    // NUNCA selecionar automaticamente - retornar erro
    if (!selectedNetworkAdapter) {
        return { success: false, error: 'Nenhum adaptador foi selecionado manualmente' };
    }
    
    return await window.electronAPI.resetMacAddress(selectedNetworkAdapter);
}

async function selectNetworkAdapter(event) {
    event.stopPropagation();
    
    // Fechar o painel de utilidades
    const utilitiesDropdown = document.getElementById('utilitiesDropdown');
    if (utilitiesDropdown) {
        utilitiesDropdown.style.display = 'none';
    }
    
    const adaptersResult = await window.electronAPI.listNetworkAdapters();
    
    if (!adaptersResult.success || !adaptersResult.adapters || adaptersResult.adapters.length === 0) {
        showCustomAlert('Nenhum adaptador de rede ativo encontrado.');
        return;
    }
    
    const overlay = document.getElementById('customModalOverlay');
    const modalTitle = document.getElementById('customModalTitle');
    const modalMessage = document.getElementById('customModalMessage');
    const modalButtons = document.getElementById('customModalButtons');
    
    modalTitle.textContent = 'Selecionar Adaptador de Rede';
    
    let adaptersHTML = '<div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">';
    adaptersHTML += '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 8px;">Selecione o adaptador de rede principal:</div>';
    
    adaptersResult.adapters.forEach((adapter, index) => {
        const isSelected = selectedNetworkAdapter === adapter.Name;
        
        // Verificar se é Ethernet ou Wifi
        const isEthernetOrWifi = 
            adapter.Name.toLowerCase().includes('ethernet') ||
            adapter.Name.toLowerCase().includes('wi-fi') ||
            adapter.Name.toLowerCase().includes('wifi') ||
            adapter.InterfaceDescription.toLowerCase().includes('ethernet') ||
            adapter.InterfaceDescription.toLowerCase().includes('wi-fi') ||
            adapter.InterfaceDescription.toLowerCase().includes('wifi') ||
            adapter.InterfaceDescription.toLowerCase().includes('wireless');
        
        // Cores diferentes para adaptadores não-prioritários
        const bgColor = isSelected ? 'rgba(16, 163, 127, 0.1)' : (isEthernetOrWifi ? '#1a1a1a' : '#0f0f10');
        const borderColor = isSelected ? 'rgba(16, 163, 127, 0.5)' : (isEthernetOrWifi ? '#262626' : '#1a1a1a');
        const textOpacity = isEthernetOrWifi ? '1' : '0.4';
        
        adaptersHTML += `
            <div class="adapter-item ${isSelected ? 'selected' : ''}" onclick="selectAdapter('${adapter.Name}')" style="
                padding: 10px;
                margin: 6px 0;
                background: ${bgColor};
                border: 1px solid ${borderColor};
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
                opacity: ${textOpacity};
            " onmouseover="if (!this.classList.contains('selected')) { this.style.background='#1f1f1f'; this.style.borderColor='#374151'; this.style.opacity='1'; }" 
               onmouseout="if (!this.classList.contains('selected')) { this.style.background='${bgColor}'; this.style.borderColor='${borderColor}'; this.style.opacity='${textOpacity}'; }">
                <div style="font-size: 13px; font-weight: 500; color: #e4e4e7; margin-bottom: 4px;">
                    ${adapter.Name}
                    ${!isEthernetOrWifi ? '<span style="font-size: 10px; color: #fbbf24; margin-left: 6px;">⚠️ Não recomendado</span>' : ''}
                </div>
                <div style="font-size: 11px; color: #6b7280;">${adapter.InterfaceDescription}</div>
                <div style="font-size: 10px; color: #10a37f; margin-top: 2px;">MAC: ${adapter.MacAddress}</div>
            </div>
        `;
    });
    
    adaptersHTML += '</div>';
    
    modalMessage.innerHTML = adaptersHTML;
    
    modalButtons.innerHTML = `
        <button class="custom-modal-btn custom-modal-btn-cancel" onclick="closeCustomModal()">Fechar</button>
    `;
    
    overlay.classList.add('active');
}

function selectAdapter(adapterName) {
    selectedNetworkAdapter = adapterName;
    
    // Remover badge de alerta
    const badge = document.getElementById('adapterAlertBadge');
    if (badge) badge.style.display = 'none';
    
    // Atualizar visual dos itens
    document.querySelectorAll('.adapter-item').forEach(item => {
        item.classList.remove('selected');
        item.style.background = '#1a1a1a';
        item.style.borderColor = '#262626';
    });
    
    const selectedItem = event.target.closest('.adapter-item');
    if (selectedItem) {
        selectedItem.classList.add('selected');
        selectedItem.style.background = 'rgba(16, 163, 127, 0.1)';
        selectedItem.style.borderColor = 'rgba(16, 163, 127, 0.5)';
    }
    
    // Salvar dados
    saveData();
    
    setTimeout(() => {
        showCustomAlert(`Adaptador selecionado: ${adapterName}`);
        closeCustomModal();
    }, 200);
}

async function resetBoth() {
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    // VERIFICAÇÃO CRÍTICA: Adaptador DEVE estar manualmente selecionado
    if (!selectedNetworkAdapter) {
        showCustomAlert('Por favor, selecione um adaptador de rede primeiro.');
        setTimeout(async () => {
            await selectNetworkAdapter({ stopPropagation: () => {} });
        }, 300);
        return;
    }
    
    showCustomConfirm(
        'Isso irá resetar o Machine GUID e o MAC Address. Continuar?',
        async () => {
            const guidResult = await window.electronAPI.resetMachineGUID();
            const macResult = await resetMacAddressInternal();
            
            if (guidResult.success && macResult.success) {
                // Atualizar displays
                await new Promise(resolve => setTimeout(resolve, 1000));
                const newGuidResult = await window.electronAPI.getMachineGUID();
                const newGuid = newGuidResult.success ? newGuidResult.guid : 'não disponível';
                
                const guidElement = document.getElementById('currentMachineGuid');
                if (guidElement && newGuidResult.success) {
                    guidElement.textContent = `${newGuid}`;
                }
                
                const macElement = document.getElementById('currentMac');
                if (macElement) {
                    macElement.textContent = `MAC Address: ${macResult.newMac}`;
                }
                
                showCustomAlert(`Resetados com sucesso!\n\nNovo GUID: ${newGuid}\nNovo MAC: ${macResult.newMac}`);
            } else if (guidResult.success) {
                showCustomAlert('Machine GUID resetado com sucesso, mas houve erro ao resetar MAC Address.');
            } else if (macResult.success) {
                showCustomAlert('MAC Address resetado com sucesso, mas houve erro ao resetar Machine GUID.');
            } else {
                showCustomAlert('Erro ao executar ambas as operações.');
            }
        }
    );
}

async function resetSecondaryIds() {
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    showCustomConfirm(
        'Isso irá resetar os IDs secundários (HwProfileGuid, SusClientId, SusClientIDValidation). Continuar?',
        async () => {
            showTitlebarLoading('resetando IDs secundários...');
            
            const result = await window.electronAPI.resetSecondaryIds();
            
            if (result.success) {
                showCustomAlert('IDs secundários resetados com sucesso!');
            } else {
                showCustomAlert('Erro: ' + (result.error || 'Operação cancelada ou sem permissão'));
            }
            
            restoreTitlebarStats();
        }
    );
}

async function clearKameleoCache() {
    // Verificar se já existe uma operação em andamento
    if (isCacheOperationInProgress) {
        showCustomAlert('Aguarde a operação anterior ser concluída.');
        return;
    }
    
    const dropdown = document.getElementById('utilitiesDropdown');
    dropdown.style.display = 'none';
    
    // VERIFICAÇÃO CRÍTICA: Adaptador DEVE estar manualmente selecionado ANTES DE TUDO
    if (!selectedNetworkAdapter) {
        showCustomAlert('Por favor, selecione um adaptador de rede primeiro.');
        setTimeout(async () => {
            await selectNetworkAdapter({ stopPropagation: () => {} });
        }, 300);
        return;
    }
    
    // Obter caminho da pasta de utilidades para exibir na confirmação
    const savesPath = currentSavePath.split(/[\\/]/).slice(0, -1).join('\\');
    const utilitiesPath = `${savesPath}\\utilidades`;
    
    showCustomConfirm(
        `ATENÇÃO:

O limite de sua conta atual NÃO será resetado! A limpeza de cache do Kameleo apenas permitirá que você utilize outra conta.

Você deve criar uma nova conta no site do Kameleo antes de prosseguir: 
    https://login.kameleo.io/Account/Register

Ao prosseguir, essa operação irá:

• Fechar o Kameleo
• Deletar cache do Kameleo
• Resetar alguns IDs do sistema
• Resetar Machine GUID
• Resetar MAC Address


Backups serão criados automaticamente em:
${utilitiesPath}`,
        async () => {
            try {
                // Bloquear novas operações
                isCacheOperationInProgress = true;
                
                showTitlebarLoading('executando limpeza Kameleo...');
                
                // ETAPA 1: Limpeza de cache Kameleo
                const cacheResult = await window.electronAPI.clearKameleoCache();
                
                if (!cacheResult.success) {
                    showCustomAlert('Erro na limpeza: ' + (cacheResult.error || 'Desconhecido'));
                    return;
                }
                
                // Aguardar processamento
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // ETAPA 2: Resetar Machine GUID
                showTitlebarLoading('resetando Machine GUID...');
                const guidResult = await window.electronAPI.resetMachineGUID();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ETAPA 3: Resetar MAC Address
                showTitlebarLoading('resetando MAC Address...');
                const macResult = await resetMacAddressInternal();
                
                // Aguardar tudo processar
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Atualizar displays
                if (guidResult.success) {
                    const newGuidResult = await window.electronAPI.getMachineGUID();
                    const guidElement = document.getElementById('currentMachineGuid');
                    if (guidElement && newGuidResult.success) {
                        guidElement.textContent = `${newGuidResult.guid}`;
                    }
                }
                
                if (macResult.success) {
                    const macElement = document.getElementById('currentMac');
                    if (macElement) {
                        macElement.textContent = `MAC Address: ${macResult.newMac}`;
                    }
                }
                
                showCustomAlert(`Limpeza Kameleo concluída com sucesso!\n\nBackups criados em:\n${utilitiesPath}`);
            } catch (error) {
                console.error('Erro durante limpeza Kameleo:', error);
                showCustomAlert('Erro durante a operação: ' + error.message);
            } finally {
                // Sempre desbloquear
                isCacheOperationInProgress = false;
                restoreTitlebarStats();
            }
        }
    );
}

async function createSaveDropdown() {
    const dropdown = document.createElement('div');
    dropdown.id = 'saveDropdown';
    dropdown.className = 'save-dropdown active';
    dropdown.style.cssText = `
        position: fixed;
        top: 52px;
        right: 50px;
        background: #1f1f1f;
        border: 1px solid #262626;
        border-radius: 6px;
        padding: 8px;
        min-width: 280px;
        max-height: calc(100vh - 60px);
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        z-index: 10001;
    `;
    dropdown.onclick = (e) => e.stopPropagation();
    
    document.body.appendChild(dropdown);
    
    saveDropdownActive = true;
    await loadSavesList();
}

async function loadSavesList() {
    const dropdown = document.getElementById('saveDropdown');
    if (!dropdown) return;
    
    const saves = await window.electronAPI.listSaves();
    const currentFileName = currentSavePath.split(/[\\/]/).pop();
    
dropdown.innerHTML = `
    <div style="padding: 4px; border-bottom: 1px solid #262626; margin-bottom: 8px; display: flex; flex-direction: column; gap: 4px;">
                <button class="btn-action" onclick="createNewSavePrompt()" style="width: 100%; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Criar novo save
                </button>
                <button class="btn-action" onclick="openSavesFolder()" style="width: 100%; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Abrir local da pasta
                </button>
            </div>
        <div class="save-dropdown-section">
            <div class="save-dropdown-header">
                <div class="save-dropdown-title">Saves disponíveis</div>
                <button class="btn-restore-backup" onclick="toggleBackupDropdown(event)">
                    Restaurar backup →
                </button>
            </div>
            <div id="savesListContainer"></div>
        </div>
    `;
    
    const container = document.getElementById('savesListContainer');
    
    if (saves.normal && saves.normal.length > 0) {
        saves.normal.forEach(save => {
            const isActive = save === currentFileName;
            const item = document.createElement('div');
            item.className = 'save-dropdown-item' + (isActive ? ' active' : '');
            item.innerHTML = `
                <span>${save}</span>
                ${isActive ? '<span class="save-dropdown-badge">ATIVO</span>' : ''}
            `;
            item.onclick = () => isActive ? null : switchToSave(save);
            container.appendChild(item);
        });
    } else {
        container.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 8px; font-size: 11px;">Nenhum save encontrado</div>';
    }
}

async function toggleBackupDropdown(event) {
    event.stopPropagation();
    let backupDropdown = document.getElementById('backupDropdown');
    
    // Criar dropdown se não existir
    if (!backupDropdown) {
        backupDropdown = document.createElement('div');
        backupDropdown.id = 'backupDropdown';
        backupDropdown.className = 'save-dropdown';
        backupDropdown.style.cssText = `
            position: fixed;
            top: 52px;
            right: 340px;
            background: #1f1f1f;
            border: 1px solid #262626;
            border-radius: 6px;
            padding: 8px;
            min-width: 280px;
            max-height: calc(100vh - 60px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 10001;
        `;
        backupDropdown.onclick = (e) => e.stopPropagation();
        
        document.body.appendChild(backupDropdown);
    }
    
    backupDropdown.classList.toggle('active');
    
    if (backupDropdown.classList.contains('active')) {
        try {
            const saves = await window.electronAPI.listSaves();
            
            if (saves.backups && saves.backups.length > 0) {
                backupDropdown.innerHTML = `
                    <div class="save-dropdown-section">
                        <div class="save-dropdown-title" style="padding: 0 8px 8px 8px;">Backups disponíveis (${saves.backups.length})</div>
                        ${saves.backups.map(backup => `
                            <div class="save-dropdown-item" onclick="restoreSaveFromBackup('${backup}')">
                                <span>${backup}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                backupDropdown.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 12px; font-size: 11px;">Nenhum backup encontrado</div>';
            }
        } catch (error) {
            console.error('Erro ao carregar backups:', error);
            backupDropdown.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 12px; font-size: 11px;">Erro ao carregar backups</div>';
        }
    }
}

async function switchToSave(fileName) {
    const result = await window.electronAPI.switchSave(fileName);
    
    if (result.success && result.data) {
        currentSavePath = result.path;
        const migrated = migrateData(result.data);
        sections = migrated.sections || [];
        folders = migrated.folders || [];
        tabLayout = migrated.tabLayout || false;
        hideReturnsAbove = migrated.hideReturnsAbove !== undefined ? migrated.hideReturnsAbove : 1;
        hideHighlightedAbove = migrated.hideHighlightedAbove !== undefined ? migrated.hideHighlightedAbove : 6;
        currentPeriodDays = migrated.currentPeriodDays !== undefined ? migrated.currentPeriodDays : 30;
        
        // Carregar estados de toggle e adaptador
        if (migrated.cacheToggleStates) {
            cacheToggleStates = migrated.cacheToggleStates;
        }
        if (migrated.selectedNetworkAdapter) {
            selectedNetworkAdapter = migrated.selectedNetworkAdapter;
            // Esconder badge se adaptador está selecionado
            const badge = document.getElementById('adapterAlertBadge');
            if (badge) badge.style.display = 'none';
        } else {
            // Mostrar badge se não está selecionado
            const badge = document.getElementById('adapterAlertBadge');
            if (badge) badge.style.display = 'flex';
        }
        
        // Atualizar label do período
        const label = currentPeriodDays === -1 ? 'Total' : (currentPeriodDays === 1 ? 'último dia' : `últimos ${currentPeriodDays} dias`);
        const oldPeriodBtn = document.getElementById('periodBtn');
        if (oldPeriodBtn) {
            oldPeriodBtn.innerHTML = `
                <span style="text-transform: uppercase; letter-spacing: 0.5px;">Exibindo dados de</span>
                <span class="summary-period-value">${label} ▼</span>
            `;
        }
        const titlebarPeriodText = document.getElementById('titlebarPeriodText');
        if (titlebarPeriodText) {
            titlebarPeriodText.textContent = label;
        }
        
        // Atualizar classe active nos itens do dropdown
        document.querySelectorAll('.period-item').forEach(item => {
            item.classList.remove('active');
        });
        const activeItem = document.querySelector(`.period-item[data-days="${currentPeriodDays}"]`);
        if (activeItem) activeItem.classList.add('active');
        
        // Resetar activeTabIndex para uma aba válida
        if (tabLayout) {
            const visibleTabs = sections.map((s, i) => i).filter(i => !folders.includes(i));
            activeTabIndex = visibleTabs.length > 0 ? visibleTabs[0] : 0;
        }
        
        const hideReturnsEl = document.getElementById('hideReturnsAbove');
        const hideHighlightedEl = document.getElementById('hideHighlightedAbove');
        if (hideReturnsEl) hideReturnsEl.value = hideReturnsAbove === 1 ? '1 retorno' : hideReturnsAbove + ' retornos';
        if (hideHighlightedEl) hideHighlightedEl.value = hideHighlightedAbove === 1 ? '1 retorno' : hideHighlightedAbove + ' retornos';
        
        // Atualizar nome do save na UI
        updateSaveUI();
        
        // Atualizar interface de tabs
        const tabsHeader = document.getElementById('tabsHeader');
        const container = document.querySelector('.container');
        const actionsDiv = document.querySelector('.actions');
        
        if (tabLayout) {
            const layoutBtnText = document.getElementById('layoutBtnText');
            if (layoutBtnText) layoutBtnText.textContent = '☷ Modo Lista';
            
            // Atualizar ícone na titlebar
            const titlebarLayoutIcon = document.getElementById('titlebarLayoutIcon');
            if (titlebarLayoutIcon) {
                titlebarLayoutIcon.innerHTML = `
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                `;
            }
            
            if (container) container.classList.add('tabs-mode');
            document.body.classList.add('tabs-mode');
            if (tabsHeader) tabsHeader.style.display = 'flex';
            if (actionsDiv) actionsDiv.style.display = 'none';
        } else {
            const layoutBtnText = document.getElementById('layoutBtnText');
            if (layoutBtnText) layoutBtnText.textContent = '☰ Modo Abas';
            
            // Atualizar ícone na titlebar
            const titlebarLayoutIcon = document.getElementById('titlebarLayoutIcon');
            if (titlebarLayoutIcon) {
                titlebarLayoutIcon.innerHTML = `
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                `;
            }
            
            if (container) container.classList.remove('tabs-mode');
            document.body.classList.remove('tabs-mode');
            if (tabsHeader) tabsHeader.style.display = 'none';
            if (actionsDiv) actionsDiv.style.display = 'flex';
        }
        
        renderSections();
        updateReturnsPanel();
        updateSummary();
        
        const dropdown = document.getElementById('saveDropdown');
        if (dropdown) dropdown.classList.remove('active');
        saveDropdownActive = false;
    } else {
        showCustomAlert('Erro ao carregar save: ' + (result.error || 'Desconhecido'));
    }
}

async function restoreSaveFromBackup(fileName) {
    const result = await window.electronAPI.restoreBackup(fileName);
    
    if (result.success && result.data) {
        currentSavePath = result.path;
        const migrated = migrateData(result.data);
        sections = migrated.sections || [];
        folders = migrated.folders || [];
        tabLayout = migrated.tabLayout || false;
        hideReturnsAbove = migrated.hideReturnsAbove !== undefined ? migrated.hideReturnsAbove : 1;
        hideHighlightedAbove = migrated.hideHighlightedAbove !== undefined ? migrated.hideHighlightedAbove : 6;
        currentPeriodDays = migrated.currentPeriodDays !== undefined ? migrated.currentPeriodDays : 30;
        overrideEnabled = migrated.overrideEnabled || false;
        overrideHowMany = migrated.overrideHowMany !== undefined ? migrated.overrideHowMany : 5;
        overrideEveryX = migrated.overrideEveryX !== undefined ? migrated.overrideEveryX : 10;
        overrideReturnsCount = migrated.overrideReturnsCount !== undefined ? migrated.overrideReturnsCount : 2;
        
        // Resetar activeTabIndex para uma aba válida
        if (tabLayout) {
            const visibleTabs = sections.map((s, i) => i).filter(i => !folders.includes(i));
            activeTabIndex = visibleTabs.length > 0 ? visibleTabs[0] : 0;
        }
        
        // Atualizar UI completa
        updateAllUI();
        updateSaveUI();
        
        const dropdown = document.getElementById('saveDropdown');
        if (dropdown) dropdown.classList.remove('active');
        const backupDropdown = document.getElementById('backupDropdown');
        if (backupDropdown) backupDropdown.classList.remove('active');
        saveDropdownActive = false;
        
        showCustomAlert(`Backup restaurado como: ${result.fileName}`);
    } else {
        showCustomAlert('Erro ao restaurar backup: ' + (result.error || 'Desconhecido'));
    }
}

document.addEventListener('click', () => {
    const dropdown = document.getElementById('saveDropdown');
    if (dropdown && saveDropdownActive) {
        dropdown.classList.remove('active');
        saveDropdownActive = false;
    }
    
    const backupDropdown = document.getElementById('backupDropdown');
    if (backupDropdown && backupDropdown.classList.contains('active')) {
        backupDropdown.classList.remove('active');
    }
});


        function migrateData(data) {
            if (Array.isArray(data)) {
                return {
                    sections: data.map(s => ({
                        ...s,
                        dateGroups: (s.dateGroups || []).map(dg => ({
                            ...dg,
                            accounts: (dg.accounts || []).map(acc => ({
                                ...acc,
                                returns: acc.returns !== undefined ? acc.returns : 0,
                                highlightLevel: acc.highlightLevel || 0,
                                lastReturnDate: acc.lastReturnDate || null,
                                skipReturn: acc.skipReturn || false
                            }))
                        }))
                    })),
                    folders: [],
                    tabLayout: false,
                    hideReturnsAbove: 1,
                    hideHighlightedAbove: 6
                };
            }
            
            return {
                sections: (data.sections || []).map(s => ({
                    ...s,
                    dateGroups: (s.dateGroups || []).map(dg => ({
                        ...dg,
                        accounts: (dg.accounts || []).map(acc => ({
                            ...acc,
                            returns: acc.returns !== undefined ? acc.returns : 0,
                            highlightLevel: acc.highlightLevel || 0,
                            lastReturnDate: acc.lastReturnDate || null,
                            skipReturn: acc.skipReturn || false
                        }))
                    }))
                })),
                folders: data.folders || [],
                tabLayout: data.tabLayout || false,
                hideReturnsAbove: data.hideReturnsAbove !== undefined ? data.hideReturnsAbove : 1,
                hideHighlightedAbove: data.hideHighlightedAbove !== undefined ? data.hideHighlightedAbove : 6,
                currentPeriodDays: data.currentPeriodDays !== undefined ? data.currentPeriodDays : 30,
                cacheToggleStates: data.cacheToggleStates || { warthunder: false, mihoyo: false, endfield: false },
                selectedNetworkAdapter: data.selectedNetworkAdapter || null
            };
        }

        function createNewSection() {
            return {
                url: '',
                value: 0,
                number: '',
                returnDays: 5,
                color: COLORS[0],
                collapsed: false,
                dateGroups: []
            };
        }

async function saveData() {
    console.log('Salvando dados...');
    
    const data = {
        sections,
        folders,
        tabLayout,
        hideReturnsAbove,
        hideHighlightedAbove,
        activeTabIndex,
        overrideEnabled,
        overrideHowMany,
        overrideEveryX,
        overrideReturnsCount,
        currentPeriodDays,
        cacheToggleStates,
        selectedNetworkAdapter
    };
    
    try {
        await window.electronAPI.saveData(data);
        console.log('Dados salvos');
    } catch (error) {
        console.error('Erro ao salvar dados:', error);
    }
    
    if (!isUndoRedoAction) {
        updateSummary();
    }
}

        function saveState() {
            if (!isUndoRedoAction) {
                undoStack.push(JSON.stringify({
                    sections: sections
                }));
                if (undoStack.length > 50) undoStack.shift();
                redoStack = [];
                updateUndoRedoButtons();
            }
        }

        function undo() {
            if (undoStack.length === 0) return;
            isUndoRedoAction = true;
            redoStack.push(JSON.stringify({
                sections: sections
            }));
            const state = JSON.parse(undoStack.pop());
            sections = state.sections;
            saveData();
            renderSections();
            updateReturnsPanel();
            updateUndoRedoButtons();
            isUndoRedoAction = false;
        }

        function redo() {
            if (redoStack.length === 0) return;
            isUndoRedoAction = true;
            undoStack.push(JSON.stringify({
                sections: sections
            }));
            const state = JSON.parse(redoStack.pop());
            sections = state.sections;
            saveData();
            renderSections();
            updateReturnsPanel();
            updateUndoRedoButtons();
            isUndoRedoAction = false;
        }

        function updateUndoRedoButtons() {
            const oldUndoBtn = document.getElementById('undoBtn');
            const oldRedoBtn = document.getElementById('redoBtn');
            const titlebarUndoBtn = document.getElementById('titlebarUndoBtn');
            const titlebarRedoBtn = document.getElementById('titlebarRedoBtn');
            
            const undoDisabled = undoStack.length === 0;
            const redoDisabled = redoStack.length === 0;
            
            if (oldUndoBtn) oldUndoBtn.disabled = undoDisabled;
            if (oldRedoBtn) oldRedoBtn.disabled = redoDisabled;
            if (titlebarUndoBtn) titlebarUndoBtn.disabled = undoDisabled;
            if (titlebarRedoBtn) titlebarRedoBtn.disabled = redoDisabled;
        }

        function addDays(dateStr, days) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }

        function getCurrentTime() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            return `${hours}:${minutes} ${ampm}`;
        }

function toggleTabLayout() {
            tabLayout = !tabLayout;
            const oldLayoutBtn = document.getElementById('layoutBtnText');
            if (oldLayoutBtn) {
                oldLayoutBtn.textContent = tabLayout ? '☷ Modo Lista' : '☰ Modo Abas';
            }

            const container = document.querySelector('.container');
            const tabsHeader = document.getElementById('tabsHeader');
            const actionsDiv = document.querySelector('.actions');
            
            if (tabLayout) {
                container.classList.add('tabs-mode');
                document.body.classList.add('tabs-mode');
                tabsHeader.style.display = 'flex';
                actionsDiv.style.display = 'none';
            } else {
                container.classList.remove('tabs-mode');
                document.body.classList.remove('tabs-mode');
                tabsHeader.style.display = 'none';
                actionsDiv.style.display = 'flex';
            }
            
            saveData();
            renderSections();
            updateReturnsPanel();
            
            // Verificar estado do sticky após alternar modo
            setTimeout(() => {
                if (typeof handleTabsScroll === 'function') {
                    handleTabsScroll();
                }
            }, 100);
        }

        function switchTab(index) {
            activeTabIndex = index;
            renderSections();
        }

        function toggleSection(sectionIndex) {
            saveState();
            sections[sectionIndex].collapsed = !sections[sectionIndex].collapsed;
            saveData();
            renderSections();
        }

        function toggleDateGroup(sectionIndex, dateGroupIndex) {
            saveState();
            sections[sectionIndex].dateGroups[dateGroupIndex].collapsed = 
                !sections[sectionIndex].dateGroups[dateGroupIndex].collapsed;
            saveData();
            renderSections();
        }

function toggleColorPicker(sectionIndex, event) {
    event.stopPropagation();
    const picker = document.getElementById(`color-picker-${sectionIndex}`);
    const allPickers = document.querySelectorAll('.color-picker');
    allPickers.forEach(p => {
        if (p !== picker) p.classList.remove('active');
    });
    picker.classList.toggle('active');
}

        function setColor(sectionIndex, color, event) {
            event.stopPropagation();
            saveState();
            sections[sectionIndex].color = color;
            
            // Atualizar preview principal
            const mainPreview = document.getElementById(`color-preview-main-${sectionIndex}`);
            if (mainPreview) {
                mainPreview.style.background = color;
            }
            
            saveData();
            renderSections();
        }

function updateColorFromSlider(sectionIndex, event) {
    const rect = event.currentTarget.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const percent = Math.max(0, Math.min(1, x / rect.width));
    
    let color;
    
    // Primeiros 15% são cinzas
    if (percent <= 0.15) {
        const grays = ['#52525b', '#71717a', '#a1a1aa', '#3f3f46'];
        const grayIndex = Math.floor((percent / 0.15) * grays.length);
        color = grays[Math.min(grayIndex, grays.length - 1)];
    } else {
        // Resto é arco-íris HSL
        const adjustedPercent = (percent - 0.15) / 0.85;
        const hue = Math.round(adjustedPercent * 360);
        color = `hsl(${hue}, 70%, 55%)`;
    }
    
    sections[sectionIndex].color = color;
    
    const indicator = document.getElementById(`color-indicator-${sectionIndex}`);
    if (indicator) {
        indicator.style.left = `${percent * 100}%`;
        indicator.style.background = color;
    }
    
    const preview = document.getElementById(`color-preview-large-${sectionIndex}`);
    if (preview) {
        preview.style.background = color;
    }
    
    // Função para converter qualquer cor para RGB
    function getRGBFromColor(color) {
        const tempEl = document.createElement('div');
        tempEl.style.color = color;
        document.body.appendChild(tempEl);
        const computedColor = window.getComputedStyle(tempEl).color;
        document.body.removeChild(tempEl);
        const match = computedColor.match(/\d+/g);
        return match ? { r: parseInt(match[0]), g: parseInt(match[1]), b: parseInt(match[2]) } : null;
    }
    
    const rgb = getRGBFromColor(color);
    
    // Atualizar a cor da seção visualmente sem re-renderizar tudo
    const sectionDiv = document.querySelector(`#section-${sectionIndex}`);
    if (sectionDiv && rgb) {
        sectionDiv.style.setProperty('--section-color', color);
        sectionDiv.style.setProperty('--section-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
        
        // Atualizar borda inferior da seção
        const sectionAfter = sectionDiv.querySelector('.section::after');
        if (sectionAfter) {
            sectionAfter.style.background = color;
        }
    }
    
    // Atualizar a cor da tab
    const tab = document.querySelector(`#tab-${sectionIndex}`);
    if (tab && rgb) {
        tab.style.setProperty('--section-color', color);
        tab.style.setProperty('--section-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
        const tabColor = tab.querySelector('.tab-color');
        if (tabColor) {
            tabColor.style.background = color;
        }
        
        // Atualizar tab-folder-badge se a tab for do tipo tab-from-folder
        const folderBadge = tab.querySelector('.tab-folder-badge');
        if (folderBadge) {
            folderBadge.style.setProperty('--section-color', color);
            folderBadge.style.setProperty('--section-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
        }
    }
    
    // Atualizar a bolinha de cor
    const colorBtn = sectionDiv?.querySelector('.section-color-btn');
    if (colorBtn) {
        colorBtn.style.background = color;
    }
    
    // Atualizar folder-item-color no dropdown se a seção estiver arquivada
    if (folders.includes(sectionIndex)) {
        const folderDropdown = document.getElementById('folderDropdown');
        if (folderDropdown) {
            const folderItems = folderDropdown.querySelectorAll('.folder-dropdown-item');
            folderItems.forEach(item => {
                const folderItemColor = item.querySelector('.folder-item-color');
                if (folderItemColor) {
                    // Verificar se este item corresponde à seção atual
                    const folderItemIndex = folders.indexOf(sectionIndex);
                    if (folderItemIndex !== -1 && item === folderItems[folderItemIndex]) {
                        folderItemColor.style.background = color;
                    }
                }
            });
        }
        
        // Atualizar tab-folder-btn se esta seção arquivada estiver ativa
        if (activeTabIndex === sectionIndex && rgb) {
            const folderBtn = document.querySelector('.tab-folder-btn');
            if (folderBtn) {
                folderBtn.style.setProperty('--active-folder-color', color);
                folderBtn.style.setProperty('--active-folder-glow', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`);
            }
        }
    }
    
    // Atualizar painel de retornos em tempo real
    updateReturnsPanel();
    
    // Atualizar também o dropdown de pastas globalmente (função window.updateFolderDropdown)
    if (window.updateFolderDropdown) {
        window.updateFolderDropdown();
    }
    
    // Salvar mas sem renderizar
    saveState();
    saveData();
}

        function copyToClipboard(text, event, buttonElement) {
            if (event) event.stopPropagation();
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    if (buttonElement) {
                        showCopyFeedback(buttonElement);
                    }
                }).catch(err => {
                    // Silenciosamente falhar sem popup
                    console.log('Erro ao copiar:', err);
                });
            }
        }

function copyUrlAndIPs(sectionIndex, event) {
    if (event) event.stopPropagation();
    
    const section = sections[sectionIndex];
    let text = section.url;
    
    const ips = new Set();
    section.dateGroups.forEach(dg => {
        dg.accounts.forEach(acc => {
            if (acc.ip && acc.ip.trim()) {
                ips.add(acc.ip.trim());
            }
        });
    });
    
    if (ips.size > 0) {
        text += '\n' + Array.from(ips).join('\n');
    }
    
    navigator.clipboard.writeText(text).then(() => {
        const buttonElement = event.target.closest('button');
        if (buttonElement) {
            showCopyFeedback(buttonElement);
        }
    });
}

function copyWorkingIPsFormatted(sectionIndex, event) {
            const section = sections[sectionIndex];
            const url = section.url || 'Sem URL';
            
            const groupedByDate = {};
            section.dateGroups.forEach(dateGroup => {
                const date = dateGroup.date1 || 'Sem data';
                const workingIPs = [];
                let workingCount = 0;
                let workingValue = 0;
                
                dateGroup.accounts.forEach(acc => {
                    if (acc.checked && acc.ip && acc.ip.trim()) {
                        workingIPs.push(acc.ip.trim());
                        workingCount++;
                        workingValue += section.value;
                    }
                });
                
                if (workingIPs.length > 0) {
                    if (!groupedByDate[date]) {
                        groupedByDate[date] = { ips: [], count: 0, value: 0 };
                    }
                    groupedByDate[date].ips.push(...workingIPs);
                    groupedByDate[date].count += workingCount;
                    groupedByDate[date].value += workingValue;
                }
            });
            
            let output = `${url}`;
            const totalCount = Object.values(groupedByDate).reduce((sum, g) => sum + g.count, 0);
            const totalValue = Object.values(groupedByDate).reduce((sum, g) => sum + g.value, 0);
            
            if (totalCount > 0) {
                output += ` - ${totalCount} contas funcionaram`;
                if (section.value > 0) {
                    output += ` ($${totalValue.toFixed(2)})`;
                }
            }
            output += '\n';
            
            Object.keys(groupedByDate).sort().forEach(date => {
                const group = groupedByDate[date];
                const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
                output += `\n[${dateFormatted}]\n`;
                group.ips.forEach(ip => {
                    output += ip + '\n';
                });
            });
            
            copyToClipboard(output.trim(), event, event.target.closest('button'));
        }

        function copyWorkingIPsByDate(sectionIndex, dateGroupIndex, event) {
            const section = sections[sectionIndex];
            const dateGroup = section.dateGroups[dateGroupIndex];
            const url = section.url || 'Sem URL';
            const date = dateGroup.date1 || 'Sem data';
            const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
            
            const workingIPs = [];
            let workingCount = 0;
            let workingValue = 0;
            
            dateGroup.accounts.forEach(acc => {
                if (acc.checked && acc.ip && acc.ip.trim()) {
                    workingIPs.push(acc.ip.trim());
                    workingCount++;
                    workingValue += section.value;
                }
            });
            
            if (workingIPs.length === 0) {
                // Silenciosamente não fazer nada
                return;
            }
            
            let output = `${url}`;
            if (workingCount > 0) {
                output += ` - ${workingCount} contas funcionaram`;
                if (section.value > 0) {
                    output += ` ($${workingValue.toFixed(2)})`;
                }
            }
            output += `\n\n[${dateFormatted}]\n`;
            workingIPs.forEach(ip => {
                output += ip + '\n';
            });
            
            copyToClipboard(output.trim(), event, event.target.closest('button'));
        }

        function copyPendingIPs(sectionIndex, event) {
            const section = sections[sectionIndex];
            const url = section.url || 'Sem URL';
            
            const groupedByDate = {};
            section.dateGroups.forEach(dateGroup => {
                const date = dateGroup.date1 || 'Sem data';
                const pendingIPs = [];
                let pendingCount = 0;
                
                dateGroup.accounts.forEach(acc => {
                    // Copiar apenas se não está checked E não está failed (status vazio)
                    if (!acc.checked && !acc.failed && acc.ip && acc.ip.trim()) {
                        pendingIPs.push(acc.ip.trim());
                        pendingCount++;
                    }
                });
                
                if (pendingIPs.length > 0) {
                    if (!groupedByDate[date]) {
                        groupedByDate[date] = { ips: [], count: 0 };
                    }
                    groupedByDate[date].ips.push(...pendingIPs);
                    groupedByDate[date].count += pendingCount;
                }
            });
            
            const totalCount = Object.values(groupedByDate).reduce((sum, g) => sum + g.count, 0);
            
            if (totalCount === 0) {
                // Silenciosamente não fazer nada
                return;
            }
            
            let output = `${url} - ${totalCount} IPs pendentes\n`;
            
            Object.keys(groupedByDate).sort().forEach(date => {
                const group = groupedByDate[date];
                const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
                output += `\n[${dateFormatted}]\n`;
                group.ips.forEach(ip => {
                    output += ip + '\n';
                });
            });
            
            copyToClipboard(output.trim(), event, event.target.closest('button'));
        }

        function copyAllIPsForSection(sectionIndex, event) {
            const section = sections[sectionIndex];
            const url = section.url || 'Sem URL';
            
            const groupedByDate = {};
            section.dateGroups.forEach(dateGroup => {
                const date = dateGroup.date1 || 'Sem data';
                const allIPs = [];
                
                dateGroup.accounts.forEach(acc => {
                    if (acc.ip && acc.ip.trim()) {
                        allIPs.push(acc.ip.trim());
                    }
                });
                
                if (allIPs.length > 0) {
                    if (!groupedByDate[date]) {
                        groupedByDate[date] = { ips: [] };
                    }
                    groupedByDate[date].ips.push(...allIPs);
                }
            });
            
            const totalCount = Object.values(groupedByDate).reduce((sum, g) => sum + g.ips.length, 0);
            
            if (totalCount === 0) {
                // Silenciosamente não fazer nada
                return;
            }
            
            let output = `${url} - ${totalCount} IPs\n`;
            
            Object.keys(groupedByDate).sort().forEach(date => {
                const group = groupedByDate[date];
                const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
                output += `\n[${dateFormatted}]\n`;
                group.ips.forEach(ip => {
                    output += ip + '\n';
                });
            });
            
            copyToClipboard(output.trim(), event, event.target.closest('button'));
        }

        function toggleColorPanel(sectionIndex, event) {
            event.stopPropagation();
            const panel = document.getElementById(`section-color-panel-${sectionIndex}`);
            const allPanels = document.querySelectorAll('.section-color-panel');
            
            // Fechar todos os outros painéis
            allPanels.forEach(p => {
                if (p !== panel) {
                    p.classList.remove('active');
                }
            });
            
            if (panel) {
                const wasActive = panel.classList.contains('active');
                panel.classList.toggle('active');
                
                if (!wasActive) {
                    // Posicionar o painel abaixo do botão de cor
                    const button = event.target.closest('.section-color-btn');
                    const buttonRect = button.getBoundingClientRect();
                    const panelRect = panel.getBoundingClientRect();
                    
                    // Calcular posição relativa ao container da seção
                    const sectionDiv = panel.closest('.section');
                    const sectionRect = sectionDiv.getBoundingClientRect();
                    
                    const topPosition = buttonRect.bottom - sectionRect.top;
                    const leftPosition = buttonRect.left - sectionRect.left;
                    
                    panel.style.top = `${topPosition}px`;
                    panel.style.left = `${leftPosition}px`;
                }
            }
        }

        // Fechar painéis de cor ao clicar fora - SOMENTE fora da área
        document.addEventListener('click', (e) => {
            // Não fazer nada se o clique foi dentro de um painel ou no botão de cor
            if (e.target.closest('.section-color-panel') || e.target.closest('.section-color-btn')) {
                return;
            }
            
            // Fechar todos os painéis
            document.querySelectorAll('.section-color-panel').forEach(p => {
                p.classList.remove('active');
            });
        });

        function copyPendingIPsByDate(sectionIndex, dateGroupIndex, event) {
            const section = sections[sectionIndex];
            const dateGroup = section.dateGroups[dateGroupIndex];
            const url = section.url || 'Sem URL';
            const date = dateGroup.date1 || 'Sem data';
            const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
            
            const pendingIPs = [];
            let pendingCount = 0;
            
            dateGroup.accounts.forEach(acc => {
                // Copiar apenas se não está checked E não está failed (status vazio)
                if (!acc.checked && !acc.failed && acc.ip && acc.ip.trim()) {
                    pendingIPs.push(acc.ip.trim());
                    pendingCount++;
                }
            });
            
            if (pendingIPs.length === 0) {
                // Silenciosamente não fazer nada
                return;
            }
            
            let output = `${url} - ${pendingCount} IPs pendentes\n\n[${dateFormatted}]\n`;
            pendingIPs.forEach(ip => {
                output += ip + '\n';
            });
            
            copyToClipboard(output.trim(), event, event.target.closest('button'));
        }


        function copyWorkingIPsByDate(sectionIndex, dateGroupIndex, event) {
            const section = sections[sectionIndex];
            const dateGroup = section.dateGroups[dateGroupIndex];
            const url = section.url || 'Sem URL';
            const date = dateGroup.date1 || 'Sem data';
            const dateFormatted = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR');
            
            const workingIPs = [];
            let workingCount = 0;
            let workingValue = 0;
            
            dateGroup.accounts.forEach(acc => {
                if (acc.checked && acc.ip && acc.ip.trim()) {
                    workingIPs.push(acc.ip.trim());
                    workingCount++;
                    workingValue += section.value;
                }
            });
            
            if (workingIPs.length === 0) {
                // Silenciosamente não fazer nada
                return;
            }
            
            let output = `${url}`;
            if (workingCount > 0) {
                output += ` - ${workingCount} contas funcionaram`;
                if (section.value > 0) {
                    output += ` ($${workingValue.toFixed(2)})`;
                }
            }
            output += `\n\n[${dateFormatted}]\n`;
            workingIPs.forEach(ip => {
                output += ip + '\n';
            });
            
            copyToClipboard(output.trim(), event, event.target.closest('button'));
        }

function copyDateGroupIPs(sectionIndex, dateGroupIndex, event) {
    if (event) event.stopPropagation();
    
    const dateGroup = sections[sectionIndex].dateGroups[dateGroupIndex];
    const ips = new Set();
    
    dateGroup.accounts.forEach(acc => {
        if (acc.ip && acc.ip.trim()) {
            ips.add(acc.ip.trim());
        }
    });
    
    if (ips.size > 0) {
        const text = Array.from(ips).join('\n');
        navigator.clipboard.writeText(text).then(() => {
            const buttonElement = event.target.closest('button');
            if (buttonElement) {
                showCopyFeedback(buttonElement);
            }
        });
    }
}

function copyDateGroupUrl(sectionIndex, event) {
    if (event) event.stopPropagation();
    
    const section = sections[sectionIndex];
    const url = section.url;
    
    navigator.clipboard.writeText(url).then(() => {
        const buttonElement = event.target.closest('button');
        if (buttonElement) {
            showCopyFeedback(buttonElement);
        }
    });
}

function copyDateGroupUrlAndIPs(sectionIndex, dateGroupIndex, event) {
    if (event) event.stopPropagation();
    
    const section = sections[sectionIndex];
    const dateGroup = section.dateGroups[dateGroupIndex];
    let text = section.url;
    
    const ips = new Set();
    dateGroup.accounts.forEach(acc => {
        if (acc.ip && acc.ip.trim()) {
            ips.add(acc.ip.trim());
        }
    });
    
    if (ips.size > 0) {
        text += '\n' + Array.from(ips).join('\n');
    }
    
    navigator.clipboard.writeText(text).then(() => {
        const buttonElement = event.target.closest('button');
        if (buttonElement) {
            showCopyFeedback(buttonElement);
        }
    });
}

        function showCopyFeedback(buttonElement) {
            const originalHTML = buttonElement.innerHTML;
            const copyIcons = buttonElement.querySelectorAll('svg');
            
            // Detectar se está dentro de um field/input
            const isField = buttonElement.closest('.returns-simple-field') || 
                           buttonElement.closest('.returned-today-field') ||
                           buttonElement.closest('.account-field') ||
                           buttonElement.matches('input, textarea');
            
            // Adicionar classe de animação apropriada
            if (isField) {
                buttonElement.classList.add('copy-success-no-scale');
            } else {
                buttonElement.classList.add('copy-success');
            }
            
            // Trocar TODOS os ícones de cópia por ícone de check simplificado
            copyIcons.forEach(svg => {
                const svgSize = window.getComputedStyle(svg).width;
                const checkIcon = document.createElement('div');
                checkIcon.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="stroke: #10a37f; width: ${svgSize}; height: ${svgSize};">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                `;
                svg.replaceWith(checkIcon.firstElementChild);
            });
            
            setTimeout(() => {
                buttonElement.innerHTML = originalHTML;
                buttonElement.classList.remove('copy-success');
                buttonElement.classList.remove('copy-success-no-scale');
            }, 1200);
        }


document.addEventListener('mousedown', (e) => {
    if (isDraggingColor) return;
    
    const colorPicker = e.target.closest('.color-picker');
    const colorPickerContainer = e.target.closest('.color-picker-container');
    const colorPreview = e.target.closest('.color-preview');
    
    if (!colorPicker && !colorPickerContainer && !colorPreview) {
        document.querySelectorAll('.color-picker').forEach(p => p.classList.remove('active'));
    }
});

document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            } else if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                redo();
            } else if (e.key === 'Escape') {
                closeReturnsPanel();
} else if (tabLayout && e.ctrlKey && e.key === 'Tab') {
    e.preventDefault();
    window.isCtrlTabNavigation = true;
    
    // Se a aba ativa está na pasta, navegar apenas entre abas da pasta
    if (folders.includes(activeTabIndex)) {
        if (folders.length === 0) return;
        
        const currentPos = folders.indexOf(activeTabIndex);
        let newPos;
        
        if (e.shiftKey) {
            newPos = currentPos <= 0 ? folders.length - 1 : currentPos - 1;
        } else {
            newPos = currentPos >= folders.length - 1 ? 0 : currentPos + 1;
        }
        
        activeTabIndex = folders[newPos];
        renderSections();
        setTimeout(() => window.isCtrlTabNavigation = false, 100);
    } else {
        // Navegar apenas entre abas visíveis (não arquivadas)
        const visibleTabs = sections.map((s, i) => i).filter(i => !folders.includes(i));
        if (visibleTabs.length === 0) return;
        
        const currentPos = visibleTabs.indexOf(activeTabIndex);
        let newPos;
        
        if (e.shiftKey) {
            newPos = currentPos <= 0 ? visibleTabs.length - 1 : currentPos - 1;
        } else {
            newPos = currentPos >= visibleTabs.length - 1 ? 0 : currentPos + 1;
        }
        
        activeTabIndex = visibleTabs[newPos];
        renderSections();
        setTimeout(() => window.isCtrlTabNavigation = false, 100);
    }
}
        });

        function showCustomConfirm(message, onConfirm) {
            const overlay = document.getElementById('customModalOverlay');
            const modal = document.querySelector('.custom-modal');
            modal.className = 'custom-modal';
            const title = document.getElementById('customModalTitle');
            const messageEl = document.getElementById('customModalMessage');
            const buttons = document.getElementById('customModalButtons');
            
            title.textContent = 'Confirmação';
            messageEl.style.display = 'block';
            messageEl.textContent = message;
            buttons.innerHTML = `
                <button class="custom-modal-btn custom-modal-btn-cancel" onclick="closeCustomModal()">Cancelar</button>
                <button class="custom-modal-btn custom-modal-btn-confirm" id="confirmBtn" onclick="confirmCustomModal()">Confirmar</button>
            `;
            
            overlay.classList.add('active');
            
            setTimeout(() => {
                const confirmBtn = document.getElementById('confirmBtn');
                if (confirmBtn) confirmBtn.focus();
            }, 10);
            
            window.customModalCallback = () => {
                closeCustomModal();
                onConfirm();
            };
        }

function showCustomAlert(message) {
    const overlay = document.getElementById('customModalOverlay');
    const modal = document.querySelector('.custom-modal');
    modal.className = 'custom-modal';
    const title = document.getElementById('customModalTitle');
    const messageEl = document.getElementById('customModalMessage');
    const buttons = document.getElementById('customModalButtons');
    
    title.textContent = 'Aviso';
    messageEl.style.display = 'block';
    messageEl.innerHTML = message.replace(/\n/g, '<br>');
    buttons.innerHTML = `
        <button class="custom-modal-btn custom-modal-btn-ok" id="okBtn" onclick="closeCustomModal()">OK</button>
    `;
    
    overlay.classList.add('active');
    
    setTimeout(() => {
        const okBtn = document.getElementById('okBtn');
        if (okBtn) okBtn.focus();
    }, 10);
}

        function closeCustomModal() {
            const overlay = document.getElementById('customModalOverlay');
            overlay.classList.remove('active');
            window.customModalCallback = null;
        }

        function confirmCustomModal() {
            if (window.customModalCallback) {
                window.customModalCallback();
            }
        }

let isDraggingColor = false;
let currentDragSection = null;

function startColorDrag(sectionIndex, event) {
    event.stopPropagation();
    isDraggingColor = true;
    currentDragSection = sectionIndex;
    updateColorFromSlider(sectionIndex, event);
    
    document.addEventListener('mousemove', handleColorDrag);
    document.addEventListener('mouseup', stopColorDrag);
}

function handleColorDrag(event) {
    if (isDraggingColor && currentDragSection !== null) {
        const slider = document.querySelector(`#color-picker-${currentDragSection} .color-slider`);
        if (slider) {
            const rect = slider.getBoundingClientRect();
            const fakeEvent = {
                clientX: event.clientX,
                currentTarget: slider
            };
            updateColorFromSlider(currentDragSection, fakeEvent);
        }
    }
}

function stopColorDrag() {
    isDraggingColor = false;
    currentDragSection = null;
    document.removeEventListener('mousemove', handleColorDrag);
    document.removeEventListener('mouseup', stopColorDrag);
    saveData();
    renderSections();
}


        // Função para truncar URLs de encurtadores (mostra só a parte final)
        function truncateShortUrl(url) {
            if (!url) return url;
            
            const shorteners = [
                'tinyurl',
                'bit.ly',
                'ow.ly',
                'is.gd',
                't.co',
                'buff.ly',
                'adf.ly',
                'goo.gl',
                'bitly',
                'tiny.cc',
                'short.link',
                'cutt.ly',
                'rebrand.ly',
                'bl.ink'
            ];
            
            const lowerUrl = url.toLowerCase();
            
            // Verificar se contém algum encurtador
            for (const shortener of shorteners) {
                if (lowerUrl.includes(shortener)) {
                    // Se contém o encurtador E tem /, pegar o que vem depois da última /
                    const lastSlashIndex = url.lastIndexOf('/');
                    if (lastSlashIndex !== -1 && lastSlashIndex < url.length - 1) {
                        const afterSlash = url.substring(lastSlashIndex + 1);
                        return afterSlash || url; // Se vazio, retorna URL completa
                    }
                }
            }
            
            return url;
        }

        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            const tabsHeader = document.getElementById('tabsHeader');
            
if (tabLayout) {
                tabsHeader.innerHTML = '';
                
                // Botão de pasta no início
                const folderBtn = document.createElement('button');
                folderBtn.className = 'tab-folder-btn';
                folderBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                `;
folderBtn.onclick = (e) => {
    e.stopPropagation();
    const dropdown = document.getElementById('folderDropdown');
    const isActive = dropdown && dropdown.classList.contains('active');
    
    // Fechar outros dropdowns
    document.querySelectorAll('.folder-dropdown, .save-dropdown').forEach(d => {
        if (d !== dropdown) d.classList.remove('active');
    });
    
    if (dropdown) {
        dropdown.classList.toggle('active');
        if (!isActive) {
            // Atualizar posição usando a função global
            setTimeout(() => window.updateFolderDropdownPosition(), 0);
        }
    }
};


                
                // Dropdown da pasta - remover o antigo se existir
                const oldDropdown = document.getElementById('folderDropdown');
                if (oldDropdown) {
                    oldDropdown.remove();
                }
                
                const folderDropdown = document.createElement('div');
                folderDropdown.id = 'folderDropdown';
                folderDropdown.className = 'folder-dropdown';
                folderDropdown.onclick = (e) => e.stopPropagation();
                // Função para atualizar o conteúdo da pasta
window.updateFolderDropdown = function() {
    const dropdown = document.getElementById('folderDropdown');
    if (!dropdown) return;
    
    dropdown.innerHTML = '';
    
    if (folders.length === 0) {
        dropdown.innerHTML = '<div class="folder-empty">Nenhuma seção arquivada</div>';
    } else {
        folders.forEach(idx => {
            if (!sections[idx]) return;
            const s = sections[idx];
            const url = s.url || 'Sem URL';
            const displayUrl = url.length > 30 ? url.substring(0, 30) + '...' : url;
            
const item = document.createElement('div');
            item.className = 'folder-dropdown-item' + (idx === activeTabIndex ? ' active-section' : '');
if (idx === activeTabIndex) {
                const hex = s.color.replace('#', '');
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                item.style.setProperty('--section-color', s.color);
                item.style.setProperty('--section-color-rgb', `${r}, ${g}, ${b}`);
                console.log(`Folder item ${idx}: color=${s.color}, rgb=(${r}, ${g}, ${b})`);
            }
            item.innerHTML = `
                <div class="folder-item-color" style="background: ${s.color};"></div>
                <div class="folder-item-url" title="${url}">${displayUrl}</div>
                <button class="folder-item-remove" onclick="copyWorkingIPsFormatted(${idx}, event); event.stopPropagation();" title="Copiar IPs que funcionaram" style="color: #10a37f; margin-right: 4px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                    </svg>
                </button>
                <button class="folder-item-remove" onclick="removeFromFolder(${idx}); event.stopPropagation();">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                </button>
            `;
            item.onclick = (e) => {
                if (!e.target.closest('.folder-item-remove')) {
                    activeTabIndex = idx;
                    renderSections();
                    dropdown.classList.remove('active');
                }
            };
            dropdown.appendChild(item);
        });
    }
};

// Configurar isolamento de scroll no folder dropdown
    const setupFolderScrollIsolation = () => {
        const dropdown = document.getElementById('folderDropdown');
        if (!dropdown) return;
        
        dropdown.addEventListener('wheel', (e) => {
            const atTop = dropdown.scrollTop === 0;
            const atBottom = dropdown.scrollTop + dropdown.clientHeight >= dropdown.scrollHeight;
            
            // Prevenir propagação quando no topo ou fundo
            if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                e.preventDefault();
            }
        }, { passive: false });
    };
    
    // Executar após adicionar o dropdown ao DOM
    setTimeout(setupFolderScrollIsolation, 0);

                if (folders.length === 0) {
                    folderDropdown.innerHTML = '<div class="folder-empty">Nenhuma seção arquivada</div>';
                } else {
                    folders.forEach(idx => {
                        if (!sections[idx]) return;
                        const s = sections[idx];
                        const url = s.url || 'Sem URL';
                        const displayUrl = url.length > 30 ? url.substring(0, 30) + '...' : url;
                        
const item = document.createElement('div');
            item.className = 'folder-dropdown-item' + (idx === activeTabIndex ? ' active-section' : '');
if (idx === activeTabIndex) {
                            const hex = s.color.replace('#', '');
                            const r = parseInt(hex.substring(0, 2), 16);
                            const g = parseInt(hex.substring(2, 4), 16);
                            const b = parseInt(hex.substring(4, 6), 16);
                            item.style.setProperty('--section-color', s.color);
                            item.style.setProperty('--section-color-rgb', `${r}, ${g}, ${b}`);
                            console.log(`Folder item ${idx}: color=${s.color}, rgb=(${r}, ${g}, ${b})`);
                        }
                        item.innerHTML = `
                            <div class="folder-item-color" style="background: ${s.color};"></div>
                            <div class="folder-item-url" title="${url}">${displayUrl}</div>
                            <button class="folder-item-remove" onclick="copyWorkingIPsFormatted(${idx}, event); event.stopPropagation();" title="Copiar IPs que funcionaram" style="color: #10a37f; margin-right: 4px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <path d="M9 11l3 3L22 4"></path>
                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                </svg>
                            </button>
                            <button class="folder-item-remove" onclick="removeFromFolder(${idx}); event.stopPropagation();">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                    <polyline points="12 5 19 12 12 19"></polyline>
                                </svg>
                            </button>
                        `;
                        item.onclick = (e) => {
                            if (!e.target.closest('.folder-item-remove')) {
                                activeTabIndex = idx;
                                renderSections();
                                const dropdown = document.getElementById('folderDropdown');
                                if (dropdown) dropdown.classList.remove('active');
                            }
                        };
                        folderDropdown.appendChild(item);
                    });
                }
                
                tabsHeader.appendChild(folderBtn);
                
// Adicionar dropdown ao body e configurar posicionamento
document.body.appendChild(folderDropdown);

// Função para atualizar posição do dropdown
window.updateFolderDropdownPosition = function() {
    const dropdown = document.getElementById('folderDropdown');
    const btn = document.querySelector('.tab-folder-btn');
    if (!dropdown || !btn || !dropdown.classList.contains('active')) return;
    
    const rect = btn.getBoundingClientRect();
    const tabsHeader = document.getElementById('tabsHeader');
    
    // Se a barra está fixa, usar position fixed no dropdown também
    if (tabsHeader && tabsHeader.classList.contains('fixed')) {
        dropdown.style.position = 'fixed';
    } else {
        dropdown.style.position = 'absolute';
    }
    
    dropdown.style.top = `${rect.bottom + 4}px`;
    dropdown.style.left = `${rect.left}px`;
};

folderBtn.addEventListener('click', () => {
    window.updateFolderDropdownPosition();
});

                
// Se a aba ativa está arquivada, mostrar ela PRIMEIRO (logo após o botão de pasta)
                if (folders.includes(activeTabIndex) && sections[activeTabIndex]) {
                    const activeArchivedTab = createTab(sections[activeTabIndex], activeTabIndex, true);
                    tabsHeader.appendChild(activeArchivedTab);
                    
                    // Adicionar separador
                    const spacer = document.createElement('div');
                    spacer.className = 'tab-from-folder-spacer';
                    tabsHeader.appendChild(spacer);
                    
                    
                    // Adicionar classe e variáveis CSS no botão da pasta
                    folderBtn.classList.add('has-active-inside');
                    const activeSection = sections[activeTabIndex];
                    const hex = activeSection.color.replace('#', '');
                    const r = parseInt(hex.substr(0, 2), 16);
                    const g = parseInt(hex.substr(2, 2), 16);
                    const b = parseInt(hex.substr(4, 2), 16);
                    folderBtn.style.setProperty('--active-folder-color', activeSection.color);
                    folderBtn.style.setProperty('--active-folder-glow', `rgba(${r}, ${g}, ${b}, 0.3)`);
                    
                    // Adicionar animação apenas se não for navegação por Ctrl+Tab
                    if (!window.isCtrlTabNavigation) {
                        activeArchivedTab.classList.add('animating');
                        setTimeout(() => activeArchivedTab.classList.remove('animating'), 350);
                    }
                }
                
                // Renderizar abas NÃO arquivadas
                sections.forEach((section, index) => {
                    if (folders.includes(index)) return; // Pula arquivadas
                    if (hideArchived && folders.includes(index)) return;
                    const tab = createTab(section, index);
                    tabsHeader.appendChild(tab);
                });
                
                // Botão de adicionar aba
                const addTab = document.createElement('button');
                addTab.className = 'tab-add';
                addTab.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                `;
                addTab.onclick = addSection;
                tabsHeader.appendChild(addTab);
                
                container.innerHTML = '';
                if (sections[activeTabIndex]) {
                    renderSingleSection(activeTabIndex, container);
                }
            } else {
                container.innerHTML = '';
                sections.forEach((section, sectionIndex) => {
                    // Não renderizar arquivadas no modo lista
                    if (!folders.includes(sectionIndex)) {
                        renderSingleSection(sectionIndex, container);
                    }
                });
            }

            setTimeout(updateTabFade, 0);
            updateSummary();
        }

        function createTab(section, index, isFromFolder = false) {
const tab = document.createElement('div');
            tab.id = `tab-${index}`;
            const baseClass = 'tab' + (index === activeTabIndex ? ' active active-section' : '');
            tab.className = baseClass + (isFromFolder ? ' tab-from-folder' : '');
            tab.style.setProperty('--section-color', section.color);
            
            // Converter hex para RGB
            const hex = section.color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            tab.style.setProperty('--section-color-rgb', `${r}, ${g}, ${b}`);
            tab.draggable = true;
tab.innerHTML = `
${isFromFolder ? '<div class="tab-folder-badge"><svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></div>' : `
<div class="tab-color" onclick="addToFolder(${index}); event.stopPropagation();" style="cursor: pointer;">
    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
    </svg>
</div>
`}
                <div class="tab-title">${truncateShortUrl(section.url) || 'Nova Seção'}</div>
                <div class="tab-close" onclick="${isFromFolder ? `removeFromFolder(${index})` : `deleteSection(${index})`}; event.stopPropagation();">
                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" style="stroke: #ef4444;">
                        ${isFromFolder ? `
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                        ` : `
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                        `}
                    </svg>
                </div>
            `;
            
            tab.addEventListener('dragstart', (e) => {
                draggedTabIndex = index;
                tab.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            tab.addEventListener('dragend', () => {
                tab.classList.remove('dragging');
                draggedTabIndex = null;
                dragOverTabIndex = null;
            });
            
            tab.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (draggedTabIndex !== null && draggedTabIndex !== index) {
                    dragOverTabIndex = index;
                    
                    const temp = sections[draggedTabIndex];
                    sections.splice(draggedTabIndex, 1);
                    sections.splice(index, 0, temp);
                    
                    if (activeTabIndex === draggedTabIndex) {
                        activeTabIndex = index;
                    } else if (activeTabIndex === index) {
                        activeTabIndex = draggedTabIndex > index ? activeTabIndex + 1 : activeTabIndex - 1;
                    }
                    
                    draggedTabIndex = index;
                    renderSections();
                }
            });
            
            tab.addEventListener('drop', (e) => {
                e.preventDefault();
                saveState();
                saveData();
            });
            
            tab.onclick = (e) => {
                if (!e.target.closest('.tab-close') && !e.target.closest('.tab-move')) {
                    switchTab(index);
                }
            };
            
            return tab;
        }

        // Função para converter HSL ou HEX para RGB
        function colorToRGB(color) {
            // Se for HEX
            if (color.startsWith('#')) {
                const hex = color.replace('#', '');
                return {
                    r: parseInt(hex.substr(0, 2), 16),
                    g: parseInt(hex.substr(2, 2), 16),
                    b: parseInt(hex.substr(4, 2), 16)
                };
            }
            
            // Se for HSL
            if (color.startsWith('hsl')) {
                const match = color.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
                if (match) {
                    const h = parseInt(match[1]) / 360;
                    const s = parseInt(match[2]) / 100;
                    const l = parseInt(match[3]) / 100;
                    
                    let r, g, b;
                    if (s === 0) {
                        r = g = b = l;
                    } else {
                        const hue2rgb = (p, q, t) => {
                            if (t < 0) t += 1;
                            if (t > 1) t -= 1;
                            if (t < 1/6) return p + (q - p) * 6 * t;
                            if (t < 1/2) return q;
                            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                            return p;
                        };
                        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                        const p = 2 * l - q;
                        r = hue2rgb(p, q, h + 1/3);
                        g = hue2rgb(p, q, h);
                        b = hue2rgb(p, q, h - 1/3);
                    }
                    return {
                        r: Math.round(r * 255),
                        g: Math.round(g * 255),
                        b: Math.round(b * 255)
                    };
                }
            }
            
            // Fallback
            return { r: 16, g: 163, b: 127 };
        }

        function renderSingleSection(sectionIndex, container) {
            const section = sections[sectionIndex];
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `section-${sectionIndex}`;
            sectionDiv.className = 'section' + (section.collapsed ? ' section-collapsed' : '');
            
            const totalAccounts = section.dateGroups.reduce((sum, dg) => sum + dg.accounts.length, 0);
            const checkedCount = section.dateGroups.reduce((sum, dg) => 
                sum + dg.accounts.filter(acc => acc.checked).length, 0);
            const highlightedCount = section.dateGroups.reduce((sum, dg) => 
                sum + dg.accounts.filter(acc => acc.highlightLevel > 0).length, 0);
            
// Calcular total de todos os tempos para esta seção
let totalAllTime = 0;
section.dateGroups.forEach(dg => {
    const checked = dg.accounts.filter(acc => acc.checked).length;
    totalAllTime += checked * section.value;
});
            
            const allIPs = new Set();
            section.dateGroups.forEach(dg => {
                dg.accounts.forEach(acc => {
                    if (acc.ip && acc.ip.trim()) {
                        allIPs.add(acc.ip.trim());
                    }
                });
            });
            const ipsText = Array.from(allIPs).join(', ');
            
            sectionDiv.innerHTML = `
                <div class="section-header">
                    
                    <div class="field-group" style="flex: 1; max-width: 460px; min-width: 250px;">
                        <label>URL</label>
                        <div class="input-with-copy" style="height: 35px;">
                            <input type="url" value="${section.url}" onchange="updateSection(${sectionIndex}, 'url', this.value)" placeholder="https://exemplo.com" style="height: 100%;">
                            <button class="copy-btn-inline" onclick="copyToClipboard(\`${section.url.replace(/`/g, '\\`')}\`, event, this)" title="Copiar URL">
                                <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div style="width: 16px;"></div>
                    <div class="field-group" style="width: 45px;">
                        <div class="section-color-btn" onclick="toggleColorPanel(${sectionIndex}, event)" style="background: ${section.color};" title="Selecionar cor da seção"></div>
                    </div>
                    
                    <div class="field-group" style="width: 120px; align-items: center;">
                        <label style="white-space: nowrap;">QTD de retornos</label>
                        ${section.returnDays === 0 || section.customReturnsCount === 0
                            ? `<div onclick="activateReturns(${sectionIndex})" style="cursor: pointer; text-align: center; color: #ef4444; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; padding: 8px 0;" title="Clique para ativar retornos">DESATIVADO</div>`
                            : section.customReturnsCount !== undefined && section.customReturnsCount !== null
                            ? `<input type="text" value="${section.customReturnsCount} ${section.customReturnsCount === 1 ? 'retorno' : 'retornos'}" readonly onclick="editSectionReturnsCount(this, ${sectionIndex})" oncontextmenu="event.preventDefault(); deactivateReturns(${sectionIndex}); return false;" style="cursor: pointer; text-align: center;" title="Clique para editar | Botão direito para desativar retornos">`
                            : `<div onclick="editSectionReturnsCount(this, ${sectionIndex})" oncontextmenu="event.preventDefault(); deactivateReturns(${sectionIndex}); return false;" style="cursor: pointer; text-align: center; color: rgba(16, 163, 127, 0.7); font-weight: 600; font-size: 11px; letter-spacing: 0.5px; padding: 8px 0;" title="Clique para customizar | Botão direito para desativar retornos">GLOBAL</div>`
                        }
                    </div>
                    <div class="field-group" style="width: 80px; align-items: center;">
                        <label style="white-space: nowrap;">Retornar após</label>
                        ${section.returnDays === 0 || section.customReturnsCount === 0
                            ? `<div onclick="activateReturns(${sectionIndex})" style="cursor: pointer; text-align: center; color: #ef4444; font-weight: 600; font-size: 11px; letter-spacing: 0.5px; padding: 8px 0;" title="Clique para ativar retornos">DESATIVADO</div>`
                            : `<input type="text" value="${section.returnDays} dias" readonly onclick="editReturnDays(this, ${sectionIndex})" oncontextmenu="event.preventDefault(); deactivateReturns(${sectionIndex}); return false;" style="cursor: pointer; text-align: center;" title="Clique para editar | Botão direito para desativar retornos">`
                        }
                    </div>
                    <div class="field-group" style="width: 48px; align-items: center;">
                        <label>Usos</label>
                        <input type="text" value="${section.number}" onchange="updateSection(${sectionIndex}, 'number', this.value)" placeholder="000">
                    </div>
                    <div class="field-group" style="width: 70px; align-items: center;">
                        <label>$ por conta</label>
                        <input type="number" value="${section.value}" onchange="updateSection(${sectionIndex}, 'value', parseFloat(this.value) || 0)" placeholder="0" step="0.01">
                    </div>
                    
                    <div style="flex: 1;"></div>
                    
                    <div class="copy-buttons-container">
                        <button class="btn-action btn-action-noborder" onclick="copyAllIPsForSection(${sectionIndex}, event)" title="Copiar todos os IPs com URL">
                            Todos IPs
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        <span class="copy-btn-separator">|</span>
                        <button class="btn-action btn-action-noborder" onclick="copyPendingIPs(${sectionIndex}, event)" title="Copiar IPs pendentes">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            IPs pendentes
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                        <span class="copy-btn-separator">|</span>
                        <button class="btn-action btn-action-noborder" onclick="copyWorkingIPsFormatted(${sectionIndex}, event)" title="Copiar IPs confirmados">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            IPs confirmados
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
<div class="section-summary">
    <div class="section-summary-item">
        <span class="section-summary-label">Data de criação</span>
        <span class="section-summary-value">${section.dateGroups[0]?.date1 ? new Date(section.dateGroups[0].date1 + 'T00:00:00').toLocaleDateString('pt-BR') : '-'}</span>
    </div>
</div>
                <div class="section-content">
                    <div class="section-stats">
                        <div class="section-stat-item">
                            <span class="section-stat-label">Contas feitas</span>
                            <span class="section-stat-value">${totalAccounts}</span>
                        </div>
                        <div class="section-stat-item">
                            <span class="section-stat-label">Contas que funcionaram</span>
                            <span class="section-stat-value">${checkedCount}</span>
                        </div>
                        <div class="section-stat-item">
                            <span class="section-stat-label">Contas destacadas</span>
                            <span class="section-stat-value">${highlightedCount}</span>
                        </div>
<div class="section-stat-item">
    <span class="section-stat-label">Total</span>
    <span class="section-stat-value">$${totalAllTime.toFixed(2)}</span>
</div>
                    </div>
                    <div id="section-content-${sectionIndex}"></div>
                    <div class="section-footer">
                        <button class="btn-add-date-group" onclick="addDateGroup(${sectionIndex})">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Adicionar data
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar painel de seleção de cor
            const colorPanel = document.createElement('div');
            colorPanel.className = 'section-color-panel';
            colorPanel.id = `section-color-panel-${sectionIndex}`;
            colorPanel.onclick = (e) => e.stopPropagation();
            colorPanel.innerHTML = `
                <div class="section-color-panel-header">Selecionar cor da seção</div>
                <div class="section-color-panel-content">
                    <div class="color-slider-rainbow" id="color-slider-${sectionIndex}" onclick="updateColorFromSlider(${sectionIndex}, event)" onmousemove="if(event.buttons === 1) updateColorFromSlider(${sectionIndex}, event)">
                        <div class="color-slider-indicator" id="color-indicator-${sectionIndex}"></div>
                    </div>
                </div>
            `;
            sectionDiv.appendChild(colorPanel);
            
            // Inicializar posição do indicador
            setTimeout(() => {
                const huePercent = getHuePercent(section.color);
                const indicator = document.getElementById(`color-indicator-${sectionIndex}`);
                if (indicator) {
                    indicator.style.left = `${huePercent}%`;
                    indicator.style.background = section.color;
                }
            }, 0);
            
            container.appendChild(sectionDiv);
            
            // Definir variáveis CSS DEPOIS de adicionar ao DOM
            const hex = section.color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            sectionDiv.style.setProperty('--section-color', section.color);
            sectionDiv.style.setProperty('--section-color-rgb', `${r}, ${g}, ${b}`);
            
            console.log('=== SECTION SETUP ===');
            console.log('Section index:', sectionIndex);
            console.log('Section color:', section.color);
            console.log('RGB values:', r, g, b);
            
            // Salvar cor da seção para usar nos event listeners
            const sectionColor = section.color;
            
            // EVENT DELEGATION - captura TODOS os inputs da section, mesmo os criados depois
            sectionDiv.addEventListener('focusin', function(e) {
                const target = e.target;
                
                // Verifica se é um input
                if (target.tagName === 'INPUT' && 
                    (target.type === 'text' || target.type === 'url' || target.type === 'number' || 
                     target.type === 'email' || target.type === 'date')) {
                    
                    // Converter cor para RGB (suporta HEX e HSL)
                    const rgb = colorToRGB(sectionColor);
                    
                    console.log('=== INPUT FOCUSED ===');
                    console.log('Input:', target);
                    console.log('Section color:', sectionColor);
                    console.log('RGB:', rgb.r, rgb.g, rgb.b);
                    
                    target.style.setProperty('border-color', `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.4)`, 'important');
                    target.style.setProperty('background', 'rgba(0, 0, 0, 0.35)', 'important');
                    target.style.setProperty('box-shadow', `
                        inset 0 1px 2px rgba(0, 0, 0, 0.3),
                        0 0 0 3px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15),
                        0 0 20px rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)
                    `, 'important');
                    
                    console.log('Applied border:', target.style.borderColor);
                    console.log('Applied shadow:', target.style.boxShadow);
                }
            });
            
            sectionDiv.addEventListener('focusout', function(e) {
                const target = e.target;
                
                if (target.tagName === 'INPUT') {
                    target.style.removeProperty('border-color');
                    target.style.removeProperty('background');
                    target.style.removeProperty('box-shadow');
                }
            });
            
            const contentDiv = document.getElementById(`section-content-${sectionIndex}`);
            section.dateGroups.forEach((dateGroup, dateGroupIndex) => {
                renderDateGroup(sectionIndex, dateGroupIndex, contentDiv);
            });
        }

function getHuePercent(color) {
    // Verificar se é um dos cinzas
    const grays = ['#52525b', '#71717a', '#a1a1aa', '#3f3f46'];
    const grayIndex = grays.indexOf(color);
    if (grayIndex !== -1) {
        return (grayIndex / grays.length) * 15;
    }
    
    // Se for HSL, calcular posição ajustada
    if (color.startsWith('hsl')) {
        const match = color.match(/hsl\((\d+),/);
        if (match) {
            const hue = parseInt(match[1]);
            return 15 + ((hue / 360) * 85);
        }
    }
    
    return 0;
}

        function renderDateGroup(sectionIndex, dateGroupIndex, container) {
            const section = sections[sectionIndex];
            const dateGroup = section.dateGroups[dateGroupIndex];
            
            const dateGroupDiv = document.createElement('div');
            dateGroupDiv.className = 'date-group' + (dateGroup.collapsed ? ' date-group-collapsed' : '');
            
            const accountsSummary = `${dateGroup.accounts.filter(acc => acc.checked).length}/${dateGroup.accounts.length}`;
            
dateGroupDiv.innerHTML = `
    <div class="date-group-header">
        <button class="btn-collapse" onclick="toggleDateGroup(${sectionIndex}, ${dateGroupIndex})">
            ${dateGroup.collapsed ? '▼' : '▲'}
        </button>
        <div class="date-group-dates">
            <div class="field-group">
                <label>Data de criação</label>
                <input type="date" value="${dateGroup.date1 || ''}" 
    onchange="updateDateGroup(${sectionIndex}, ${dateGroupIndex}, 'date1', this.value)">
            </div>
            <div class="field-group">
                <label>Data de retorno sugerida</label>
                <input type="date" class="date-readonly" value="${dateGroup.date2 || ''}" readonly>
            </div>
        </div>
    <div class="date-group-summary">${accountsSummary} contas funcionaram</div>
<div class="date-group-actions">
    <div class="copy-buttons-container">
        <button class="btn-action btn-action-noborder" onclick="copyDateGroupUrl(${sectionIndex}, event)" title="Copiar URL">
            URL
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </button>
        <span class="copy-btn-separator">|</span>
        <button class="btn-action btn-action-noborder" onclick="copyDateGroupUrlAndIPs(${sectionIndex}, ${dateGroupIndex}, event)" title="Copiar URL + todos IPs desta data">
            Todos IPs
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </button>
        <span class="copy-btn-separator">|</span>
        <button class="btn-action btn-action-noborder" onclick="copyPendingIPsByDate(${sectionIndex}, ${dateGroupIndex}, event)" title="Copiar IPs pendentes desta data">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            IPs pendentes
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </button>
        <span class="copy-btn-separator">|</span>
        <button class="btn-action btn-action-noborder" onclick="copyWorkingIPsByDate(${sectionIndex}, ${dateGroupIndex}, event)" title="Copiar IPs confirmados desta data">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            IPs confirmados
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </button>
    </div>
    <button class="btn-icon btn-delete" onclick="deleteDateGroup(${sectionIndex}, ${dateGroupIndex})">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
    </button>
</div>
        
    </div>
    <div class="date-group-content" id="date-group-content-${sectionIndex}-${dateGroupIndex}"></div>
`;
            
            container.appendChild(dateGroupDiv);
            
            const accountsContainer = document.getElementById(`date-group-content-${sectionIndex}-${dateGroupIndex}`);

                if (!dateGroup.collapsed && dateGroup.accounts.length > 0) {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'accounts-header';
                    headerDiv.innerHTML = `
                        <div></div>
                        <div>Email</div>
                        <div>Senha</div>
                        <div>IP</div>
                        <div>Hora</div>
                        <div></div>
                        <div>STATUS</div>
                        <div>Retornos</div>
                        <div></div>
                        <div></div>
                    `;
                    accountsContainer.appendChild(headerDiv);
                }

                dateGroup.accounts.forEach((account, accountIndex) => {
                    renderAccount(sectionIndex, dateGroupIndex, accountIndex, accountsContainer, section.color);
                });

                if (!dateGroup.collapsed) {
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-action';
                addBtn.style.marginTop = '8px';
                addBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Adicionar conta
                `;
                addBtn.onclick = () => addAccount(sectionIndex, dateGroupIndex);
                accountsContainer.appendChild(addBtn);
            }
        }

        function renderAccount(sectionIndex, dateGroupIndex, accountIndex, container, sectionColor) {
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            const section = sections[sectionIndex];
            const isDisabled = account.returns === -1;
            
            const accountDiv = document.createElement('div');
            accountDiv.className = 'account-row' + (account.highlightLevel > 0 ? ' highlight-1' : '');
            
            
            accountDiv.innerHTML = `
                <div class="account-number">${accountIndex + 1}</div>
                <div class="input-with-copy">
                    <input type="email" value="${account.email}" onchange="updateAccount(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}, 'email', this.value)" placeholder="email@exemplo.com">
                    <button class="copy-btn-inline" onclick="copyToClipboard(this.previousElementSibling.value, event, this)" title="Copiar email">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <div class="input-with-copy">
                    <input type="text" value="${account.password}" onchange="updateAccount(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}, 'password', this.value)" placeholder="senha">
                    <button class="copy-btn-inline" onclick="copyToClipboard(this.previousElementSibling.value, event, this)" title="Copiar senha">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <input type="text" value="${account.ip}" onchange="updateAccount(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}, 'ip', this.value)" placeholder="192.168.0.1">
                <input type="text" value="${account.time}" onchange="updateAccount(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}, 'time', this.value)" placeholder="12:00 PM" readonly style="opacity: 0.7;">
                <button class="btn-action" onclick="applyTime(${sectionIndex}, ${dateGroupIndex}, ${accountIndex})">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Aplicar hora
                </button>
                <div class="checkbox-container">
                    <div class="status-checkbox ${account.checked ? 'checked' : ''} ${account.failed ? 'failed' : ''}" 
                         onclick="cycleStatus(${sectionIndex}, ${dateGroupIndex}, ${accountIndex})"></div>
                </div>
                <div class="counter-container">
                    ${section.returnDays === 0 ?
                        `<span class="counter-disabled" style="cursor: default; color: #ef4444;">DESATIVADO</span>` :
                        isDisabled ? 
                        `<span class="counter-disabled" onclick="enableReturns(${sectionIndex}, ${dateGroupIndex}, ${accountIndex})" style="cursor: pointer;">DESATIVADO</span>` :
                        `<button class="btn-counter" onclick="decrementReturns(${sectionIndex}, ${dateGroupIndex}, ${accountIndex})">−</button>
                        <div class="counter-value">${account.returns || 0}</div>
                        <button class="btn-counter" onclick="incrementReturns(${sectionIndex}, ${dateGroupIndex}, ${accountIndex})">+</button>`
                    }
                </div>
                <button class="btn-icon btn-note ${account.note && account.note.trim() ? 'has-note' : ''}" 
                        onclick="toggleNoteEditor(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}, event)" 
                        title="${account.note && account.note.trim() ? 'Ver/editar anotação' : 'Adicionar anotação'}">
                    ${account.note && account.note.trim() ? 
                        `<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>` :
                        `<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                        </svg>`
                    }
                </button>
                <button class="btn-icon btn-delete" onclick="deleteAccount(${sectionIndex}, ${dateGroupIndex}, ${accountIndex})">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            `;
            
            accountDiv.addEventListener('click', (e) => {
                if (!e.target.closest('input') && !e.target.closest('button') && !e.target.closest('.status-checkbox')) {
                    e.preventDefault();
                    if (e.ctrlKey || e.metaKey) {
                        if (account.highlightLevel > 0) {
                            saveState();
                            account.highlightLevel = 0;
                            saveData();
                            renderSections();
                            updateReturnsPanel();
                        }
                    } else if (e.shiftKey) {
                        toggleHighlight(sectionIndex, dateGroupIndex, accountIndex);
                    }
                }
            });
            
            accountDiv.addEventListener('dblclick', (e) => {
                if (!e.target.closest('input') && !e.target.closest('button') && !e.target.closest('.status-checkbox')) {
                    e.preventDefault();
                    toggleHighlight(sectionIndex, dateGroupIndex, accountIndex);
                }
            });
            
            container.appendChild(accountDiv);
        }

        function toggleHighlight(sectionIndex, dateGroupIndex, accountIndex) {
            saveState();
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            account.highlightLevel = account.highlightLevel === 0 ? 1 : 0;
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function cycleStatus(sectionIndex, dateGroupIndex, accountIndex) {
            saveState();
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            
            if (!account.checked && !account.failed) {
                account.checked = true;
                account.failed = false;
            } else if (account.checked && !account.failed) {
                account.checked = false;
                account.failed = true;
            } else {
                account.checked = false;
                account.failed = false;
            }
            
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function incrementReturns(sectionIndex, dateGroupIndex, accountIndex) {
            saveState();
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            account.returns = (account.returns || 0) + 1;
            account.lastReturnDate = getSystemDate();
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function decrementReturns(sectionIndex, dateGroupIndex, accountIndex) {
            saveState();
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            const currentReturns = account.returns || 0;
            
            if (currentReturns === 0) {
                account.returns = -1;
            } else {
                account.returns = Math.max(-1, currentReturns - 1);
            }
            
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function enableReturns(sectionIndex, dateGroupIndex, accountIndex) {
            saveState();
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            account.returns = 0;
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function updateSection(sectionIndex, field, value) {
            saveState();
            sections[sectionIndex][field] = value;
            saveData();
            if (tabLayout) {
                renderSections();
                // Atualizar o dropdown da pasta em tempo real se a URL ou cor foi alterada
                if ((field === 'url' || field === 'color') && typeof window.updateFolderDropdown === 'function') {
                    window.updateFolderDropdown();
                }
            }
        }

        function updateReturnDays(sectionIndex, days) {
            saveState();
            sections[sectionIndex].returnDays = days;
            sections[sectionIndex].dateGroups.forEach(dg => {
                if (dg.date1) {
                    dg.date2 = addDays(dg.date1, days);
                }
            });
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function activateReturns(sectionIndex) {
            saveState();
            sections[sectionIndex].returnDays = 5;
            delete sections[sectionIndex].customReturnsCount; // Volta para GLOBAL
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function deactivateReturns(sectionIndex) {
            saveState();
            sections[sectionIndex].returnDays = 0;
            sections[sectionIndex].customReturnsCount = 0;
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function editReturnDays(element, sectionIndex) {
            const currentValue = sections[sectionIndex].returnDays;
            
            // Criar input para edição
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue;
            input.style.cssText = 'cursor: text; text-align: center;';
            input.className = element.tagName === 'INPUT' ? element.className : '';
            input.title = 'Digite 0 para desativar | ESC para cancelar';
            
            // Substituir o elemento atual pelo input
            element.parentNode.replaceChild(input, element);
            input.focus();
            input.select();
            
            input.onblur = () => {
                const days = parseInt(input.value);
                
                if (days === 0 || isNaN(days) || days < 0) {
                    // Desativar ambos
                    deactivateReturns(sectionIndex);
                } else {
                    // Atualizar apenas returnDays
                    saveState();
                    sections[sectionIndex].returnDays = days;
                    saveData();
                    renderSections();
                    updateReturnsPanel();
                }
            };
            
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    // Cancelar edição
                    renderSections();
                }
            };
        }

        function editSectionReturnsCount(element, sectionIndex) {
            const currentValue = sections[sectionIndex].customReturnsCount;
            
            // Criar input para edição
            const input = document.createElement('input');
            input.type = 'number';
            input.value = currentValue !== undefined && currentValue !== null ? currentValue : hideReturnsAbove;
            input.style.cssText = 'cursor: text; text-align: center;';
            input.className = element.tagName === 'INPUT' ? element.className : '';
            input.title = 'Digite 0 para desativar | ESC para voltar ao GLOBAL';
            
            // Substituir o elemento atual pelo input
            element.parentNode.replaceChild(input, element);
            input.focus();
            input.select();
            
            input.onblur = () => {
                const count = parseInt(input.value);
                saveState();
                
                if (count === 0) {
                    // Desativar ambos
                    sections[sectionIndex].returnDays = 0;
                    sections[sectionIndex].customReturnsCount = 0;
                } else if (isNaN(count) || count < 0 || input.value.trim() === '') {
                    // Voltar para GLOBAL
                    delete sections[sectionIndex].customReturnsCount;
                } else {
                    // Definir valor customizado
                    sections[sectionIndex].customReturnsCount = count;
                }
                
                saveData();
                renderSections();
                updateReturnsPanel();
            };
            
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    // Voltar para GLOBAL ao pressionar ESC
                    saveState();
                    delete sections[sectionIndex].customReturnsCount;
                    saveData();
                    renderSections();
                    updateReturnsPanel();
                }
            };
        }


        function updateDateGroup(sectionIndex, dateGroupIndex, field, value) {
            saveState();
            sections[sectionIndex].dateGroups[dateGroupIndex][field] = value;
            if (field === 'date1' && value) {
                sections[sectionIndex].dateGroups[dateGroupIndex].date2 = addDays(value, sections[sectionIndex].returnDays);
            }
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function updateAccount(sectionIndex, dateGroupIndex, accountIndex, field, value) {
            saveState();
            sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex][field] = value;
            saveData();
        }

        function applyTime(sectionIndex, dateGroupIndex, accountIndex) {
            saveState();
            sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex].time = getCurrentTime();
            saveData();
            renderSections();
        }

        function addSection() {
            saveState();
            sections.push(createNewSection());
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function deleteSection(sectionIndex) {
            showCustomConfirm('Tem certeza que deseja excluir esta seção?', () => {
                saveState();
                sections.splice(sectionIndex, 1);
                if (activeTabIndex >= sections.length) {
                    activeTabIndex = Math.max(0, sections.length - 1);
                }
                saveData();
                renderSections();
                updateReturnsPanel();
            });
        }

        function moveSection(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;
            saveState();
            const temp = sections[fromIndex];
            sections.splice(fromIndex, 1);
            sections.splice(toIndex, 0, temp);
            
            if (activeTabIndex === fromIndex) {
                activeTabIndex = toIndex;
            } else if (fromIndex < activeTabIndex && toIndex >= activeTabIndex) {
                activeTabIndex--;
            } else if (fromIndex > activeTabIndex && toIndex <= activeTabIndex) {
                activeTabIndex++;
            }
            
            saveData();
        }

        function addDateGroup(sectionIndex) {
            saveState();
            const today = getSystemDate();
            const returnDays = sections[sectionIndex].returnDays || 5;

            sections[sectionIndex].dateGroups.push({
                date1: today,
                date2: addDays(today, returnDays),
                collapsed: false,
                accounts: [{
                    email: '',
                    password: '',
                    ip: '',
                    time: '',
                    checked: false,
                    failed: false,
                    returns: 0,
                    highlightLevel: 0,
                    skipReturn: false
                }]
            });

            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function deleteDateGroup(sectionIndex, dateGroupIndex) {
            showCustomConfirm('Tem certeza que deseja excluir este grupo de datas?', () => {
                saveState();
                sections[sectionIndex].dateGroups.splice(dateGroupIndex, 1);
                saveData();
                renderSections();
                updateReturnsPanel();
            });
        }

        function addAccount(sectionIndex, dateGroupIndex) {
            saveState();
            sections[sectionIndex].dateGroups[dateGroupIndex].accounts.push({
                email: '',
                password: '',
                ip: '',
                time: '',
                checked: false,
                failed: false,
                returns: 0,
                highlightLevel: 0,
                skipReturn: false,
                lastReturnDate: null
            });
            saveData();
            renderSections();
            updateReturnsPanel();
        }

        function deleteAccount(sectionIndex, dateGroupIndex, accountIndex) {
            showCustomConfirm('Tem certeza que deseja excluir esta conta?', () => {
                saveState();
                sections[sectionIndex].dateGroups[dateGroupIndex].accounts.splice(accountIndex, 1);
                saveData();
                renderSections();
                updateReturnsPanel();
            });
        }

        // Variáveis globais para o editor de anotações
        let currentNoteEdit = null;
        let saveNoteTimeout = null;

        function toggleNoteEditor(sectionIndex, dateGroupIndex, accountIndex, event) {
            event.stopPropagation();
            
            const popup = document.getElementById('noteEditorPopup');
            const textarea = document.getElementById('noteEditorTextarea');
            const button = event.currentTarget;
            
            // Se já está editando esta conta, fechar
            if (currentNoteEdit && 
                currentNoteEdit.sectionIndex === sectionIndex && 
                currentNoteEdit.dateGroupIndex === dateGroupIndex && 
                currentNoteEdit.accountIndex === accountIndex &&
                popup.classList.contains('active')) {
                closeNoteEditor();
                return;
            }
            
            // Fechar qualquer editor anterior e salvar
            if (popup.classList.contains('active')) {
                saveNoteImmediate();
            }
            
            // Remover destaque da conta anterior
            document.querySelectorAll('.account-row.note-editing').forEach(row => {
                row.classList.remove('note-editing');
            });
            
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            
            // Guardar referência da conta sendo editada
            currentNoteEdit = { sectionIndex, dateGroupIndex, accountIndex };
            
            // Adicionar destaque visual à conta
            const accountRow = button.closest('.account-row');
            if (accountRow) {
                accountRow.classList.add('note-editing');
            }
            
            // Preencher textarea com a anotação existente (preservando quebras de linha)
            textarea.value = account.note || '';
            
            // Posicionar o popup próximo ao botão (usando coordenadas relativas ao documento)
            const rect = button.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const popupWidth = 320;
            
            // Tentar posicionar à esquerda do botão
            let left = rect.left + scrollLeft - popupWidth - 8;
            let top = rect.top + scrollTop;
            
            // Se não couber à esquerda, posicionar à direita
            if (left < 8) {
                left = rect.right + scrollLeft + 8;
            }
            
            // Se não couber à direita, posicionar abaixo
            if (left + popupWidth > window.innerWidth - 8) {
                left = rect.left + scrollLeft;
                top = rect.bottom + scrollTop + 8;
            }
            
            // Garantir que não saia da tela horizontalmente
            left = Math.max(8 + scrollLeft, Math.min(left, window.innerWidth + scrollLeft - popupWidth - 8));
            top = Math.max(8 + scrollTop, top);
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            
            // Mostrar popup
            popup.classList.add('active');
            
            // Ajustar altura inicial do textarea baseado no conteúdo
            setTimeout(() => {
                adjustTextareaHeight();
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }, 50);
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('noteEditorTextarea');
            if (!textarea) return;
            
            textarea.style.height = 'auto';
            const newHeight = Math.max(100, Math.min(320, textarea.scrollHeight + 2));
            textarea.style.height = newHeight + 'px';
        }

        function closeNoteEditor() {
            const popup = document.getElementById('noteEditorPopup');
            
            // Salvar antes de fechar
            if (currentNoteEdit) {
                saveNoteImmediate();
            }
            
            // Remover destaque visual
            document.querySelectorAll('.account-row.note-editing').forEach(row => {
                row.classList.remove('note-editing');
            });
            
            popup.classList.remove('active');
            currentNoteEdit = null;
        }

        function saveNoteImmediate() {
            if (!currentNoteEdit) return;
            
            const { sectionIndex, dateGroupIndex, accountIndex } = currentNoteEdit;
            const textarea = document.getElementById('noteEditorTextarea');
            const account = sections[sectionIndex].dateGroups[dateGroupIndex].accounts[accountIndex];
            
            // Obter conteúdo preservando quebras de linha
            const noteContent = textarea.value.trim();
            
            saveState();
            account.note = noteContent;
            saveData();
            
            // Atualizar o ícone sem re-renderizar tudo
            const noteBtn = document.querySelector(`button[onclick*="toggleNoteEditor(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}"]`);
            if (noteBtn) {
                if (noteContent) {
                    noteBtn.classList.add('has-note');
                    noteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>`;
                    noteBtn.title = 'Ver/editar anotação';
                } else {
                    noteBtn.classList.remove('has-note');
                    noteBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>`;
                    noteBtn.title = 'Adicionar anotação';
                }
            }
        }

        function saveNoteDebounced() {
            clearTimeout(saveNoteTimeout);
            saveNoteTimeout = setTimeout(() => {
                saveNoteImmediate();
            }, 500);
        }

        // Função para reposicionar o popup quando necessário
        function repositionNoteEditor() {
            if (!currentNoteEdit) return;
            
            const popup = document.getElementById('noteEditorPopup');
            if (!popup.classList.contains('active')) return;
            
            const { sectionIndex, dateGroupIndex, accountIndex } = currentNoteEdit;
            const button = document.querySelector(`button[onclick*="toggleNoteEditor(${sectionIndex}, ${dateGroupIndex}, ${accountIndex}"]`);
            
            if (!button) {
                closeNoteEditor();
                return;
            }
            
            const rect = button.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            const popupWidth = 320;
            
            // Tentar posicionar à esquerda do botão
            let left = rect.left + scrollLeft - popupWidth - 8;
            let top = rect.top + scrollTop;
            
            // Se não couber à esquerda, posicionar à direita
            if (left < 8) {
                left = rect.right + scrollLeft + 8;
            }
            
            // Se não couber à direita, posicionar abaixo
            if (left + popupWidth > window.innerWidth - 8) {
                left = rect.left + scrollLeft;
                top = rect.bottom + scrollTop + 8;
            }
            
            // Garantir que não saia da tela horizontalmente
            left = Math.max(8 + scrollLeft, Math.min(left, window.innerWidth + scrollLeft - popupWidth - 8));
            top = Math.max(8 + scrollTop, top);
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
        }

        // Configurar eventos do popup
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('noteEditorTextarea');
            const popup = document.getElementById('noteEditorPopup');
            
            if (textarea) {
                // Salvar ao digitar (debounced)
                textarea.addEventListener('input', () => {
                    adjustTextareaHeight();
                    saveNoteDebounced();
                });
                
                // Fechar ao pressionar Enter (sem Shift)
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                        e.preventDefault();
                        closeNoteEditor();
                    }
                });
            }
            
            // Fechar ao clicar fora
            document.addEventListener('click', (e) => {
                if (popup && popup.classList.contains('active')) {
                    if (!popup.contains(e.target) && !e.target.closest('.btn-note')) {
                        closeNoteEditor();
                    }
                }
            });
            
            // Reposicionar popup ao fazer scroll
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(repositionNoteEditor, 10);
            }, true); // Usar capture para pegar scrolls em elementos internos também
            
            // Reposicionar popup ao redimensionar janela
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(repositionNoteEditor, 10);
            });
        });

        function toggleReturnsPanel() {
            const panel = document.getElementById('returnsPanel');
            const overlay = document.getElementById('returnsOverlay');
            
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                updateReturnsPanel();
                panel.classList.add('active');
                overlay.classList.add('active');
            }
        }

        function closeReturnsPanel() {
            document.getElementById('returnsPanel').classList.remove('active');
            document.getElementById('returnsOverlay').classList.remove('active');
        }

        function daysBetween(date1, date2) {
            if (!date1 || !date2) return 0;
            const d1 = new Date(date1 + 'T00:00:00');
            const d2 = new Date(date2 + 'T00:00:00');
            const diffTime = d2 - d1;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }

        function editFilterValue(input, fieldId) {
            const currentValue = parseInt(input.value) || 999;
            input.type = 'number';
            input.value = currentValue;
            input.readOnly = false;
            input.style.cursor = 'text';
            input.focus();
            input.select();
            
            input.onblur = () => {
                const newValue = parseInt(input.value) || 999;
                input.type = 'text';
                input.value = newValue === 1 ? '1 retorno' : newValue + ' retornos';
                input.readOnly = true;
                input.style.cursor = 'pointer';
                
                if (fieldId === 'hideReturnsAbove') {
                    hideReturnsAbove = newValue;
                } else if (fieldId === 'hideHighlightedAbove') {
                    hideHighlightedAbove = newValue;
                }
                
                saveData();
                updateReturnsPanel();
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
        }
        
        function toggleOverrideUI() {
            const btn = document.getElementById('overrideToggleBtn');
            const config = document.getElementById('overrideConfig');
            
            config.classList.toggle('active');
            btn.classList.toggle('active');
        }
        
        function toggleReturnsSettings() {
            const filters = document.getElementById('returnsFilters');
            filters.classList.toggle('active');
        }
        
        function toggleOverrideEnabled() {
            overrideEnabled = !overrideEnabled;
            const btn = document.getElementById('overrideEnableBtn');
            const text = document.getElementById('overrideEnableText');
            
            if (overrideEnabled) {
                btn.classList.add('active');
                text.textContent = 'Ativado';
            } else {
                btn.classList.remove('active');
                text.textContent = 'Desativado';
            }
            
            saveData();
            updateReturnsPanel();
        }
        
        function editOverrideValue(input, fieldId) {
            const currentValue = parseInt(input.value) || 1;
            input.type = 'number';
            input.value = currentValue;
            input.readOnly = false;
            input.style.cursor = 'text';
            input.focus();
            input.select();
            
            input.onblur = () => {
                const newValue = parseInt(input.value) || 1;
                input.type = 'text';
                
                if (fieldId === 'overrideHowMany') {
                    overrideHowMany = Math.max(1, Math.min(newValue, overrideEveryX));
                    input.value = overrideHowMany === 1 ? '1 conta' : overrideHowMany + ' contas';
                } else if (fieldId === 'overrideEveryX') {
                    overrideEveryX = Math.max(1, newValue);
                    overrideHowMany = Math.min(overrideHowMany, overrideEveryX);
                    input.value = overrideEveryX === 1 ? '1 conta' : overrideEveryX + ' contas';
                    document.getElementById('overrideHowMany').value = overrideHowMany === 1 ? '1 conta' : overrideHowMany + ' contas';
                } else if (fieldId === 'overrideReturnsCount') {
                    overrideReturnsCount = Math.max(1, newValue);
                    input.value = overrideReturnsCount === 1 ? '1 retorno' : overrideReturnsCount + ' retornos';
                }
                
                input.readOnly = true;
                input.style.cursor = 'pointer';
                
                saveData();
                updateReturnsPanel();
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
        }

        function updateReturnsPanel() {
            const today = getSystemDate();
            
            let allWorkingAccounts = [];
            let returnedTodayAccounts = [];
            let accountsNeedingReturn = 0;
            
            const accountsByUrl = {};
            
sections.forEach((section, sectionIndex) => {
    // ADICIONAR: Pular seção se retorno está desativado
    if (section.returnDays === 0 || section.customReturnsCount === 0) return;
    
    const url = section.url || 'Sem URL';
    if (!accountsByUrl[url]) {
        accountsByUrl[url] = [];
    }
    
    section.dateGroups.forEach((dateGroup, dateGroupIndex) => {
        if (!dateGroup.date1) return;
        
        dateGroup.accounts.forEach((account, accountIndex) => {
            if (!account.checked) return;
            if (account.skipReturn) return;
            if (account.returns === -1) return;
                        
                        const daysSinceCreation = daysBetween(dateGroup.date1, today);
                        
                        const accountData = {
                            sectionIndex,
                            dateGroupIndex,
                            accountIndex,
                            section,
                            dateGroup,
                            account,
                            daysSinceCreation,
                            daysRemaining: Math.max(0, 25 - daysSinceCreation),
                            url
                        };
                        
                        accountsByUrl[url].push(accountData);
                    });
                });
            });
            
            // Calcular quais contas têm override
            const overrideAccounts = new Set();
            if (overrideEnabled) {
                Object.keys(accountsByUrl).forEach(url => {
                    const urlAccounts = accountsByUrl[url];
                    
                    // Filtrar contas destacadas (não contam para override)
                    const normalAccounts = urlAccounts.filter(a => a.account.highlightLevel === 0);
                    
                    // Marcar contas para override: X contas a cada Y contas
                    normalAccounts.forEach((acc, index) => {
                        const positionInGroup = (index % overrideEveryX) + 1;
                        const startOverrideAt = overrideEveryX - overrideHowMany + 1;
                        
                        // Se está nas últimas X contas do grupo de Y
                        if (positionInGroup >= startOverrideAt) {
                            overrideAccounts.add(`${acc.sectionIndex}-${acc.dateGroupIndex}-${acc.accountIndex}`);
                        }
                    });
                });
            }
            
            // Aplicar filtros
            Object.values(accountsByUrl).forEach(urlAccounts => {
                urlAccounts.forEach(accountData => {
                    const key = `${accountData.sectionIndex}-${accountData.dateGroupIndex}-${accountData.accountIndex}`;
                    const hasOverride = overrideAccounts.has(key);
                    const isHighlighted = accountData.account.highlightLevel >= 1;
                    
                    let hideAbove;
                    
                    // Para contas destacadas, usar o maior valor entre customReturnsCount e hideHighlightedAbove
                    if (isHighlighted) {
                        if (accountData.section.customReturnsCount !== undefined && accountData.section.customReturnsCount !== null) {
                            hideAbove = Math.max(accountData.section.customReturnsCount, hideHighlightedAbove);
                        } else {
                            hideAbove = hideHighlightedAbove;
                        }
                    } else if (accountData.section.customReturnsCount !== undefined && accountData.section.customReturnsCount !== null) {
                        // Para contas normais, usar customReturnsCount se definido
                        hideAbove = accountData.section.customReturnsCount;
                    } else if (hasOverride) {
                        hideAbove = overrideReturnsCount;
                    } else {
                        hideAbove = hideReturnsAbove;
                    }
                    
                    const returnedToday = accountData.account.lastReturnDate === today;
                    
                    if (returnedToday && accountData.account.returns < hideAbove) {
                        returnedTodayAccounts.push(accountData);
                    }
                    
                    // Se ainda não atingiu o limite, adicionar à lista principal
                    if (accountData.account.returns < hideAbove) {
                        allWorkingAccounts.push(accountData);
                        accountsNeedingReturn++;
                    }
                });
            });
            
            allWorkingAccounts.sort((a, b) => a.daysRemaining - b.daysRemaining);
            
            const titlebarBadge = document.getElementById('titlebarClockBadge');
            if (titlebarBadge) {
                titlebarBadge.textContent = accountsNeedingReturn;
            }
            
            renderSimplifiedReturns(allWorkingAccounts, returnedTodayAccounts, today);
        }

        function renderSimplifiedReturns(allAccounts, returnedTodayAccounts, today) {
            const container = document.getElementById('returnsContent');
            container.innerHTML = '';
            
            // Renderizar seção "Pra amanhã" se houver contas
            if (returnedTodayAccounts.length > 0) {
                const returnedTodaySection = document.createElement('div');
                returnedTodaySection.className = 'returned-today-section';
                
                const returnedTodayHeader = document.createElement('div');
                returnedTodayHeader.className = 'returned-today-header';
                returnedTodayHeader.onclick = () => toggleReturnedTodaySection();
                returnedTodayHeader.innerHTML = `
                    <div class="returned-today-title">
                        <span>Pra amanhã</span>
                        <span class="returned-today-badge">${returnedTodayAccounts.length}</span>
                    </div>
                    <div class="returned-today-toggle">
                        <span>Mostrar</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                `;
                
                const returnedTodayContent = document.createElement('div');
                returnedTodayContent.className = 'returned-today-content collapsed';
                returnedTodayContent.id = 'returnedTodayContent';
                
                returnedTodayAccounts.forEach(item => {
                    const isLastCopied = lastCopiedReturnAccount &&
                        lastCopiedReturnAccount.sectionIndex === item.sectionIndex &&
                        lastCopiedReturnAccount.dateGroupIndex === item.dateGroupIndex &&
                        lastCopiedReturnAccount.accountIndex === item.accountIndex;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'returned-today-item' + 
                        (item.account.highlightLevel > 0 ? ' highlighted' : '') +
                        (isLastCopied ? ' last-interacted' : '');
                    
                    itemDiv.innerHTML = `
                        <div class="returned-today-field" onclick="lastCopiedReturnAccount = {sectionIndex: ${item.sectionIndex}, dateGroupIndex: ${item.dateGroupIndex}, accountIndex: ${item.accountIndex}}; copyToClipboard('${item.account.email}', event, this.querySelector('.returns-copy-icon')); setTimeout(updateReturnsPanel, 1200);" title="Clique para copiar">
                            <div class="returned-today-field-text">${item.account.email || 'Sem email'}</div>
                            <span class="returns-copy-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; stroke: #9ca3af; flex-shrink: 0;">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </span>
                        </div>
                        <div class="returned-today-field" onclick="lastCopiedReturnAccount = {sectionIndex: ${item.sectionIndex}, dateGroupIndex: ${item.dateGroupIndex}, accountIndex: ${item.accountIndex}}; copyToClipboard('${item.account.password}', event, this.querySelector('.returns-copy-icon')); setTimeout(updateReturnsPanel, 1200);" title="Clique para copiar">
                            <div class="returned-today-field-text">${item.account.password || 'Sem senha'}</div>
                            <span class="returns-copy-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; stroke: #9ca3af; flex-shrink: 0;">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </span>
                        </div>
                        <div class="returned-today-controls">
                            ${item.account.returns === -1 ? 
                                `<span class="counter-disabled" onclick="enableReturns(${item.sectionIndex}, ${item.dateGroupIndex}, ${item.accountIndex}); updateReturnsPanel();" style="cursor: pointer;">Desativado</span>` :
                                `<button class="btn-counter" onclick="decrementReturns(${item.sectionIndex}, ${item.dateGroupIndex}, ${item.accountIndex}); updateReturnsPanel();">−</button>
                                <div class="counter-value">${item.account.returns || 0}</div>
                                <button class="btn-counter" onclick="incrementReturns(${item.sectionIndex}, ${item.dateGroupIndex}, ${item.accountIndex}); updateReturnsPanel();">+</button>`
                            }
                        </div>
                    `;
                    
                    returnedTodayContent.appendChild(itemDiv);
                });
                
                returnedTodaySection.appendChild(returnedTodayHeader);
                returnedTodaySection.appendChild(returnedTodayContent);
                container.appendChild(returnedTodaySection);
            }
            
            // Filtrar contas que foram retornadas hoje da lista principal
            const returnedTodayKeys = new Set();
            returnedTodayAccounts.forEach(item => {
                returnedTodayKeys.add(`${item.sectionIndex}-${item.dateGroupIndex}-${item.accountIndex}`);
            });
            
            const filteredAccounts = allAccounts.filter(item => {
                const key = `${item.sectionIndex}-${item.dateGroupIndex}-${item.accountIndex}`;
                return !returnedTodayKeys.has(key);
            });
            
            if (filteredAccounts.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'returns-empty';
                empty.innerHTML = `
                    <div class="returns-empty-text">Nenhuma conta encontrada!</div>
                `;
                container.appendChild(empty);
                return;
            }
            
            const grouped = {};
            filteredAccounts.forEach(item => {
                const url = item.section.url || 'Sem URL';
                const date = item.dateGroup.date1 || 'Sem data';
                const key = `${url}|||${date}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        url,
                        date,
                        accounts: [],
                        color: item.section.color
                    };
                }
                grouped[key].accounts.push(item);
            });
            
            Object.values(grouped).forEach(group => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'returns-simple-section';
sectionDiv.style.setProperty('--section-color', group.color);
                const hex = group.color.replace('#', '');
                const r = parseInt(hex.substr(0, 2), 16);
                const g = parseInt(hex.substr(2, 2), 16);
                const b = parseInt(hex.substr(4, 2), 16);
                sectionDiv.style.setProperty('--section-color-rgb', `${r}, ${g}, ${b}`);
                
                const daysElapsed = daysBetween(group.date, today);
                const daysRemaining = Math.max(0, 25 - daysElapsed);
                
                let daysClass = '';
                if (daysRemaining <= 3) daysClass = 'urgent';
                else if (daysRemaining <= 7) daysClass = 'warning';
                
                // Calcular texto de dias restantes e classe de cor
                let daysText = '';
                let daysTextClass = '';
                if (daysElapsed >= 30) {
                    daysText = 'É tarde demais pra retornar.';
                    daysTextClass = 'critical';
                } else if (daysElapsed >= 25) {
                    daysText = 'Você deve retornar imediatamente.';
                    daysTextClass = 'urgent';
                } else {
                    const accountsCount = group.accounts.length;
                    const accountsWord = accountsCount === 1 ? 'conta' : 'contas';
                    daysText = `Você tem ${daysRemaining} dias pra retornar.`;
                    if (daysRemaining <= 3) daysTextClass = 'urgent';
                    else if (daysRemaining <= 7) daysTextClass = 'warning';
                }
                
                const creationDate = new Date(group.date + 'T00:00:00').toLocaleDateString('pt-BR');
                const accountsCount = group.accounts.length;
                const accountsWord = accountsCount === 1 ? 'conta' : 'contas';
                
                const urlDiv = document.createElement('div');
                urlDiv.className = 'returns-simple-url';
                urlDiv.style.cursor = 'pointer';
                
                // Tornar toda a área clicável para copiar
                urlDiv.onclick = (e) => {
                    // Não ativar se clicar no botão
                    if (!e.target.closest('.returns-copy-icon')) {
                        copyToClipboard(group.url, e, urlDiv.querySelector('.returns-copy-icon'));
                    }
                };
                
                // Determinar classe de cor baseada na urgência
                let dateClass = '';
                if (daysElapsed >= 30) {
                    dateClass = 'critical';
                } else if (daysElapsed >= 25) {
                    dateClass = 'urgent';
                } else if (daysRemaining <= 7) {
                    dateClass = 'warning';
                }
                
                // Determinar cor dos dias restantes
                let daysColor = '#71717a';
                if (daysRemaining <= 2) {
                    daysColor = '#ff3b3b'; // vermelho
                } else if (daysRemaining <= 5) {
                    daysColor = '#f59e0b'; // laranja
                } else if (daysRemaining > 5) {
                    daysColor = '#10a37f'; // verde
                }
                
                urlDiv.innerHTML = `
                <div class="returns-url-info">
                        <div class="returns-url-row">
                            <div class="returns-url-container">
                                <div class="returns-accounts-remaining" style="font-size: 11px; color: #9ca3af; white-space: nowrap;">${accountsCount}: </div>
                                <div class="returns-simple-url-text">${truncateShortUrl(group.url)}</div>
                                <button class="returns-copy-icon" onclick="event.stopPropagation(); copyToClipboard('${group.url}', event, this)">
                                    <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </div>
                            <div style="font-size: 11px; color: #71717a; white-space: nowrap; text-align: center; flex: 1;">${creationDate}</div>
                            <div style="font-size: 10px; color: ${daysColor}; white-space: nowrap; margin-left: auto; background: rgba(255, 255, 255, 0.05); padding: 4px 8px; border-radius: 4px;">${daysText}</div>
                        </div>
                    </div>
                `;
                sectionDiv.appendChild(urlDiv);
                
                group.accounts.forEach(item => {
                    const isLastCopied = lastCopiedReturnAccount &&
                    lastCopiedReturnAccount.sectionIndex === item.sectionIndex &&
                    lastCopiedReturnAccount.dateGroupIndex === item.dateGroupIndex &&
                    lastCopiedReturnAccount.accountIndex === item.accountIndex;
                    const isDisabled = item.account.returns === -1;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'returns-simple-item' + 
                    (item.account.highlightLevel > 0 ? ' highlighted' : '') +
                    (isLastCopied ? ' last-interacted' : '');
itemDiv.style.setProperty('--section-color', group.color);
                    const hex = group.color.replace('#', '');
                    const r = parseInt(hex.substr(0, 2), 16);
                    const g = parseInt(hex.substr(2, 2), 16);
                    const b = parseInt(hex.substr(4, 2), 16);
                    itemDiv.style.setProperty('--section-color-rgb', `${r}, ${g}, ${b}`);
itemDiv.innerHTML = `
    <div class="returns-simple-field" onclick="lastCopiedReturnAccount = {sectionIndex: ${item.sectionIndex}, dateGroupIndex: ${item.dateGroupIndex}, accountIndex: ${item.accountIndex}}; copyToClipboard('${item.account.email}', event, this.querySelector('.returns-copy-icon')); setTimeout(updateReturnsPanel, 1200);" title="Clique para copiar">
        <div class="returns-simple-field-text">${item.account.email || 'Sem email'}</div>
        <span class="returns-copy-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; stroke: #9ca3af; flex-shrink: 0;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </span>
    </div>
    <div class="returns-simple-field" onclick="lastCopiedReturnAccount = {sectionIndex: ${item.sectionIndex}, dateGroupIndex: ${item.dateGroupIndex}, accountIndex: ${item.accountIndex}}; copyToClipboard('${item.account.password}', event, this.querySelector('.returns-copy-icon')); setTimeout(updateReturnsPanel, 1200);" title="Clique para copiar">
        <div class="returns-simple-field-text">${item.account.password || 'Sem senha'}</div>
        <span class="returns-copy-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; stroke: #9ca3af; flex-shrink: 0;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </span>
    </div>
    <div class="returns-simple-controls">
        ${isDisabled ? 
            `<span class="counter-disabled" onclick="enableReturns(${item.sectionIndex}, ${item.dateGroupIndex}, ${item.accountIndex}); updateReturnsPanel();" style="cursor: pointer;">Desativado</span>` :
            `<button class="btn-counter" onclick="decrementReturns(${item.sectionIndex}, ${item.dateGroupIndex}, ${item.accountIndex}); updateReturnsPanel();">−</button>
            <div class="counter-value">${item.account.returns || 0}</div>
            <button class="btn-counter" onclick="incrementReturns(${item.sectionIndex}, ${item.dateGroupIndex}, ${item.accountIndex}); updateReturnsPanel();">+</button>`
        }
    </div>
`;
                    sectionDiv.appendChild(itemDiv);
                });
                
                container.appendChild(sectionDiv);
            });
        }

        function toggleReturnedTodaySection() {
            const header = document.querySelector('.returned-today-header');
            const content = document.getElementById('returnedTodayContent');
            const toggleText = document.querySelector('.returned-today-toggle span');
            
            if (header && content && toggleText) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
                toggleText.textContent = content.classList.contains('collapsed') ? 'Mostrar' : 'Ocultar';
            }
        }

function updateSummary() {
    // Calcular estatísticas
    let totalAccounts = 0;
    let totalOn = 0;
    let totalHighlighted = 0;
    let totalReturned = 0;
    let totalValue = 0;
    
    const today = getSystemDate();
    const startDate = new Date();
    if (currentPeriodDays > 0) {
        startDate.setDate(startDate.getDate() - currentPeriodDays);
    } else if (currentPeriodDays === -1) {
        // Total - não filtrar por data
        startDate.setFullYear(2000);
    }
    
    sections.forEach((section, sectionIndex) => {
        // Se ocultar arquivados está ativo e a seção está arquivada, pular
        if (hideArchived && folders.includes(sectionIndex)) {
            return;
        }
        
        section.dateGroups.forEach(dateGroup => {
            if (!dateGroup.date1) return;
            
            // Filtrar por período se necessário
            if (currentPeriodDays !== -1) {
                const groupDate = new Date(dateGroup.date1 + 'T00:00:00');
                if (groupDate < startDate) return;
            }
            
            dateGroup.accounts.forEach(account => {
                totalAccounts++;
                
                if (account.checked) {
                    totalOn++;
                    totalValue += section.value || 0;
                }
                
                if (account.highlightLevel > 0) {
                    totalHighlighted++;
                }
                
                if (account.returns > 0) {
                    totalReturned++;
                }
            });
        });
    });
    
    // Atualizar titlebar
    document.getElementById('titlebarTotalAccounts').textContent = totalAccounts;
    document.getElementById('titlebarTotalOn').textContent = totalOn;
    document.getElementById('titlebarTotalHighlighted').textContent = totalHighlighted;
    document.getElementById('titlebarTotalReturned').textContent = totalReturned;
    document.getElementById('titlebarTotalValue').textContent = `$${totalValue.toFixed(2)}`;
    
    // Atualizar botão de ignorar arquivados
    const hideBtn = document.getElementById('hideArchivedBtn');
    if (hideBtn) {
        if (folders.length > 0) {
            hideBtn.classList.add('visible');
            hideBtn.classList.toggle('active', hideArchived);
        } else {
            hideBtn.classList.remove('visible');
        }
    }
}

        function updatePeriodSummary() {
            // Verificar se elementos existem
            const periodTotalAccountsEl = document.getElementById('periodTotalAccounts');
            if (!periodTotalAccountsEl) return;
            
            let periodTotalAccounts = 0;
            let periodTotalOn = 0;
            let periodTotalHighlighted = 0;
            let periodTotalReturned = 0;
            let periodTotalValue = 0;
            
            const visibleSections = hideArchived 
                ? sections.filter((_, idx) => !folders.includes(idx))
                : sections;

            if (currentPeriodDays === -1) {
                // Total - todos os tempos
                visibleSections.forEach(section => {
                    section.dateGroups.forEach(dateGroup => {
                        periodTotalAccounts += dateGroup.accounts.length;
                        const checkedCount = dateGroup.accounts.filter(acc => acc.checked).length;
                        const highlightedCount = dateGroup.accounts.filter(acc => acc.highlightLevel > 0).length;
                        const returnedCount = dateGroup.accounts.filter(acc => acc.returns > 0).length;
                        periodTotalOn += checkedCount;
                        periodTotalHighlighted += highlightedCount;
                        periodTotalReturned += returnedCount;
                        periodTotalValue += checkedCount * section.value;
                    });
                });
            } else {
                // Período específico
                const today = new Date();
                const periodAgo = new Date(today.getTime() - currentPeriodDays * 24 * 60 * 60 * 1000);

                visibleSections.forEach(section => {
                    section.dateGroups.forEach(dateGroup => {
                        const date1 = dateGroup.date1 ? new Date(dateGroup.date1 + 'T00:00:00') : null;
                        if (date1 && date1 >= periodAgo) {
                            periodTotalAccounts += dateGroup.accounts.length;
                            const checkedCount = dateGroup.accounts.filter(acc => acc.checked).length;
                            const highlightedCount = dateGroup.accounts.filter(acc => acc.highlightLevel > 0).length;
                            const returnedCount = dateGroup.accounts.filter(acc => acc.returns > 0).length;
                            periodTotalOn += checkedCount;
                            periodTotalHighlighted += highlightedCount;
                            periodTotalReturned += returnedCount;
                            periodTotalValue += checkedCount * section.value;
                        }
                    });
                });
            }

            document.getElementById('periodTotalAccounts').textContent = periodTotalAccounts;
            document.getElementById('periodTotalOn').textContent = periodTotalOn;
            document.getElementById('periodTotalHighlighted').textContent = periodTotalHighlighted;
            document.getElementById('periodTotalReturned').textContent = periodTotalReturned;
            document.getElementById('periodTotalValue').textContent = `$${periodTotalValue.toFixed(0)}`;
            
            // Atualizar também na titlebar
            const titlebarAccounts = document.getElementById('titlebarTotalAccounts');
            const titlebarOn = document.getElementById('titlebarTotalOn');
            const titlebarHighlighted = document.getElementById('titlebarTotalHighlighted');
            const titlebarReturned = document.getElementById('titlebarTotalReturned');
            const titlebarValue = document.getElementById('titlebarTotalValue');
            
            if (titlebarAccounts) titlebarAccounts.textContent = periodTotalAccounts;
            if (titlebarOn) titlebarOn.textContent = periodTotalOn;
            if (titlebarHighlighted) titlebarHighlighted.textContent = periodTotalHighlighted;
            if (titlebarReturned) titlebarReturned.textContent = periodTotalReturned;
            if (titlebarValue) titlebarValue.textContent = `$${periodTotalValue.toFixed(0)}`;
        }

        function togglePeriodDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('periodDropdown');
            dropdown.classList.toggle('active');
            
            if (dropdown.classList.contains('active')) {
                document.addEventListener('click', closePeriodDropdown);
            }
        }

        function closePeriodDropdown() {
            const dropdown = document.getElementById('periodDropdown');
            dropdown.classList.remove('active');
            document.removeEventListener('click', closePeriodDropdown);
        }

function changePeriod(days) {
            currentPeriodDays = days;
            const label = days === -1 ? 'Total' : (days === 1 ? 'último dia' : `últimos ${days} dias`);
            
            // Atualizar botão antigo (se existir)
            const oldBtn = document.getElementById('periodBtn');
            if (oldBtn) {
                oldBtn.innerHTML = `
                    <span style="text-transform: uppercase; letter-spacing: 0.5px;">Exibindo dados de</span>
                    <span class="summary-period-value">${label} ▼</span>
                `;
            }
            
            // Atualizar botão na titlebar
            const titlebarPeriodText = document.getElementById('titlebarPeriodText');
            if (titlebarPeriodText) {
                titlebarPeriodText.textContent = label;
            }
            
            // Atualizar classe active nos itens
            document.querySelectorAll('.period-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.period-item[data-days="${days}"]`);
            if (activeItem) activeItem.classList.add('active');
            
            closePeriodDropdown();
            updateSummary();
            saveData(); // Salvar a preferência
        }

        function toggleHideArchived() {
            hideArchived = !hideArchived;
            const btn = document.getElementById('hideArchivedBtn');
            btn.classList.toggle('active', hideArchived);
            updateSummary();
            updatePeriodSummary();
            if (tabLayout) {
                renderSections();
            }
        }

        function toggleFolderPanel() {
            const panel = document.getElementById('folderPanel');
            panel.classList.toggle('active');
            renderFolderPanel();
        }

        function renderFolderPanel() {
            const content = document.getElementById('folderContent');
            content.innerHTML = '';
            
            if (folders.length === 0) {
                content.innerHTML = '<div class="folder-empty">Nenhuma seção arquivada</div>';
                return;
            }
            
            folders.forEach(sectionIndex => {
                if (!sections[sectionIndex]) return;
                
                const section = sections[sectionIndex];
                const div = document.createElement('div');
                div.className = 'folder-item';
                
                const url = section.url || 'Sem URL';
                const displayUrl = url.length > 30 ? url.substring(0, 30) + '...' : url;
                
                div.innerHTML = `
                    <div class="folder-item-color" style="background: ${section.color};"></div>
                    <div class="folder-item-url" title="${url}">${displayUrl}</div>
                    <button class="folder-item-remove" onclick="removeFromFolder(${sectionIndex})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="3"></circle>
    <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.25M15.54 15.54l4.24 4.25M1 12h6M17 12h6M4.22 19.78l4.24-4.25M15.54 8.46l4.24-4.25"></path>
</svg>
                    </button>
                `;
                
                content.appendChild(div);
            });
        }

        function addToFolder(sectionIndex) {
            showCustomConfirm('Deseja arquivar esta seção?', () => {
                if (!folders.includes(sectionIndex)) {
                    folders.push(sectionIndex);
                    saveState();
                    saveData();
                    renderSections();
                    renderFolderPanel();
                    updateSummary();
                }
            });
        }

function removeFromFolder(sectionIndex) {
    const index = folders.indexOf(sectionIndex);
    if (index > -1) {
        folders.splice(index, 1);
        saveState();
        saveData();
        
        if (tabLayout && activeTabIndex === sectionIndex) {
            const visibleTabs = sections.map((s, i) => i).filter(i => !folders.includes(i));
            activeTabIndex = visibleTabs.length > 0 ? visibleTabs[0] : 0;
        }
        
        renderSections();
        updateSummary();
        
        // Atualizar o dropdown imediatamente
        window.updateFolderDropdown();
    }
}

async function createNewSavePrompt() {
    const overlay = document.getElementById('customModalOverlay');
    const modalTitle = document.getElementById('customModalTitle');
    const modalMessage = document.getElementById('customModalMessage');
    const modalButtons = document.getElementById('customModalButtons');
    
    modalTitle.textContent = 'Criar Novo Save';
    modalMessage.innerHTML = `
        <label for="newSaveNameInput" style="display: block; margin-bottom: 8px; color: #9ca3af; font-size: 12px;">Digite o nome do novo save:</label>
        <input type="text" id="newSaveNameInput" class="custom-modal-input" placeholder="nome-do-save">
    `;
    
    modalButtons.innerHTML = `
        <button class="custom-modal-btn custom-modal-btn-cancel" onclick="closeCustomModal()">Cancelar</button>
        <button class="custom-modal-btn custom-modal-btn-ok" onclick="confirmCreateNewSave()">Criar</button>
    `;
    
    overlay.classList.add('active');
    
    // Focar no input e adicionar listener para Enter
    setTimeout(() => {
        const input = document.getElementById('newSaveNameInput');
        if (input) {
            input.focus();
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmCreateNewSave();
                }
            });
        }
    }, 100);
}

async function confirmCreateNewSave() {
    const input = document.getElementById('newSaveNameInput');
    const saveName = input ? input.value.trim() : '';
    
    if (!saveName) {
        showCustomAlert('Por favor, digite um nome para o save.');
        return;
    }
    
    const fileName = saveName.endsWith('.json') ? saveName : saveName + '.json';
    
    try {
        const result = await window.electronAPI.listSaves();
        if (result.normal && result.normal.includes(fileName)) {
            showCustomAlert('Já existe um save com este nome.');
            return;
        }
        
        const createResult = await window.electronAPI.createSave(fileName);
        if (!createResult.success) {
            showCustomAlert('Erro ao criar arquivo: ' + (createResult.error || 'Desconhecido'));
            return;
        }
        
        const switchResult = await window.electronAPI.switchSave(fileName);
        if (!switchResult.success) {
            showCustomAlert('Erro ao carregar novo save: ' + (switchResult.error || 'Desconhecido'));
            return;
        }
        
        // Carregar os dados do save que foi criado pelo backend
        const loadResult = await window.electronAPI.loadData();
        if (!loadResult.success || !loadResult.data) {
            showCustomAlert('Erro ao carregar dados do novo save');
            return;
        }
        
        // Fechar modal ANTES de atualizar UI
        closeCustomModal();
        
        currentSavePath = switchResult.path;
        sections = loadResult.data.sections;
        folders = loadResult.data.folders;
        tabLayout = loadResult.data.tabLayout !== undefined ? loadResult.data.tabLayout : true;
        hideReturnsAbove = loadResult.data.hideReturnsAbove !== undefined ? loadResult.data.hideReturnsAbove : 1;
        hideHighlightedAbove = loadResult.data.hideHighlightedAbove !== undefined ? loadResult.data.hideHighlightedAbove : 6;
        
        updateAllUI();
        updateSaveUI();
        updateReturnsPanel();
        
        const dropdown = document.getElementById('saveDropdown');
        if (dropdown) dropdown.classList.remove('active');
        
        setTimeout(() => {
            showCustomAlert('Novo save criado com sucesso!');
        }, 100);
    } catch (error) {
        console.error('Erro ao criar save:', error);
        showCustomAlert('Erro: ' + error.message);
    }
}



async function openSavesFolder() {
    await window.electronAPI.openSavesFolder();
}





function updateTabFade() {
    const header = document.getElementById('tabsHeader');
    if (!header) return;

    const fadeStart = header.clientWidth * 0.75;
    const fadeEnd   = header.clientWidth;

    const headerRect = header.getBoundingClientRect();

    header.querySelectorAll('.tab:not(.tab-add)').forEach(tab => {
        const r = tab.getBoundingClientRect();
        const rightInside = r.right - headerRect.left;

        let opacity = 1;

        if (rightInside > fadeStart) {
            const t = (rightInside - fadeStart) / (fadeEnd - fadeStart);
            opacity = Math.max(0, 1 - t/2);
        }

        tab.style.opacity = opacity;
    });
}

window.addEventListener('resize', updateTabFade);

document.getElementById('tabsHeader').addEventListener('scroll', () => {
    requestAnimationFrame(updateTabFade);
});


async function minimizeWindow() {
    await window.electronAPI.windowMinimize();
}

async function toggleMaximize() {
    await window.electronAPI.windowMaximize();
}

async function closeWindow() {
    await window.electronAPI.windowClose();
}


        // Sistema de atualização automática sem cache
        let currentAppDate = null;
        
        function getSystemDate() {
            const now = new Date();
            // Forçar uso de timezone local
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function forceUpdateEverything() {
            const systemDate = getSystemDate();
            
            // Atualizar data exibida SEMPRE
            const dateElement = document.getElementById('returnsPanelDate');
            if (dateElement) {
                const now = new Date();
                const formatted = now.toLocaleDateString('pt-BR', {
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric'
                });
                dateElement.textContent = formatted.charAt(0).toUpperCase() + formatted.slice(1);
            }
            
            // Se mudou o dia, recalcular contas
            if (currentAppDate !== systemDate) {
                currentAppDate = systemDate;
                updateReturnsPanel();
                updateSummary();
            }
        }
        
        // Inicializar
        currentAppDate = getSystemDate();
        
        // Atualizar a cada 500ms (2x por segundo)
        setInterval(forceUpdateEverything, 500);
        
        // Eventos
        window.addEventListener('focus', forceUpdateEverything);
        document.addEventListener('visibilitychange', forceUpdateEverything);
        
        // ==================== UPDATE DEBUG PANEL ====================
        
        let autoUpdateEnabled = true;
        let currentVersion = '1.0.0';
        let availableVersion = null;
        let lastCheckTime = null;
        let updateDownloaded = false;
        let isChecking = false;
        
        function addUpdateLog(message, type = 'info') {
            const log = document.getElementById('updateDebugLog');
            const entry = document.createElement('div');
            entry.className = `update-debug-log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            // Manter apenas últimas 50 entradas
            while (log.children.length > 50) {
                log.removeChild(log.firstChild);
            }
        }
        
        function openUpdateDebugPanel() {
            const overlay = document.getElementById('updateDebugOverlay');
            overlay.classList.add('active');
            loadAppVersion();
            updateDebugDisplay();
            addUpdateLog('Painel de debug aberto', 'info');
        }
        
        async function loadAppVersion() {
            try {
                if (window.electronAPI && window.electronAPI.getAppVersion) {
                    const result = await window.electronAPI.getAppVersion();
                    if (result.success && result.version) {
                        currentVersion = result.version;
                        addUpdateLog(`Versão atual: v${currentVersion}`, 'info');
                    }
                }
            } catch (err) {
                addUpdateLog(`Erro ao carregar versão: ${err.message}`, 'error');
            }
        }
        
        function closeUpdateDebugPanel() {
            const overlay = document.getElementById('updateDebugOverlay');
            overlay.classList.remove('active');
        }
        
        function updateDebugDisplay() {
            // Atualizar versão atual
            document.getElementById('updateDebugCurrentVersion').textContent = currentVersion;
            
            // Atualizar última verificação
            if (lastCheckTime) {
                const time = new Date(lastCheckTime).toLocaleTimeString('pt-BR');
                document.getElementById('updateDebugLastCheck').textContent = time;
            } else {
                document.getElementById('updateDebugLastCheck').textContent = 'Nunca';
            }
            
            // Atualizar versão disponível
            const availableEl = document.getElementById('updateDebugAvailableVersion');
            if (availableVersion) {
                availableEl.textContent = availableVersion;
                availableEl.classList.add('success');
            } else {
                availableEl.textContent = 'Nenhuma';
                availableEl.classList.remove('success', 'error');
            }
            
            // Atualizar status
            const statusEl = document.getElementById('updateDebugStatus');
            if (isChecking) {
                statusEl.textContent = 'Verificando...';
                statusEl.classList.add('loading');
                statusEl.classList.remove('success', 'error');
            } else if (updateDownloaded) {
                statusEl.textContent = 'Pronto para instalar';
                statusEl.classList.add('success');
                statusEl.classList.remove('loading', 'error');
            } else if (availableVersion) {
                statusEl.textContent = 'Atualização disponível';
                statusEl.classList.add('success');
                statusEl.classList.remove('loading', 'error');
            } else {
                statusEl.textContent = 'Atualizado';
                statusEl.classList.remove('loading', 'success', 'error');
            }
            
            // Atualizar toggle
            const toggle = document.getElementById('updateDebugAutoToggle');
            if (autoUpdateEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            // Atualizar botões
            document.getElementById('updateDebugDownloadBtn').disabled = !availableVersion || updateDownloaded;
            document.getElementById('updateDebugInstallBtn').disabled = !updateDownloaded;
        }
        
        function toggleAutoUpdate() {
            autoUpdateEnabled = !autoUpdateEnabled;
            localStorage.setItem('autoUpdateEnabled', autoUpdateEnabled ? 'true' : 'false');
            updateDebugDisplay();
            addUpdateLog(`Atualização automática ${autoUpdateEnabled ? 'ativada' : 'desativada'}`, 'info');
        }
        
        async function checkForUpdatesManual() {
            if (isChecking) {
                addUpdateLog('Verificação já em andamento', 'warning');
                return;
            }
            
            isChecking = true;
            updateDebugDisplay();
            addUpdateLog('Iniciando verificação de atualizações...', 'info');
            
            try {
                const result = await window.electronAPI.checkForUpdates();
                lastCheckTime = Date.now();
                
                if (result.success) {
                    // Atualizar versão atual
                    if (result.currentVersion) {
                        currentVersion = result.currentVersion;
                        addUpdateLog(`Versão atual: v${currentVersion}`, 'info');
                    }
                    
                    // Verificar se há atualização disponível
                    if (result.updateAvailable && result.updateInfo) {
                        availableVersion = result.updateInfo.version;
                        addUpdateLog(`✅ Nova versão encontrada: v${availableVersion}`, 'success');
                        
                        // Mostrar informações da release
                        if (result.updateInfo.releaseDate) {
                            const releaseDate = new Date(result.updateInfo.releaseDate).toLocaleDateString('pt-BR');
                            addUpdateLog(`📅 Lançamento: ${releaseDate}`, 'info');
                        }
                        
                        if (autoUpdateEnabled) {
                            addUpdateLog('⏬ Download automático em andamento...', 'info');
                        }
                    } else {
                        availableVersion = null;
                        addUpdateLog('✓ Você já está na versão mais recente', 'success');
                    }
                } else if (result.devMode) {
                    addUpdateLog('⚠ Modo desenvolvimento - atualizações desabilitadas', 'warning');
                } else {
                    addUpdateLog(`❌ Erro: ${result.error}`, 'error');
                }
            } catch (err) {
                addUpdateLog(`❌ Erro: ${err.message}`, 'error');
            }
            
            isChecking = false;
            updateDebugDisplay();
        }
        
        async function downloadUpdateManual() {
            if (!availableVersion) {
                addUpdateLog('Nenhuma atualização disponível para baixar', 'warning');
                return;
            }
            
            addUpdateLog('Iniciando download...', 'info');
            
            try {
                const result = await window.electronAPI.downloadUpdate();
                if (result.success) {
                    addUpdateLog('Download iniciado com sucesso', 'success');
                } else {
                    addUpdateLog(`Erro ao iniciar download: ${result.error}`, 'error');
                }
            } catch (err) {
                addUpdateLog(`Erro: ${err.message}`, 'error');
            }
        }
        
        async function installUpdate() {
            if (!updateDownloaded) {
                addUpdateLog('Nenhuma atualização baixada para instalar', 'warning');
                return;
            }
            
            addUpdateLog('Instalando atualização e reiniciando...', 'success');
            
            try {
                await window.electronAPI.quitAndInstall();
            } catch (err) {
                addUpdateLog(`Erro ao instalar: ${err.message}`, 'error');
            }
        }
        
        // Listener para eventos de atualização do Electron
        if (window.electronAPI) {
            // Evento: verificando atualizações
            if (window.electronAPI.onUpdateChecking) {
                window.electronAPI.onUpdateChecking(() => {
                    isChecking = true;
                    addUpdateLog('🔍 Verificando atualizações...', 'info');
                    updateDebugDisplay();
                });
            }
            
            // Evento: atualização disponível
            if (window.electronAPI.onUpdateAvailable) {
                window.electronAPI.onUpdateAvailable((info) => {
                    isChecking = false;
                    availableVersion = info.version;
                    currentVersion = info.currentVersion;
                    lastCheckTime = Date.now();
                    
                    addUpdateLog(`🎉 Nova versão disponível: v${info.version}`, 'success');
                    addUpdateLog(`📦 Tamanho: ${formatBytes(info.size)}`, 'info');
                    
                    if (info.releaseDate) {
                        const releaseDate = new Date(info.releaseDate).toLocaleDateString('pt-BR');
                        addUpdateLog(`📅 Lançamento: ${releaseDate}`, 'info');
                    }
                    
                    updateDebugDisplay();
                    
                    // Download automático já está configurado no backend
                    if (autoUpdateEnabled) {
                        addUpdateLog('⏬ Download automático iniciado...', 'info');
                        document.getElementById('updateDebugDownloadSection').style.display = 'block';
                    }
                });
            }
            
            // Evento: nenhuma atualização disponível
            if (window.electronAPI.onUpdateNotAvailable) {
                window.electronAPI.onUpdateNotAvailable((info) => {
                    isChecking = false;
                    availableVersion = null;
                    lastCheckTime = Date.now();
                    addUpdateLog('✓ Você já está na versão mais recente', 'success');
                    updateDebugDisplay();
                });
            }
            
            // Evento: progresso do download
            if (window.electronAPI.onUpdateDownloadProgress) {
                window.electronAPI.onUpdateDownloadProgress((progress) => {
                    const percent = Math.round(progress.percent);
                    const speed = formatBytes(progress.bytesPerSecond) + '/s';
                    
                    document.getElementById('updateDebugProgressBar').style.width = percent + '%';
                    document.getElementById('updateDebugProgressText').textContent = 
                        `${percent}% - ${formatBytes(progress.transferred)} / ${formatBytes(progress.total)} @ ${speed}`;
                    
                    if (percent % 10 === 0 && percent > 0) {  // Log a cada 10%
                        addUpdateLog(`⏬ Download: ${percent}%`, 'info');
                    }
                    
                    document.getElementById('updateDebugDownloadSection').style.display = 'block';
                    updateDebugDisplay();
                });
            }
            
            // Evento: download completo
            if (window.electronAPI.onUpdateDownloaded) {
                window.electronAPI.onUpdateDownloaded((info) => {
                    updateDownloaded = true;
                    addUpdateLog(`✅ Atualização v${info.version} baixada com sucesso!`, 'success');
                    addUpdateLog(`🚀 A atualização será instalada automaticamente no próximo início`, 'info');
                    addUpdateLog(`💡 Feche e reabra o aplicativo para atualizar`, 'info');
                    document.getElementById('updateDebugDownloadSection').style.display = 'none';
                    updateDebugDisplay();
                });
            }
            
            // Evento: erro
            if (window.electronAPI.onUpdateError) {
                window.electronAPI.onUpdateError((error) => {
                    isChecking = false;
                    addUpdateLog(`❌ Erro: ${error.message}`, 'error');
                    updateDebugDisplay();
                });
            }
        }
        
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Carregar preferência de auto-update
        const savedAutoUpdate = localStorage.getItem('autoUpdateEnabled');
        if (savedAutoUpdate !== null) {
            autoUpdateEnabled = savedAutoUpdate === 'true';
        }
        
        // Inicializar sistema de updates
        (async function initUpdateSystem() {
            await loadAppVersion();
            
            // Verificar se o auto-updater está disponível
            if (window.electronAPI && window.electronAPI.checkForUpdates) {
                addUpdateLog('Sistema de auto-update disponível', 'success');
                if (autoUpdateEnabled) {
                    addUpdateLog('Auto-update está ATIVADO', 'info');
                } else {
                    addUpdateLog('Auto-update está DESATIVADO', 'warning');
                }
            } else {
                addUpdateLog('Auto-update não está disponível (modo desenvolvimento)', 'warning');
            }
        })();
        
        // F5 para abrir painel de updates
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F5') {
                e.preventDefault();
                openUpdateDebugPanel();
            }
            
            // ESC para fechar o painel se estiver aberto
            if (e.key === 'Escape') {
                const overlay = document.getElementById('updateDebugOverlay');
                if (overlay.classList.contains('active')) {
                    closeUpdateDebugPanel();
                }
            }
        });
        
        // F6 para debug de data
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F6') {
                e.preventDefault();
                const testDate = new Date();
                const manualDate = getSystemDate();
                alert('Data calculada: ' + manualDate + '\nData ISO: ' + testDate.toISOString().split('T')[0] + '\nData completa: ' + testDate.toString());
                forceUpdateEverything();
            }
        });
        
        // ==================== FIM DO UPDATE DEBUG PANEL ====================

        initializeApp();
    </script>
    <div class="note-editor-popup" id="noteEditorPopup">
        <textarea class="note-editor-textarea" id="noteEditorTextarea" placeholder="Digite sua anotação..."></textarea>
    </div>

    <div class="custom-modal-overlay" id="customModalOverlay" onclick="closeCustomModal()">
        <div class="custom-modal" onclick="event.stopPropagation()">
            <div class="custom-modal-title" id="customModalTitle">Confirmar</div>
            <div class="custom-modal-message" id="customModalMessage">Tem certeza?</div>
            <div class="custom-modal-buttons" id="customModalButtons"></div>
        </div>
    </div>

    <!-- Update Debug Panel -->
    <div class="update-debug-overlay" id="updateDebugOverlay" onclick="closeUpdateDebugPanel()">
        <div class="update-debug-panel" onclick="event.stopPropagation()">
            <div class="update-debug-header">
                <div class="update-debug-title">
                    <span>🔄</span>
                    <span>Debug de Atualizações</span>
                </div>
                <div class="update-debug-close" onclick="closeUpdateDebugPanel()">×</div>
            </div>

            <!-- Versões -->
            <div class="update-debug-section">
                <div class="update-debug-section-title">Informações de Versão</div>
                <div class="update-debug-info-grid">
                    <div class="update-debug-info-item">
                        <div class="update-debug-info-label">Versão Atual</div>
                        <div class="update-debug-info-value" id="updateDebugCurrentVersion">-</div>
                    </div>
                    <div class="update-debug-info-item">
                        <div class="update-debug-info-label">Última Verificação</div>
                        <div class="update-debug-info-value" id="updateDebugLastCheck">-</div>
                    </div>
                    <div class="update-debug-info-item">
                        <div class="update-debug-info-label">Versão Disponível</div>
                        <div class="update-debug-info-value" id="updateDebugAvailableVersion">-</div>
                    </div>
                    <div class="update-debug-info-item">
                        <div class="update-debug-info-label">Status</div>
                        <div class="update-debug-info-value" id="updateDebugStatus">-</div>
                    </div>
                </div>
            </div>

            <!-- Status do Download -->
            <div class="update-debug-section" id="updateDebugDownloadSection" style="display: none;">
                <div class="update-debug-section-title">Download em Progresso</div>
                <div class="update-debug-status">
                    <div class="update-debug-status-text" id="updateDebugDownloadText">Baixando atualização...</div>
                    <div class="update-debug-progress">
                        <div class="update-debug-progress-bar" id="updateDebugProgressBar"></div>
                    </div>
                    <div class="update-debug-progress-text" id="updateDebugProgressText">0%</div>
                </div>
            </div>

            <!-- Configurações -->
            <div class="update-debug-section">
                <div class="update-debug-section-title">Configurações</div>
                <div class="update-debug-toggle">
                    <div class="update-debug-toggle-label">Atualização Automática</div>
                    <div class="update-debug-toggle-switch active" id="updateDebugAutoToggle" onclick="toggleAutoUpdate()">
                        <div class="update-debug-toggle-slider"></div>
                    </div>
                </div>
            </div>

            <!-- Ações -->
            <div class="update-debug-section">
                <div class="update-debug-section-title">Ações</div>
                <div class="update-debug-buttons">
                    <button class="update-debug-btn update-debug-btn-primary" onclick="checkForUpdatesManual()">
                        <span>🔍</span>
                        <span>Verificar Atualizações</span>
                    </button>
                    <button class="update-debug-btn update-debug-btn-secondary" id="updateDebugDownloadBtn" onclick="downloadUpdateManual()" disabled>
                        <span>⬇️</span>
                        <span>Baixar Atualização</span>
                    </button>
                    <button class="update-debug-btn update-debug-btn-danger" id="updateDebugInstallBtn" onclick="installUpdate()" disabled>
                        <span>🚀</span>
                        <span>Instalar e Reiniciar</span>
                    </button>
                </div>
            </div>

            <!-- Log -->
            <div class="update-debug-section">
                <div class="update-debug-section-title">Log de Eventos</div>
                <div class="update-debug-log" id="updateDebugLog">
                    <div class="update-debug-log-entry info">Sistema de atualização inicializado</div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>